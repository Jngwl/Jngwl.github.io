

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="清风与归_G">
  <meta name="keywords" content="">
  <title>Faster RCNN代码解析 - 清风与归_G</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      
        
          
          
          
        
        <link  rel="stylesheet" href="https://cdn.staticfile.org/prism/1.22.0/themes/prism-tomorrow.min.css" />
      
      
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.jngwl.top","root":"/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ViwB1XmjsmmXpFx2gikUmM5V-gzGzoHsz","app_key":"7r6Y8CzBkl8MJwPNmCqSdLWW","server_url":"https://viwb1xmj.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>清风与归_G</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20201121211851.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Faster RCNN代码解析">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-05-04 10:36" pubdate>
        2020年5月4日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      12.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      167
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Faster RCNN代码解析</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年1月8日 晚上
                
              </p>
            
            <div class="markdown-body">
              <blockquote>
<p>本文转载自<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/jhsXSr8xX8YvBK4jIpgX-g">GiantPandaCV</a>，感谢整理分享。</p>
</blockquote>
<h2 id="📖-Faster-RCNN整体结构"><a href="#📖-Faster-RCNN整体结构" class="headerlink" title="📖 Faster RCNN整体结构"></a>📖 Faster RCNN整体结构</h2><p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200504133455.png" srcset="/img/loading.gif" alt="Faster RCNN 整体结构"></p>
<p>Faster RCNN大概可以分成绿色描述的个部分，即：</p>
<ul>
<li><code>DataSet</code>：代表数据集，典型的比如VOC和COCO。</li>
<li><code>Extrator</code>：特征提取器，也即是我们常说的Backbone网络，典型的有VGG和ResNet。</li>
<li><code>RPN</code>：全称Region Proposal Network，负责产生候选区域(<code>rois</code>)，每张图大概给出2000个候选框。</li>
<li><code>RoIHead</code>：负责对<code>rois</code>进行分类和回归微调。</li>
</ul>
<p>所以Faster RCNN的流程可以总结为：</p>
<p><strong>原始图像</strong>—-&gt;<strong>特征提取</strong>———&gt;<strong>RPN产生候选框</strong>———&gt;<strong>对候选框进行分类和回归微调</strong>。</p>
<h2 id="🔎-Faster-RCNN的四个模块"><a href="#🔎-Faster-RCNN的四个模块" class="headerlink" title="🔎 Faster RCNN的四个模块"></a>🔎 Faster RCNN的四个模块</h2><p>Faster R-CNN是目标检测中较早提出来的两阶段网络，其网络架构如下图所示：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505143105.png" srcset="/img/loading.gif" alt="Faster RCNN"></p>
<p>可以看出可以大体分为四个部分：</p>
<ol>
<li><code>Conv Layers</code> 卷积神经网络用于提取特征，得到feature map。</li>
<li><code>RPN</code>网络，用于提取Region of Interests(RoI)。</li>
<li><code>RoI pooling</code>, 用于综合RoI和feature map, 得到固定大小的resize后的feature。</li>
<li><code>classifier</code>, 用于分类RoI属于哪个类别。</li>
</ol>
<h3 id="1-Conv-Layers"><a href="#1-Conv-Layers" class="headerlink" title="1. Conv Layers"></a>1. Conv Layers</h3><p>在Conv Layers中，对输入的图片进行卷积和池化，用于提取图片特征，最终希望得到的是feature map。在Faster R-CNN中，先将图片Resize到固定尺寸，然后使用了VGG16中的13个卷积层、13个ReLU层、4个manpooling层。（VGG16中进行了5次下采样，这里舍弃了第四次下采样后的部分，将剩下部分作为Conv Layer提取特征。）</p>
<p>与YOLOv3不同，Faster R-CNN下采样后的分辨率为原始图片分辨率的1/16（YOLOv3是变为原来的1/32）。feature map的分辨率要比YOLOv3的Backbone得到的分辨率要大，这也可以解释为何Faster R-CNN在小目标上的检测效果要优于YOLOv3。</p>
<h3 id="2-Region-Proposal-Network"><a href="#2-Region-Proposal-Network" class="headerlink" title="2. Region Proposal Network"></a>2. Region Proposal Network</h3><p>简称RPN网络，用于推荐候选区域（Region of Interests），接受的输入为原图片经过Conv Layer后得到的feature map。</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505185813.jpg" srcset="/img/loading.gif" alt="RPN"></p>
<p>上图参考的实现是：<a target="_blank" rel="noopener" href="https://github.com/ruotianluo/pytorch-faster-rcnn">https://github.com/ruotianluo/pytorch-faster-rcnn</a></p>
<p>RPN网络将feature map作为输入，然后用了一个3x3卷积将filter减半为512,然后进入两个分支：</p>
<p>一个分支用于计算对应anchor的foreground和background的概率，目标是foreground。</p>
<p>一个分支用于计算对应anchor的Bounding box的偏移量，来获得其目标的定位。</p>
<p>通过RPN网络，我们就得到了每个anchor是否含有目标和在含有目标情况下目标的位置信息。</p>
<p><strong>对比RPN和YOLOv3:</strong></p>
<p><strong>RPN:</strong> 分两个分支，一个分支预测目标框，一个分支预测前景或者背景。将两个工作分开来做的，并且其中前景背景预测分支功能是判断这个anchor是否含有目标，并不会对目标进行分类。另外就是anchor的设置是通过先验得到的。</p>
<p><strong>YOLOv3</strong>: 将整个问题当做回归问题，直接就可以获取目标类别和坐标。Anchor是通过IoU聚类得到的。</p>
<p><strong>区别</strong>：Anchor的设置，Ground truth和Anchor的匹配细节不一样。</p>
<p><strong>联系</strong>：两个都是在最后的feature map（w/16,h/16或者w/32，h/32）上每个点都分配了多个anchor，然后进行匹配。虽然具体实现有较大的差距，但是这个想法有共同点。</p>
<h3 id="3-ROI-Pooling"><a href="#3-ROI-Pooling" class="headerlink" title="3. ROI Pooling"></a>3. ROI Pooling</h3><p>这里看一个来自deepsense.ai提供的例子：</p>
<p>RoI Pooling输入是feature map和RoIs：</p>
<p>假设feature map是如下内容：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505185929.jpg" srcset="/img/loading.gif" alt="feature map"></p>
<p>RPN提供的其中一个RoI为：左上角坐标（0,3)，右下角坐标（7,8）</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190009.jpg" srcset="/img/loading.gif" alt="roi"></p>
<p>然后将RoI对应到feature map上的部分切割为2x2大小的块：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190042.jpg" srcset="/img/loading.gif" alt="分块"></p>
<p>将每个块做类似max pooling的操作，得到以下结果：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190101.png" srcset="/img/loading.gif" alt="max pooling"></p>
<p>以上就是ROI pooling的完整操作，想一想<strong>为何要这样做</strong>？</p>
<ul>
<li>保证无论输入特征图尺寸如何，输入到后续全连接层的特征图尺寸固定，避免因图像裁剪等造成像素缺失。</li>
<li>输入特征图尺寸为M×N，ROI池化层先将其映射为M/16×N/16，结合ROI获得原始特征图的区域建议坐标，然后将该区域分块，分别进行max pooling，得到最终的区域建议</li>
</ul>
<p>在RPN阶段，我们得知了当前图片是否有目标，在有目标情况下目标的位置。现在唯一缺少的信息就是这个目标到底属于哪个类别（通过RPN只能得知这个目标属于前景，但并不能得到具体类别）。</p>
<p>如果想要得知这个目标属于哪个类别，最简单的想法就是将得到的框内的图片放入一个CNN进行分类，得到最终类别。这就涉及到最后一个模块：classification</p>
<h3 id="4-Classification"><a href="#4-Classification" class="headerlink" title="4. Classification"></a>4. Classification</h3><p>ROI Pooling后得到的是大小一致的feature map，然后分为两个分支，靠下的一个分支去进行分类，上一个分支是用于Bounding box回归。如下图所示（来自知乎）：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190124.jpg" srcset="/img/loading.gif" alt="分类"></p>
<p>分类这个分支很容易理解，用于计算到底属于哪个类别。Bounding box回归的分支用于调整RPN预测得到的Bounding box，让回归的结果更加精确。</p>
<h2 id="⛳-数据预处理及实现细节"><a href="#⛳-数据预处理及实现细节" class="headerlink" title="⛳ 数据预处理及实现细节"></a>⛳ 数据预处理及实现细节</h2><p>首先让我们进入到这个Pytorch的Faster RCNN工程：<code>https://github.com/chenyuntc/simple-faster-rcnn-pytorch</code>。数据预处理的相关细节都在<code>data</code>这个文件夹下面，实现流程图如下：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200504111632.png" srcset="/img/loading.gif" alt="Faster RCNN预处理流程图，made by BBuf"></p>
<h3 id="data-dataset-py"><a href="#data-dataset-py" class="headerlink" title="data/dataset.py"></a>data/dataset.py</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 去正则化,img维度为[[B,G,R],H,W],因为caffe预训练模型输入为BGR 0-255图片，pytorch预训练模型采用RGB 0-1图片</span>
<span class="token keyword">def</span> <span class="token function">inverse_normalize</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>caffe_pretrain<span class="token punctuation">:</span>
        <span class="token comment"># [122.7717, 115.9465, 102.9801]reshape为[3,1,1]与img维度相同就可以相加了，</span>
        <span class="token comment"># pytorch_normalize之前有减均值预处理，现在还原回去。</span>
        img <span class="token operator">=</span> img <span class="token operator">+</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">122.7717</span><span class="token punctuation">,</span> <span class="token number">115.9465</span><span class="token punctuation">,</span> <span class="token number">102.9801</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 将BGR转换为RGB图片（python [::-1]为逆序输出）</span>
        <span class="token keyword">return</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token comment"># pytorch_normalze中标准化为 减均值除以标准差，现在乘以标准差加上均值还原回去，转换为0-255</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>img <span class="token operator">*</span> <span class="token number">0.225</span> <span class="token operator">+</span> <span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span>

<span class="token comment"># 采用pytorch预训练模型对图片预处理(归一化)，函数输入的img为 0~1</span>
<span class="token comment"># 函数输出为 -1~1，RGB，减去均值再除以标准差</span>
<span class="token keyword">def</span> <span class="token function">pytorch_normalze</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    https://github.com/pytorch/vision/issues/223
    return appr -1~1 RGB
    """</span>
    <span class="token comment"># #transforms.Normalize使用如下公式进行归一化</span>
    <span class="token comment"># channel=（channel-mean）/std,转换为[-1,1]</span>
    normalize <span class="token operator">=</span> tvtsf<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># nddarry->Tensor</span>
    img <span class="token operator">=</span> normalize<span class="token punctuation">(</span>t<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> img<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 采用caffe预训练模型时对输入图像进行标准化，函数输入的img为 0~1</span>
<span class="token comment"># 函数输出为 -125~125，BGR，只减了均值，未除标准差</span>
<span class="token keyword">def</span> <span class="token function">caffe_normalize</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    return appr -125-125 BGR
    """</span>
    <span class="token comment"># RGB-BGR</span>
    img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># RGB-BGR</span>
    img <span class="token operator">=</span> img <span class="token operator">*</span> <span class="token number">255</span>
    <span class="token comment"># 转换为与img维度相同</span>
    mean <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">122.7717</span><span class="token punctuation">,</span> <span class="token number">115.9465</span><span class="token punctuation">,</span> <span class="token number">102.9801</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 减均值操作</span>
    img <span class="token operator">=</span> <span class="token punctuation">(</span>img <span class="token operator">-</span> mean<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> copy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> img

<span class="token comment"># 函数输入的img为0-255</span>
<span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> min_size<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 图片进行缩放，使得长边小于等于1000，短边小于等于600（至少有一个等于）。</span>
    <span class="token comment"># 对相应的bounding boxes 也也进行同等尺度的缩放。</span>
    C<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
    scale1 <span class="token operator">=</span> min_size <span class="token operator">/</span> <span class="token builtin">min</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">)</span>
    scale2 <span class="token operator">=</span> max_size <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">)</span>
    <span class="token comment"># 选小的比例，这样长和宽都能放缩到规定的尺寸</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>scale1<span class="token punctuation">,</span> scale2<span class="token punctuation">)</span>
    img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">.</span>
    <span class="token comment"># resize到（H * scale, W * scale）大小，anti_aliasing为是否采用高斯滤波</span>
    img <span class="token operator">=</span> sktsf<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> H <span class="token operator">*</span> scale<span class="token punctuation">,</span> W <span class="token operator">*</span> scale<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'reflect'</span><span class="token punctuation">,</span>anti_aliasing<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment">#调用pytorch_normalze或者caffe_normalze对图像进行正则化，输入为0~1</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>caffe_pretrain<span class="token punctuation">:</span>
        normalize <span class="token operator">=</span> caffe_normalize
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        normalize <span class="token operator">=</span> pytorch_normalze
    <span class="token keyword">return</span> normalize<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

<span class="token comment"># 对原图和bbox进行缩放、随机翻转</span>
<span class="token keyword">class</span> <span class="token class-name">Transform</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> min_size<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>min_size <span class="token operator">=</span> min_size
        self<span class="token punctuation">.</span>max_size <span class="token operator">=</span> max_size

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label <span class="token operator">=</span> in_data
        _<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
        <span class="token comment"># 调用前面定义的preprocess函数进行图像等比例缩放</span>
        img <span class="token operator">=</span> preprocess<span class="token punctuation">(</span>img<span class="token punctuation">,</span> self<span class="token punctuation">.</span>min_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> o_H<span class="token punctuation">,</span> o_W <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
        <span class="token comment"># 得出缩放比因子</span>
        scale <span class="token operator">=</span> o_H <span class="token operator">/</span> H
        <span class="token comment"># bbox按照与原图等比例缩放</span>
        bbox <span class="token operator">=</span> util<span class="token punctuation">.</span>resize_bbox<span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> <span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>o_H<span class="token punctuation">,</span> o_W<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 将图片进行随机水平翻转，没有进行垂直翻转</span>
        img<span class="token punctuation">,</span> params <span class="token operator">=</span> util<span class="token punctuation">.</span>random_flip<span class="token punctuation">(</span>
            img<span class="token punctuation">,</span> x_random<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> return_param<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># 同样地将bbox进行与对应图片同样的水平翻转</span>
        bbox <span class="token operator">=</span> util<span class="token punctuation">.</span>flip_bbox<span class="token punctuation">(</span>
            bbox<span class="token punctuation">,</span> <span class="token punctuation">(</span>o_H<span class="token punctuation">,</span> o_W<span class="token punctuation">)</span><span class="token punctuation">,</span> x_flip<span class="token operator">=</span>params<span class="token punctuation">[</span><span class="token string">'x_flip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> scale

<span class="token comment"># 训练集样本的生成</span>
<span class="token keyword">class</span> <span class="token class-name">Dataset</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>opt <span class="token operator">=</span> opt
         <span class="token comment"># 实例化 VOCBboxDataset 类</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> VOCBboxDataset<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>voc_data_dir<span class="token punctuation">)</span>
        <span class="token comment"># 实例化 Transform 类</span>
        self<span class="token punctuation">.</span>tsf <span class="token operator">=</span> Transform<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>min_size<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span>
        
    <span class="token comment"># __ xxx__运行Dataset类时自动运行</span>
    
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 调用VOCBboxDataset中的get_example()从数据集存储路径中将img, bbox, label, difficult 一个个的获取出来</span>
        ori_img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_example<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        <span class="token comment"># 调用前面的Transform函数将图片,label进行最小值最大值放缩归一化，</span>
        <span class="token comment"># 重新调整bboxes的大小，然后随机反转，最后将数据集返回</span>
        img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> scale <span class="token operator">=</span> self<span class="token punctuation">.</span>tsf<span class="token punctuation">(</span><span class="token punctuation">(</span>ori_img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># TODO: check whose stride is negative to fix this instead copy all</span>
        <span class="token comment"># some of the strides of a given numpy array are negative.</span>
        <span class="token keyword">return</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bbox<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> label<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scale

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">)</span>

<span class="token comment"># 测试集样本的生成</span>
<span class="token keyword">class</span> <span class="token class-name">TestDataset</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span> use_difficult<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>opt <span class="token operator">=</span> opt
        <span class="token comment"># 此处设置了use_difficult,</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> VOCBboxDataset<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>voc_data_dir<span class="token punctuation">,</span> split<span class="token operator">=</span>split<span class="token punctuation">,</span> use_difficult<span class="token operator">=</span>use_difficult<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ori_img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_example<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        <span class="token comment"># 对原图进行缩放</span>
        img <span class="token operator">=</span> preprocess<span class="token punctuation">(</span>ori_img<span class="token punctuation">)</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> ori_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">)</span></code></pre>
<h3 id="data-voc-dataset-py"><a href="#data-voc-dataset-py" class="headerlink" title="data/voc_dataset.py"></a>data/voc_dataset.py</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VOCBboxDataset</span><span class="token punctuation">:</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">'trainval'</span><span class="token punctuation">,</span>
                 use_difficult<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> return_difficult<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># if split not in ['train', 'trainval', 'val']:</span>
        <span class="token comment">#     if not (split == 'test' and year == '2007'):</span>
        <span class="token comment">#         warnings.warn(</span>
        <span class="token comment">#             'please pick split from \'train\', \'trainval\', \'val\''</span>
        <span class="token comment">#             'for 2012 dataset. For 2007 dataset, you can pick \'test\''</span>
        <span class="token comment">#             ' in addition to the above mentioned splits.'</span>
        <span class="token comment">#         )</span>
        
        <span class="token comment"># id_list_file为split.txt，split为'trainval'或者'test'</span>
        id_list_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> <span class="token string">'ImageSets/Main/&#123;0&#125;.txt'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># id_为每个样本文件名</span>
        self<span class="token punctuation">.</span>ids <span class="token operator">=</span> <span class="token punctuation">[</span>id_<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> id_ <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span>id_list_file<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># strip()会去掉前后空格</span>
        <span class="token comment"># 写到/VOC2007/的路径</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>use_difficult <span class="token operator">=</span> use_difficult
        self<span class="token punctuation">.</span>return_difficult <span class="token operator">=</span> return_difficult
        <span class="token comment"># 20类</span>
        self<span class="token punctuation">.</span>label_names <span class="token operator">=</span> VOC_BBOX_LABEL_NAMES

    <span class="token comment"># trainval.txt有5011个，test.txt有210个</span>
    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ids<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_example</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#读入xml标签文件</span>
        id_ <span class="token operator">=</span> self<span class="token punctuation">.</span>ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token comment"># ElementTree 调用parse()方法，返回解析树</span>
        anno <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">'Annotations'</span><span class="token punctuation">,</span> id_ <span class="token operator">+</span> <span class="token string">'.xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        bbox <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        difficult <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#解析xml文件</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> anno<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 标为difficult的目标在测试评估中一般会被忽略</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>use_difficult <span class="token keyword">and</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment">#xml文件中包含object name和difficult(0或者1,0代表容易检测)</span>
            difficult<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># bndbox（xmin,ymin,xmax,ymax),表示框左下角和右上角坐标</span>
            bndbox_anno <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
            <span class="token comment"># 让坐标基于（0,0），意义何在？</span>
            bbox<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>bndbox_anno<span class="token punctuation">.</span>find<span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
                <span class="token keyword">for</span> tag <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">,</span> <span class="token string">'xmin'</span><span class="token punctuation">,</span> <span class="token string">'ymax'</span><span class="token punctuation">,</span> <span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 框中object name</span>
            name <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>VOC_BBOX_LABEL_NAMES<span class="token punctuation">.</span>index<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 所有object的bbox坐标存在列表里</span>
        bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>bbox<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token comment"># 所有object的label存在列表里</span>
        label <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
        <span class="token comment"># PyTorch 不支持 np.bool，所以这里转换为uint8</span>
        difficult <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>difficult<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  

        <span class="token comment"># 根据图片编号在/JPEGImages/取图片</span>
        img_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">'JPEGImages'</span><span class="token punctuation">,</span> id_ <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果color=True，则转换为RGB图</span>
        img <span class="token operator">=</span> read_image<span class="token punctuation">(</span>img_file<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># if self.return_difficult:</span>
        <span class="token comment">#     return img, bbox, label, difficult</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult

    <span class="token comment"># 一般如果想使用索引访问元素时，就可以在类中定义这个方法（__getitem__(self, key) )</span>
    __getitem__ <span class="token operator">=</span> get_example

<span class="token comment"># 类别和名字对应的列表</span>
VOC_BBOX_LABEL_NAMES <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token string">'aeroplane'</span><span class="token punctuation">,</span>
    <span class="token string">'bicycle'</span><span class="token punctuation">,</span>
    <span class="token string">'bird'</span><span class="token punctuation">,</span>
    <span class="token string">'boat'</span><span class="token punctuation">,</span>
    <span class="token string">'bottle'</span><span class="token punctuation">,</span>
    <span class="token string">'bus'</span><span class="token punctuation">,</span>
    <span class="token string">'car'</span><span class="token punctuation">,</span>
    <span class="token string">'cat'</span><span class="token punctuation">,</span>
    <span class="token string">'chair'</span><span class="token punctuation">,</span>
    <span class="token string">'cow'</span><span class="token punctuation">,</span>
    <span class="token string">'diningtable'</span><span class="token punctuation">,</span>
    <span class="token string">'dog'</span><span class="token punctuation">,</span>
    <span class="token string">'horse'</span><span class="token punctuation">,</span>
    <span class="token string">'motorbike'</span><span class="token punctuation">,</span>
    <span class="token string">'person'</span><span class="token punctuation">,</span>
    <span class="token string">'pottedplant'</span><span class="token punctuation">,</span>
    <span class="token string">'sheep'</span><span class="token punctuation">,</span>
    <span class="token string">'sofa'</span><span class="token punctuation">,</span>
    <span class="token string">'train'</span><span class="token punctuation">,</span>
    <span class="token string">'tvmonitor'</span><span class="token punctuation">)</span></code></pre>
<p>再接下来是<code>utils.py</code>里面一些用到的相关函数的注释，只选了其中几个，并且有一些函数没有用到，全部放上来篇幅太多：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">resize_bbox</span><span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> in_size<span class="token punctuation">,</span> out_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据图片resize的情况来缩放bbox</span>
    bbox <span class="token operator">=</span> bbox<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#  #获得与原图同样的缩放比</span>
    y_scale <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>out_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> in_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    x_scale <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>out_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> in_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment"># #按与原图同等比例缩放bbox</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> bbox


<span class="token keyword">def</span> <span class="token function">flip_bbox</span><span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> size<span class="token punctuation">,</span> y_flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> x_flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据图片flip的情况来flip bbox</span>
    H<span class="token punctuation">,</span> W <span class="token operator">=</span> size <span class="token comment">#缩放后图片的size</span>
    bbox <span class="token operator">=</span> bbox<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> y_flip<span class="token punctuation">:</span>  <span class="token comment">#进行垂直翻转</span>
        <span class="token comment"># bbox为(channel,(ymin,xmin,ymax,xmax))</span>
        y_max <span class="token operator">=</span> H <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        y_min <span class="token operator">=</span> H <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_min
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_max
    <span class="token keyword">if</span> x_flip<span class="token punctuation">:</span> <span class="token comment">#进行水平翻转</span>
        x_max <span class="token operator">=</span> W <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        x_min <span class="token operator">=</span> W <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">#计算水平翻转后左下角和右上角的坐标</span>
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_min
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_max
    <span class="token keyword">return</span> bbox

<span class="token keyword">def</span> <span class="token function">random_flip</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> y_random<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> x_random<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                return_param<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> copy<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 数据增强，随机翻转</span>
    y_flip<span class="token punctuation">,</span> x_flip <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span>
    <span class="token comment"># 随机选择图片是否进行垂直、水平翻转</span>
    <span class="token keyword">if</span> y_random<span class="token punctuation">:</span>
        y_flip <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    
    <span class="token keyword">if</span> x_random<span class="token punctuation">:</span>
        x_flip <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> y_flip<span class="token punctuation">:</span>
        <span class="token comment"># channel，height，weight</span>
        img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> x_flip<span class="token punctuation">:</span>
        <span class="token comment"># python [::-1]为逆序输出，这里指水平翻转</span>
        img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> copy<span class="token punctuation">:</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> return_param<span class="token punctuation">:</span>
        <span class="token comment">#返回img和x_flip(为了让bbox有同样的水平翻转操作)</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'y_flip'</span><span class="token punctuation">:</span> y_flip<span class="token punctuation">,</span> <span class="token string">'x_flip'</span><span class="token punctuation">:</span> x_flip<span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> img</code></pre>
<h2 id="🎫-RPN和ROI-Head"><a href="#🎫-RPN和ROI-Head" class="headerlink" title="🎫 RPN和ROI Head"></a>🎫 RPN和ROI Head</h2><p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200504133455.png" srcset="/img/loading.gif" alt="Faster RCNN 整体结构"></p>
<p>原始图片首先会经过一个特征提取器Extrator（这里是VGG16），在原始论文中作者使用了Caffe的预训练模型。同时将VGG16模型的前4层卷积层的参数冻结（在Caffe中将其学习率设为<code>0</code>），并将最后3层全连接层的前两层保留并用来初始化ROI Head里面部分参数。我们可以将Extrator用下图来表示：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505191528.png" srcset="/img/loading.gif" alt=""></p>
<p>可以看到对于一个尺寸为<code>H×W×C</code>的图片，经过这个特征提取网络之后会得到一个<code>H/16 × W/16 × 512</code>的特征图，也即是图中的红色箭头代表的<strong>Features</strong>。</p>
<p>从整体结构图中，我们可以看到RPN这个候选框生成网络接收了两个输入，一个是<strong>特征图</strong>也就是我们刚提到的，另外一个是数据集提供的<strong>GT Box</strong>，这里面究竟是怎么操作呢？</p>
<h3 id="Anchor生成"><a href="#Anchor生成" class="headerlink" title="Anchor生成"></a>Anchor生成</h3><p>我们知道RPN网络使用来提取候选框的，它最大的贡献就在于它提出了一个<code>Anchor</code>的思想，这也是后面One-Stage以及Two-Stage的各类目标检测算法的出发点，<code>Anchor</code>表示的是大小和尺寸固定的候选框，论文中用到了三种比例和三种尺寸，也就是说对于特征图的每个点都将产生9种不同大小的<code>Anchor</code>候选框，其中三种尺寸分别是<code>128、256、512</code>，而三种比例分别为：<code>1:2、2:1、1:1</code>。Faster RCNN的九种Anchor的示意图如下：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505191708.png" srcset="/img/loading.gif" alt="不同尺寸和纵横比的Anchor"></p>
<p>这里我们先来看一下生成Anchor的过程，具体是在<code>model/util</code>文件夹下。我们首先来看<code>bbox_tools.py</code>文件，其中涉及到了RCNN中提到的边框回归公式，$\hat{G}$代表候选框，而回归学习就是学习 $d<em>{x},d</em>{y}, d<em>{h},d</em>{w}$ 这 4 个偏移量 。</p>
<p>真正的目标框G和候选框P之间的偏移可以表示为：</p>
<script type="math/tex; mode=display">
d_{y}=\left(G_{y}-P_{y}\right) / P_{h} \quad \quad d_{x}=\left(G_{x}-P_{x}\right) / P_{w}</script><script type="math/tex; mode=display">
d_{h}=\log \left(G_{h} / P_{h}\right)​\quad \quad d_{w}=\log \left(G_{w} / P_{w}\right)​</script><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">loc2bbox</span><span class="token punctuation">(</span>src_bbox<span class="token punctuation">,</span> loc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 已知源边界框src_bbox和位置偏差loc，求目标框dst_bbox</span>
    <span class="token comment"># src_bbox：shape为（R，4），R为bbox个数，4为左上角和右下角四个坐标</span>
    <span class="token comment"># scr_bbox=[[ymin,xmin,ymax,xmax]</span>
    <span class="token comment"># 			[ymin,xmin,ymax,xmax]</span>
    <span class="token comment">#           ...</span>
    <span class="token comment">#			[ymin,xmin,ymax,xmax]]</span>
    <span class="token comment">#</span>
    <span class="token comment"># loc为[[dy,dx,dh,dw,dy,dx,dh,dw...]  # 图片1的边界框位置偏差？</span>
    <span class="token comment">#      [dy,dx,dh,dw,dy,dx,dh,dw...]</span>
    <span class="token comment">#      ...</span>
    <span class="token comment">#      [dy,dx,dh,dw,dy,dx,dh,dw...]]</span>
    
    <span class="token keyword">if</span> src_bbox<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>loc<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>

    src_bbox <span class="token operator">=</span> src_bbox<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>src_bbox<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> copy<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>	
    
    <span class="token comment"># src_height为Ph，src_width为Pw，src_ctr_y为Py，src_ctr_x为Px</span>
    src_height <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># ymax-ymin</span>
    src_width <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment"># xmax-xmin</span>
    src_ctr_y <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> src_height <span class="token comment"># y_min+0.5h,计算出中心点坐标</span>
    src_ctr_x <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> src_width  <span class="token comment"># x_min+0.5w</span>

    <span class="token comment"># python [start:stop:step] </span>
    dy <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    dx <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    dh <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    dw <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>

    <span class="token comment"># RCNN中提出的边框回归：寻找原始proposal与近似目标框G之间的映射关系，公式在上面</span>
    <span class="token comment"># 得到回归后的目标框的高度、宽度和中心点坐标（Gx,Gy,Gh,Gw）</span>
    ctr_y <span class="token operator">=</span> dy <span class="token operator">*</span> src_height<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token operator">+</span> src_ctr_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># ctr_y为Gy</span>
    ctr_x <span class="token operator">=</span> dx <span class="token operator">*</span> src_width<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token operator">+</span> src_ctr_x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># ctr_x为Gx</span>
    h <span class="token operator">=</span> np<span class="token punctuation">.</span>enp<span class="token punctuation">(</span>dh<span class="token punctuation">)</span> <span class="token operator">*</span> src_height<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># h为Gh</span>
    w <span class="token operator">=</span> np<span class="token punctuation">.</span>enp<span class="token punctuation">(</span>dw<span class="token punctuation">)</span> <span class="token operator">*</span> src_width<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># w为Gw</span>


    <span class="token comment"># 由中心点转换为左上角和右下角坐标</span>
    dst_bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>loc<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>loc<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_y <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> h  <span class="token comment"># y_min</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_x <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> w  <span class="token comment"># x_min</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_y <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> h  <span class="token comment"># y_max</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_x <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> w  <span class="token comment"># x_max</span>

    <span class="token keyword">return</span> dst_bbox



<span class="token comment"># 已知源框src_bbox和目标框dst_bbox，求出其位置偏差</span>
<span class="token keyword">def</span> <span class="token function">bbox2loc</span><span class="token punctuation">(</span>src_bbox<span class="token punctuation">,</span> dst_bbox<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># 计算出源框中心点坐标</span>
    height <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># y_max-y_min</span>
    width <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># x_max-x_min</span>
    ctr_y <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> height
    ctr_x <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> width

    <span class="token comment"># 计算出目标框中心点坐标</span>
    base_height <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    base_width <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    base_ctr_y <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> base_height
    base_ctr_x <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> base_width

    <span class="token comment"># 求出最小的正数</span>
    eps <span class="token operator">=</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>height<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">.</span>eps
    <span class="token comment"># 将height,width与其比较保证全部是非负</span>
    height <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>height<span class="token punctuation">,</span> eps<span class="token punctuation">)</span>
    width <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>width<span class="token punctuation">,</span> eps<span class="token punctuation">)</span>

    <span class="token comment"># 根据上面的公式二计算dx，dy，dh，dw</span>
    dy <span class="token operator">=</span> <span class="token punctuation">(</span>base_ctr_y <span class="token operator">-</span> ctr_y<span class="token punctuation">)</span> <span class="token operator">/</span> height
    dx <span class="token operator">=</span> <span class="token punctuation">(</span>base_ctr_x <span class="token operator">-</span> ctr_x<span class="token punctuation">)</span> <span class="token operator">/</span> width
    dh <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>base_height <span class="token operator">/</span> height<span class="token punctuation">)</span>
    dw <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>base_width <span class="token operator">/</span> width<span class="token punctuation">)</span>

    <span class="token comment"># np.vstack按照行的顺序把数组给堆叠起来</span>
    loc <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>dy<span class="token punctuation">,</span> dx<span class="token punctuation">,</span> dh<span class="token punctuation">,</span> dw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> loc



<span class="token comment"># 求两个bbox的相交的交并比</span>
<span class="token keyword">def</span> <span class="token function">bbox_iou</span><span class="token punctuation">(</span>bbox_a<span class="token punctuation">,</span> bbox_b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># bbox_a=[[ymin,xmin,ymax,xmax]</span>
    <span class="token comment"># 		  [ymin,xmin,ymax,xmax]</span>
    <span class="token comment">#         ...</span>
    <span class="token comment">#		  [ymin,xmin,ymax,xmax]]</span>
    
    <span class="token comment"># 确保bbox第二维为bbox的四个坐标（ymin，xmin，ymax，xmax）</span>
    <span class="token keyword">if</span> bbox_a<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token keyword">or</span> bbox_b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> IndexError

    <span class="token comment"># top left</span>
    <span class="token comment"># l为交叉部分框左上角坐标最大值，为了利用numpy的广播性质，</span>
    <span class="token comment"># bbox_a[:, None, :2]的shape是(N,1,2)，bbox_b[:, :2]的shape是(K,2)</span>
    <span class="token comment"># 由numpy的广播性质，两个数组shape都变成(N,K,2)，也就是对a里每个bbox都分别和b里的每个bbox求左上角点坐标最大值</span>
    tl <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># bottom right</span>
    <span class="token comment"># br为交叉部分框右下角坐标最小值</span>
    br <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 所有坐标轴上tl&lt;br时，返回数组元素的乘积(y1max-yimin)X(x1max-x1min)，</span>
    <span class="token comment"># bboxa与bboxb相交区域的面积</span>
    area_i <span class="token operator">=</span> np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>br <span class="token operator">-</span> tl<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>tl <span class="token operator">&lt;</span> br<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算bboxa的面积</span>
    area_a <span class="token operator">=</span> np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算bboxb的面积</span>
    area_b <span class="token operator">=</span> np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 计算IOU</span>
    <span class="token keyword">return</span> area_i <span class="token operator">/</span> <span class="token punctuation">(</span>area_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> area_b <span class="token operator">-</span> area_i<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">__test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    __test<span class="token punctuation">(</span><span class="token punctuation">)</span>

    
<span class="token comment"># 对特征图features以基准长度为16、选择合适的ratios和scales取基准锚点</span>
 <span class="token comment"># anchor_base。（选择长度为16的原因是图片大小为600*800左右，基准长度</span>
 <span class="token comment"># 16对应的原图区域是256*256，考虑放缩后的大小有128*128，512*512比较合适）</span>
<span class="token keyword">def</span> <span class="token function">generate_anchor_base</span><span class="token punctuation">(</span>base_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         anchor_scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 根据基准点生成9个基本的anchor的功能，ratios=[0.5,1,2],anchor_scales=</span>
    <span class="token comment"># [8,16,32]是长宽比和缩放比例,anchor_scales也就是在base_size的基础上再增</span>
    <span class="token comment"># 加的量，本代码中对应着三种面积的大小(16*8)^2 ,(16*16)^2  (16*32)^2  </span>
    <span class="token comment"># 也就是128,256,512的平方大小</span>

    py <span class="token operator">=</span> base_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
    px <span class="token operator">=</span> base_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>

    <span class="token comment">#（9，4），注意：这里只是以特征图的左上角点为基准产生的9个anchor,</span>
    anchor_base <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ratios<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor_scales<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    <span class="token comment"># six.moves 是用来处理那些在python2 和 3里面函数的位置有变化的，</span>
    <span class="token comment"># 直接用six.moves就可以屏蔽掉这些变化</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> six<span class="token punctuation">.</span>moves<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ratios<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> six<span class="token punctuation">.</span>moves<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>anchor_scales<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 生成9种不同比例的h和w</span>
            h <span class="token operator">=</span> base_size <span class="token operator">*</span> anchor_scales<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>ratios<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            w <span class="token operator">=</span> base_size <span class="token operator">*</span> anchor_scales<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> ratios<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

            index <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor_scales<span class="token punctuation">)</span> <span class="token operator">+</span> j
            <span class="token comment"># 计算出anchor_base画的9个框的左下角和右上角的4个anchor坐标值</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> py <span class="token operator">-</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> px <span class="token operator">-</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> py <span class="token operator">+</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> px <span class="token operator">+</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> anchor_base</code></pre>
<p>在上面的<code>generate_anchor_base</code>函数中，输出<strong>Anchor</strong>的形状以及这9个Anchor的左上右下坐标如下：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 这9个anchor形状为：</span>
<span class="token number">90.50967</span> *181.01933    <span class="token operator">=</span> <span class="token number">128</span>^2
<span class="token number">181.01933</span> * <span class="token number">362.03867</span> <span class="token operator">=</span> <span class="token number">256</span>^2
<span class="token number">362.03867</span> * <span class="token number">724.07733</span> <span class="token operator">=</span> <span class="token number">512</span>^2
<span class="token number">128.0</span> * <span class="token number">128.0</span> <span class="token operator">=</span> <span class="token number">128</span>^2
<span class="token number">256.0</span> * <span class="token number">256.0</span> <span class="token operator">=</span> <span class="token number">256</span>^2
<span class="token number">512.0</span> * <span class="token number">512.0</span> <span class="token operator">=</span> <span class="token number">512</span>^2
<span class="token number">181.01933</span> * <span class="token number">90.50967</span>   <span class="token operator">=</span> <span class="token number">128</span>^2
<span class="token number">362.03867</span> * <span class="token number">181.01933</span> <span class="token operator">=</span> <span class="token number">256</span>^2
<span class="token number">724.07733</span> * <span class="token number">362.03867</span> <span class="token operator">=</span> <span class="token number">512</span>^2

<span class="token comment"># 9个anchor的左上右下坐标：</span>
-37.2548 -82.5097 <span class="token number">53.2548</span> <span class="token number">98.5097</span>
-82.5097 -173.019 <span class="token number">98.5097</span> <span class="token number">189.019</span>
-173.019 -354.039 <span class="token number">189.019</span> <span class="token number">370.039</span>
-56 -56 <span class="token number">72</span> <span class="token number">72</span>
-120 -120 <span class="token number">136</span> <span class="token number">136</span>
-248 -248 <span class="token number">264</span> <span class="token number">264</span>
-82.5097 -37.2548 <span class="token number">98.5097</span> <span class="token number">53.2548</span>
-173.019 -82.5097 <span class="token number">189.019</span> <span class="token number">98.5097</span>
-354.039 -173.019 <span class="token number">370.039</span> <span class="token number">189.019</span></code></pre>
<p>需要注意的是：</p>
<pre class="language-none"><code class="language-none">anchor_base &#x3D; np.zeros((len(ratios) * len(anchor_scales), 4), dtype&#x3D;np.float32)</code></pre>
<p>这行代码表示的是只是以特征图的左上角为基准产生的9个Anchor，而我们知道Faster RCNN是会在特征图的每个点产生9个Anchor的，这个过程在什么地方呢？答案是在<code>mode/region_proposal_network.py</code>里面，这里面的<code>_enumerate_shifted_anchor</code>这个函数就实现了这一功能，接下来我们就仔细看看这个函数是如何产生整个特征图的所有Anchor的（一共20000+个左右Anchor，另外产生的Anchor坐标会截断到图像坐标范围里面）。下面来看看<code>model/region_proposal_network.py</code>里面的<code>_enumerate_shifted_anchor</code>函数</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 利用anchor_base生成所有对应feature map的anchor</span>
<span class="token keyword">def</span> <span class="token function">_enumerate_shifted_anchor</span><span class="token punctuation">(</span>anchor_base<span class="token punctuation">,</span> feat_stride<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Enumerate all shifted anchors:</span>
    <span class="token comment">#</span>
    <span class="token comment"># add A anchors (1, A, 4) to</span>
    <span class="token comment"># cell K shifts (K, 1, 4) to get</span>
    <span class="token comment"># shift anchors (K, A, 4)</span>
    <span class="token comment"># reshape to (K*A, 4) shifted anchors</span>
    <span class="token comment"># return (K*A, 4)</span>

    <span class="token comment"># !TODO: add support for torch.CudaTensor</span>
    <span class="token comment"># np = cuda.get_array_module(anchor_base)</span>
    <span class="token comment"># it seems that it can't be boosed using GPU</span>
    <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
    <span class="token comment"># 纵向偏移量（0，16，32，...）</span>
    shift_y <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">*</span> feat_stride<span class="token punctuation">,</span> feat_stride<span class="token punctuation">)</span>
    <span class="token comment"># 横向偏移量（0，16，32，...）</span>
    shift_x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> width <span class="token operator">*</span> feat_stride<span class="token punctuation">,</span> feat_stride<span class="token punctuation">)</span>
    <span class="token comment"># shift_x = [[0，16，32，..],[0，16，32，..],[0，16，32，..]...],</span>
    <span class="token comment"># shift_y = [[0，0，0，..],[16，16，16，..],[32，32，32，..]...],</span>
    <span class="token comment"># 就是形成了一个纵横向偏移量的矩阵，也就是特征图的每一点都能够通过这个</span>
    <span class="token comment"># 矩阵找到映射在原图中的具体位置！</span>
    shift_x<span class="token punctuation">,</span> shift_y <span class="token operator">=</span> np<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>shift_x<span class="token punctuation">,</span> shift_y<span class="token punctuation">)</span>
    <span class="token comment"># #经过刚才的变化，其实大X,Y的元素个数已经相同，看矩阵的结构也能看出，</span>
    <span class="token comment"># 矩阵大小是相同的，X.ravel()之后变成一行，此时shift_x,shift_y的元</span>
    <span class="token comment"># 素个数是相同的，都等于特征图的长宽的乘积(像素点个数)，不同的是此时</span>
    <span class="token comment"># 的shift_x里面装得是横向看的x的一行一行的偏移坐标，而此时的y里面装</span>
    <span class="token comment"># 的是对应的纵向的偏移坐标！下图显示 np.meshgrid（），shift_y.ravel()</span>
    <span class="token comment"># 操作示例</span>
    shift <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>shift_y<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shift_x<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      shift_y<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shift_x<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># A=9</span>
    A <span class="token operator">=</span> anchor_base<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 读取特征图中元素的总个数</span>
    K <span class="token operator">=</span> shift<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">#用基础的9个anchor的坐标分别和偏移量相加，最后得出了所有的anchor的坐标，</span>
    <span class="token comment"># 四列可以堪称是左上角的坐标和右下角的坐标加偏移量的同步执行，飞速的从</span>
    <span class="token comment"># 上往下捋一遍，所有的anchor就都出来了！一共K个特征点，每一个有A(9)个</span>
    <span class="token comment"># 基本的anchor，所以最后reshape((K*A),4)的形式，也就得到了最后的所有</span>
    <span class="token comment"># 的anchor左下角和右上角坐标.          </span>
    anchor <span class="token operator">=</span> anchor<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>K <span class="token operator">*</span> A<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

    anchor <span class="token operator">=</span> anchor_base<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> A<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> \
             shift<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> K<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    anchor <span class="token operator">=</span> anchor<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>K <span class="token operator">*</span> A<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    <span class="token keyword">return</span> anchor</code></pre>
<p>我们结合一个例子来看一下<code>shift_x, shift_y = np.meshgrid(shift_x, shift_y)函数操</code>这个函数到底执行了什么操作？其中<code>np</code>就是<code>numpy</code>。</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505140046.png" srcset="/img/loading.gif" alt="np.meshgrid操作例子"></p>
<p>然后<code>shift = np.stack((shift_y.ravel(), shift_x.ravel(),shift_y.ravel(), shift_x.ravel()), axis=1)</code>这行代码则是产生坐标偏移对，一个是<code>x</code>方向，一个是<code>y</code>方向。</p>
<p>另外一个问题是这里为什么需要将特征图对应回原图呢？这是因为我们要框住的目标是在原图上，而我们选Anchor是在特征图上，Pooling之后特征之间的相对位置不变，但是尺寸已经减少为了原始图的$1/16$，而我们的Anchor是为了框住原图上的目标而非特征图上的，所以注意一下Anchor一定指的是针对原图的，而非特征图。</p>
<p>接下来我们看看训练RPN的一些细节，RPN的总体架构如下图所示：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505191855.png" srcset="/img/loading.gif" alt="RPN总体架构"></p>
<p>首先我们要明确Anchor的数量是和特征图相关的，不同的特征图对应的Anchor数量也不一样。RPN在<code>Extractor</code>输出的特征图基础上先增加了一个$3×3$卷积，然后利用两个$1×1$卷积分别进行二分类和位置回归。进行分类的卷积核通道数为$9×2$（9个Anchor，每个Anchor 二分类，使用交叉熵损失），进行回归的卷积核通道数为$9×4$（9个Anchor，每个Anchor有4个位置参数）。RPN是一个全卷积网络，这样对输入图片的尺寸是没有要求的。</p>
<p>接下来我们就要讲到今天的重点部分了，即<code>AnchorTargetCreator</code>，<code>ProposalCreator</code>，<code>ProposalTargetCreator</code>，也就是ROI Head最核心的部分：</p>
<h3 id="AnchorTargetCreator"><a href="#AnchorTargetCreator" class="headerlink" title="AnchorTargetCreator"></a>AnchorTargetCreator</h3><p>AnchorTargetCreator就是将20000多个候选的Anchor选出256个Anchor进行分类和回归，选择过程如下：</p>
<ul>
<li>对于每一个GT bbox，选择和它交并比最大的一个Anchor作为正样本。</li>
<li>对于剩下的Anchor，从中选择和任意一个GT bbox交并比超过0.7的Anchor作为正样本，正样本数目不超过128个。</li>
<li>随机选择和GT bbox交并比小于0.3的Anchor作为负样本，负样本和正样本的总数为256。</li>
</ul>
<p>对于每一个Anchor来说，GT_Label要么为1（前景），要么为0（背景），而GT_Loc则是由4个位置参数组成，也就是上面讲的目标框和候选框之间的偏移。</p>
<p>计算分类损失使用的是交叉熵损失，而计算回归损失则使用了SmoothL1Loss，在计算回归损失的时候只计算正样本（前景）的损失，不计算负样本的损失。</p>
<p>代码实现在<code>model/utils/creator_tool.py</code>里面，具体如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># AnchorTargetCreator作用是生成训练要用的anchor(正负样本</span>
<span class="token comment"># 各128个框的坐标和256个label（0或者1）)</span>
<span class="token comment"># 利用每张图中bbox的真实标签来为所有任务分配ground truth</span>
<span class="token keyword">class</span> <span class="token class-name">AnchorTargetCreator</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 n_sample<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
                 pos_iou_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> neg_iou_thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
                 pos_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>n_sample <span class="token operator">=</span> n_sample
        self<span class="token punctuation">.</span>pos_iou_thresh <span class="token operator">=</span> pos_iou_thresh
        self<span class="token punctuation">.</span>neg_iou_thresh <span class="token operator">=</span> neg_iou_thresh
        self<span class="token punctuation">.</span>pos_ratio <span class="token operator">=</span> pos_ratio

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> img_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 特征图大小</span>
        img_H<span class="token punctuation">,</span> img_W <span class="token operator">=</span> img_size
        <span class="token comment"># 一般对应20000个左右anchor</span>
        n_anchor <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor<span class="token punctuation">)</span>
        <span class="token comment"># 将那些超出图片范围的anchor全部去掉,只保留位于图片内部的序号</span>
        inside_index <span class="token operator">=</span> _get_inside_index<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> img_H<span class="token punctuation">,</span> img_W<span class="token punctuation">)</span>
        <span class="token comment"># 保留位于图片内部的anchor</span>
        anchor <span class="token operator">=</span> anchor<span class="token punctuation">[</span>inside_index<span class="token punctuation">]</span>
        <span class="token comment"># 筛选出符合条件的正例128个负例128并给它们附上相应的label</span>
        argmax_ious<span class="token punctuation">,</span> label <span class="token operator">=</span> self<span class="token punctuation">.</span>_create_label<span class="token punctuation">(</span>
            inside_index<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span>

        <span class="token comment"># 计算每一个anchor与对应bbox求得iou最大的bbox计算偏移</span>
        <span class="token comment"># 量（注意这里是位于图片内部的每一个）</span>
        loc <span class="token operator">=</span> bbox2loc<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">[</span>argmax_ious<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 将位于图片内部的框的label对应到所有生成的20000个框中</span>
        <span class="token comment"># （label原本为所有在图片中的框的）</span>
        label <span class="token operator">=</span> _unmap<span class="token punctuation">(</span>label<span class="token punctuation">,</span> n_anchor<span class="token punctuation">,</span> inside_index<span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 将回归的框对应到所有生成的20000个框中（label原本为</span>
        <span class="token comment"># 所有在图片中的框的）</span>
        loc <span class="token operator">=</span> _unmap<span class="token punctuation">(</span>loc<span class="token punctuation">,</span> n_anchor<span class="token punctuation">,</span> inside_index<span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> loc<span class="token punctuation">,</span> label
    <span class="token comment"># 下面为调用的_creat_label（） 函数</span>
    <span class="token keyword">def</span> <span class="token function">_create_label</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inside_index<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># inside_index为所有在图片范围内的anchor序号</span>
        label <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>inside_index<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
        <span class="token comment"># #全部填充-1</span>
        label<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 调用_calc_ious（）函数得到每个anchor与哪个bbox的iou最大</span>
        <span class="token comment"># 以及这个iou值、每个bbox与哪个anchor的iou最大(需要体会从</span>
        <span class="token comment"># 行和列取最大值的区别)</span>
        argmax_ious<span class="token punctuation">,</span> max_ious<span class="token punctuation">,</span> gt_argmax_ious <span class="token operator">=</span> \
            self<span class="token punctuation">.</span>_calc_ious<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> inside_index<span class="token punctuation">)</span>

        <span class="token comment"># #把每个anchor与对应的框求得的iou值与负样本阈值比较，若小</span>
        <span class="token comment"># 于负样本阈值，则label设为0，pos_iou_thresh=0.7, </span>
        <span class="token comment"># neg_iou_thresh=0.3</span>
        label<span class="token punctuation">[</span>max_ious <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>neg_iou_thresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment"># 把与每个bbox求得iou值最大的anchor的label设为1</span>
        label<span class="token punctuation">[</span>gt_argmax_ious<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

        <span class="token comment"># 把每个anchor与对应的框求得的iou值与正样本阈值比较，</span>
        <span class="token comment"># 若大于正样本阈值，则label设为1</span>
        label<span class="token punctuation">[</span>max_ious <span class="token operator">>=</span> self<span class="token punctuation">.</span>pos_iou_thresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

        <span class="token comment"># 按照比例计算出正样本数量，pos_ratio=0.5，n_sample=256</span>
        n_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pos_ratio <span class="token operator">*</span> self<span class="token punctuation">.</span>n_sample<span class="token punctuation">)</span>
        <span class="token comment"># 得到所有正样本的索引</span>
        pos_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>label <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># 如果选取出来的正样本数多于预设定的正样本数，则随机抛弃，将那些抛弃的样本的label设为-1</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pos_index<span class="token punctuation">)</span> <span class="token operator">></span> n_pos<span class="token punctuation">:</span>
            disable_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                pos_index<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pos_index<span class="token punctuation">)</span> <span class="token operator">-</span> n_pos<span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            label<span class="token punctuation">[</span>disable_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

        <span class="token comment"># 设定的负样本的数量</span>
        n_neg <span class="token operator">=</span> self<span class="token punctuation">.</span>n_sample <span class="token operator">-</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>label <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 负样本的索引</span>
        neg_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>label <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>neg_index<span class="token punctuation">)</span> <span class="token operator">></span> n_neg<span class="token punctuation">:</span>
            <span class="token comment"># 随机选择不要的负样本，个数为len(neg_index)-neg_index，label值设为-1</span>
            disable_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                neg_index<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>neg_index<span class="token punctuation">)</span> <span class="token operator">-</span> n_neg<span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            label<span class="token punctuation">[</span>disable_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

        <span class="token keyword">return</span> argmax_ious<span class="token punctuation">,</span> label
    <span class="token comment"># _calc_ious函数</span>
    <span class="token keyword">def</span> <span class="token function">_calc_ious</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> inside_index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ious between the anchors and the gt boxes</span>
        <span class="token comment"># 调用bbox_iou函数计算anchor与bbox的IOU， ious：（N,K），</span>
        <span class="token comment"># N为anchor中第N个，K为bbox中第K个，N大概有15000个</span>
        ious <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span>
        <span class="token comment"># 1代表行，0代表列</span>
        argmax_ious <span class="token operator">=</span> ious<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 求出每个anchor与哪个bbox的iou最大，以及最大值，max_ious:[1,N]</span>
        max_ious <span class="token operator">=</span> ious<span class="token punctuation">[</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>inside_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> argmax_ious<span class="token punctuation">]</span>
        gt_argmax_ious <span class="token operator">=</span> ious<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># 求出每个bbox与哪个anchor的iou最大，以及最大值,gt_max_ious:[1,K]</span>
        gt_max_ious <span class="token operator">=</span> ious<span class="token punctuation">[</span>gt_argmax_ious<span class="token punctuation">,</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>ious<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token comment"># 然后返回最大iou的索引（每个bbox与哪个anchor的iou最大),有K个</span>
        gt_argmax_ious <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>ious <span class="token operator">==</span> gt_max_ious<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> argmax_ious<span class="token punctuation">,</span> max_ious<span class="token punctuation">,</span> gt_argmax_ious</code></pre>
<h3 id="ProposalCreator"><a href="#ProposalCreator" class="headerlink" title="ProposalCreator"></a>ProposalCreator</h3><p>RPN在自身训练的时候还会提供ROIs给Faster RCNN的ROI Head作为训练样本。RPN生成ROIs的过程就是ProposalCreator，具体流程如下：</p>
<ul>
<li>对于每张图片，利用它的特征图，计算$\frac{H}{16} \times \frac{W}{16} \times 9$（大约20000个）Anchor属于前景的概率以及对应的位置参数。</li>
<li>选取概率较大的12000个Anchor。</li>
<li>利用回归的位置参数修正这12000个Anchor的位置，获得ROIs。</li>
<li>利用非极大值抑制，选出概率最大的2000个ROIs。</li>
</ul>
<blockquote>
<p><strong>注意！</strong> 在推理阶段，为了提高处理速度，12000和2000分别变成了6000和300。并且这部分操作不需要反向传播，所以可以利用numpy或者tensor实现。因此，RPN的输出就是形如$2000×4$或者$300×4$的Tensor。</p>
</blockquote>
<p>RPN给出了候选框，然后ROI Head就是在候选框的基础上继续进行分类和位置参数的回归获得最后的结果，ROI Head的结构图如下所示：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505141253.png" srcset="/img/loading.gif" alt="ROIHead网络结构"></p>
<p>代码实现在<code>model/utils/creator_tool.py</code>里面，具体如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 下面是ProposalCreator的代码： 这部分的操作不需要进行反向传播</span>
<span class="token comment"># 因此可以利用numpy/tensor实现</span>
<span class="token keyword">class</span> <span class="token class-name">ProposalCreator</span><span class="token punctuation">:</span>
    <span class="token comment"># 对于每张图片，利用它的feature map，计算（H/16）x(W/16)x9(大概20000)</span>
    <span class="token comment"># 个anchor属于前景的概率，然后从中选取概率较大的12000张，利用位置回归参</span>
    <span class="token comment"># 数，修正这12000个anchor的位置， 利用非极大值抑制，选出2000个ROIS以及</span>
    <span class="token comment"># 对应的位置参数。</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 parent_model<span class="token punctuation">,</span>
                 nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
                 n_train_pre_nms<span class="token operator">=</span><span class="token number">12000</span><span class="token punctuation">,</span>
                 n_train_post_nms<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
                 n_test_pre_nms<span class="token operator">=</span><span class="token number">6000</span><span class="token punctuation">,</span>
                 n_test_post_nms<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span>
                 min_size<span class="token operator">=</span><span class="token number">16</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>parent_model <span class="token operator">=</span> parent_model
        self<span class="token punctuation">.</span>nms_thresh <span class="token operator">=</span> nms_thresh
        self<span class="token punctuation">.</span>n_train_pre_nms <span class="token operator">=</span> n_train_pre_nms
        self<span class="token punctuation">.</span>n_train_post_nms <span class="token operator">=</span> n_train_post_nms
        self<span class="token punctuation">.</span>n_test_pre_nms <span class="token operator">=</span> n_test_pre_nms
        self<span class="token punctuation">.</span>n_test_post_nms <span class="token operator">=</span> n_test_post_nms
        self<span class="token punctuation">.</span>min_size <span class="token operator">=</span> min_size
    <span class="token comment"># 这里的loc和score是经过region_proposal_network中</span>
    <span class="token comment"># 经过1x1卷积分类和回归得到的。</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loc<span class="token punctuation">,</span> score<span class="token punctuation">,</span>
                 anchor<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>parent_model<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            n_pre_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_train_pre_nms <span class="token comment">#12000</span>
            n_post_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_train_post_nms <span class="token comment">#经过NMS后有2000个</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            n_pre_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_test_pre_nms <span class="token comment">#6000</span>
            n_post_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_test_post_nms <span class="token comment">#经过NMS后有300个</span>

        <span class="token comment"># 将bbox转换为近似groudtruth的anchor(即rois)</span>
        roi <span class="token operator">=</span> loc2bbox<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> loc<span class="token punctuation">)</span>

        <span class="token comment"># slice表示切片操作</span>
        <span class="token comment"># 裁剪将rois的ymin,ymax限定在[0,H]</span>
        roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>
            roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 裁剪将rois的xmin,xmax限定在[0,W]</span>
        roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>
            roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Remove predicted boxes with either height or width &lt; threshold.</span>
        min_size <span class="token operator">=</span> self<span class="token punctuation">.</span>min_size <span class="token operator">*</span> scale <span class="token comment">#16</span>
        <span class="token comment"># rois的宽</span>
        hs <span class="token operator">=</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># rois的高</span>
        ws <span class="token operator">=</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># 确保rois的长宽大于最小阈值</span>
        keep <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>hs <span class="token operator">>=</span> min_size<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ws <span class="token operator">>=</span> min_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>keep<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># 对剩下的ROIs进行打分（根据region_proposal_network中rois的预测前景概率）</span>
        score <span class="token operator">=</span> score<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>

        <span class="token comment"># Sort all (proposal, score) pairs by score from highest to lowest.</span>
        <span class="token comment"># Take top pre_nms_topN (e.g. 6000).</span>
        <span class="token comment"># 将score拉伸并逆序（从高到低）排序</span>
        order <span class="token operator">=</span> score<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># train时从20000中取前12000个rois，test取前6000个</span>
        <span class="token keyword">if</span> n_pre_nms <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            order <span class="token operator">=</span> order<span class="token punctuation">[</span><span class="token punctuation">:</span>n_pre_nms<span class="token punctuation">]</span>
        roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>order<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

        <span class="token comment"># Apply nms (e.g. threshold = 0.7).</span>
        <span class="token comment"># Take after_nms_topN (e.g. 300).</span>

        <span class="token comment"># unNOTE: somthing is wrong here!</span>
        <span class="token comment"># TODO: remove cuda.to_gpu</span>
        <span class="token comment"># #（具体需要看NMS的原理以及输入参数的作用）调用非极大值抑制函数，</span>
        <span class="token comment"># 将重复的抑制掉，就可以将筛选后ROIS进行返回。经过NMS处理后Train</span>
        <span class="token comment"># 数据集得到2000个框，Test数据集得到300个框</span>
        keep <span class="token operator">=</span> non_maximum_suppression<span class="token punctuation">(</span>
            cp<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>cp<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            thresh<span class="token operator">=</span>self<span class="token punctuation">.</span>nms_thresh<span class="token punctuation">)</span>
        <span class="token keyword">if</span> n_post_nms <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            keep <span class="token operator">=</span> keep<span class="token punctuation">[</span><span class="token punctuation">:</span>n_post_nms<span class="token punctuation">]</span>
        <span class="token comment"># 取出最终的2000或300个rois</span>
        roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>
        <span class="token keyword">return</span> roi</code></pre>
<h3 id="ProposalTargetCreator"><a href="#ProposalTargetCreator" class="headerlink" title="ProposalTargetCreator"></a>ProposalTargetCreator</h3><p>ROIs给出了2000个候选框，分别对应了不同大小的Anchor。我们首先需要利用ProposalTargetCreator挑选出128个<code>sample_rois</code>，然后使用了ROI Pooling将这些不同尺寸的区域全部Pooling到同一个尺度($7×7$)上，关于ROI Pooling这里就不多讲了，具体见：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA4MjY4NTk0NQ==&amp;mid=2247484605&amp;idx=1&amp;sn=a3ebfc4cedaad84a60020cd1781f119c&amp;scene=21#wechat_redirect">实例分割算法之Mask R-CNN论文解读</a> 。那么这里为什么要Pooling成$7×7$大小呢？</p>
<p>这是为了共享权重，前面在<code>Extrator</code>部分说到Faster RCNN除了前面基层卷积被用到之外，最后全连接层的权重也可以继续利用。当所有的RoIs都被Resize到$512×512×7$的特征图之后，将它Reshape成一个一维的向量，就可以利用VGG16预训练的权重初始化前两层全连接层了。最后，再接上两个全连接层FC21用来分类（20个类+背景，VOC）和回归（21个类，每个类有4个位置参数）。</p>
<p>我们再来看一下ProposalTargetCreator具体是如何选择128个ROIs进行训练的？过程如下：</p>
<ul>
<li>RoIs和GT box的IOU大于0.5的，选择一些如32个。</li>
<li>RoIs和gt_bboxes的IoU小于等于0（或者0.1）的选择一些（比如 128-32=96个）作为负样本。</li>
</ul>
<p>同时为了方便训练，对选择出的128个RoIs的<code>gt_roi_loc</code>进行标准化处理（减均值除以标准差）。</p>
<p>下面来看看代码实现，同样是在<code>model/utils/creator_tool.py</code>里面：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 下面是ProposalTargetCreator代码：ProposalCreator产生2000个ROIS，</span>
<span class="token comment"># 但是这些ROIS并不都用于训练，经过本ProposalTargetCreator的筛选产生</span>
<span class="token comment"># 128个用于自身的训练</span>

<span class="token keyword">class</span> <span class="token class-name">ProposalTargetCreator</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 n_sample<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>
                 pos_ratio<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> pos_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                 neg_iou_thresh_hi<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> neg_iou_thresh_lo<span class="token operator">=</span><span class="token number">0.0</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>n_sample <span class="token operator">=</span> n_sample
        self<span class="token punctuation">.</span>pos_ratio <span class="token operator">=</span> pos_ratio
        self<span class="token punctuation">.</span>pos_iou_thresh <span class="token operator">=</span> pos_iou_thresh
        self<span class="token punctuation">.</span>neg_iou_thresh_hi <span class="token operator">=</span> neg_iou_thresh_hi
        self<span class="token punctuation">.</span>neg_iou_thresh_lo <span class="token operator">=</span> neg_iou_thresh_lo  <span class="token comment"># NOTE:default 0.1 in py-faster-rcnn</span>
    <span class="token comment"># 输入：2000个rois、一个batch（一张图）中所有的bbox ground truth（R，4）、</span>
    <span class="token comment"># 对应bbox所包含的label（R，1）（VOC2007来说20类0-19）</span>
    <span class="token comment"># 输出：128个sample roi（128，4）、128个gt_roi_loc（128，4）、</span>
    <span class="token comment"># 128个gt_roi_label（128，1）</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> roi<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span>
                 loc_normalize_mean<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 loc_normalize_std<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        n_bbox<span class="token punctuation">,</span> _ <span class="token operator">=</span> bbox<span class="token punctuation">.</span>shape
        <span class="token comment"># 首先将2000个roi和m个bbox给concatenate了一下成为</span>
        <span class="token comment"># 新的roi（2000+m，4）。</span>
        roi <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>roi<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># n_sample = 128,pos_ratio=0.5，round 对传入的数据进行四舍五入</span>
        pos_roi_per_image <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_sample <span class="token operator">*</span> self<span class="token punctuation">.</span>pos_ratio<span class="token punctuation">)</span>
        <span class="token comment"># 计算每一个roi与每一个bbox的iou</span>
        iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>roi<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span>
        <span class="token comment"># 按行找到最大值，返回最大值对应的序号以及其真正的IOU。</span>
        <span class="token comment"># 返回的是每个roi与哪个bbox的最大，以及最大的iou值</span>
        gt_assignment <span class="token operator">=</span> iou<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 每个roi与对应bbox最大的iou</span>
        max_iou <span class="token operator">=</span> iou<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 从1开始的类别序号，给每个类得到真正的label(将0-19变为1-20)</span>
        gt_roi_label <span class="token operator">=</span> label<span class="token punctuation">[</span>gt_assignment<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>

        <span class="token comment"># 同样的根据iou的最大值将正负样本找出来，pos_iou_thresh=0.5</span>
        pos_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>max_iou <span class="token operator">>=</span> self<span class="token punctuation">.</span>pos_iou_thresh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># 需要保留的roi个数（满足大于pos_iou_thresh条件的roi与64之间较小的一个）</span>
        pos_roi_per_this_image <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>pos_roi_per_image<span class="token punctuation">,</span> pos_index<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 找出的样本数目过多就随机丢掉一些</span>
        <span class="token keyword">if</span> pos_index<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            pos_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                pos_index<span class="token punctuation">,</span> size<span class="token operator">=</span>pos_roi_per_this_image<span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token comment"># neg_iou_thresh_hi=0.5，neg_iou_thresh_lo=0.0</span>
        neg_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>max_iou <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>neg_iou_thresh_hi<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
                             <span class="token punctuation">(</span>max_iou <span class="token operator">>=</span> self<span class="token punctuation">.</span>neg_iou_thresh_lo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        neg_roi_per_this_image <span class="token operator">=</span> self<span class="token punctuation">.</span>n_sample <span class="token operator">-</span> pos_roi_per_this_image
        neg_roi_per_this_image <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>neg_roi_per_this_image<span class="token punctuation">,</span>
                                         neg_index<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> neg_index<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            neg_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                neg_index<span class="token punctuation">,</span> size<span class="token operator">=</span>neg_roi_per_this_image<span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token comment"># The indices that we're selecting (both positive and negative).</span>
        keep_index <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pos_index<span class="token punctuation">,</span> neg_index<span class="token punctuation">)</span>
        gt_roi_label <span class="token operator">=</span> gt_roi_label<span class="token punctuation">[</span>keep_index<span class="token punctuation">]</span>
        gt_roi_label<span class="token punctuation">[</span>pos_roi_per_this_image<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 负样本label 设为0</span>
        sample_roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>keep_index<span class="token punctuation">]</span>
        <span class="token comment"># 此时输出的128*4的sample_roi就可以去扔到 RoIHead网络里去进行分类</span>
        <span class="token comment"># 与回归了。同样， RoIHead网络利用这sample_roi+featue为输入，输出</span>
        <span class="token comment"># 是分类（21类）和回归（进一步微调bbox）的预测值，那么分类回归的groud </span>
        <span class="token comment"># truth就是ProposalTargetCreator输出的gt_roi_label和gt_roi_loc。</span>
        <span class="token comment"># Compute offsets and scales to match sampled RoIs to the GTs.</span>
        <span class="token comment"># 求这128个样本的groundtruth</span>
        gt_roi_loc <span class="token operator">=</span> bbox2loc<span class="token punctuation">(</span>sample_roi<span class="token punctuation">,</span> bbox<span class="token punctuation">[</span>gt_assignment<span class="token punctuation">[</span>keep_index<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># ProposalTargetCreator首次用到了真实的21个类的label,</span>
        <span class="token comment"># 且该类最后对loc进行了归一化处理，所以预测时要进行均值方差处理</span>
        gt_roi_loc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gt_roi_loc <span class="token operator">-</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>loc_normalize_mean<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
                       <span class="token punctuation">)</span> <span class="token operator">/</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>loc_normalize_std<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> sample_roi<span class="token punctuation">,</span> gt_roi_loc<span class="token punctuation">,</span> gt_roi_label</code></pre>
<h2 id="📟-Faster-RCNN网络模型搭建"><a href="#📟-Faster-RCNN网络模型搭建" class="headerlink" title="📟 Faster RCNN网络模型搭建"></a>📟 Faster RCNN网络模型搭建</h2><p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193036.png" srcset="/img/loading.gif" alt="Faster RCNN网络"></p>
<p>注意网络结构图中的蓝色箭头的线代表了计算图，梯度反向传播会经过。而红色的线不需要反向传播。一个有趣的事情是在Instance-aware Semantic Segmentation via Multi-task Network Cascades这篇论文（<code>https://arxiv.org/abs/1512.04412</code>）中提到ProposalCreator生成RoIs的过程也可以进行反向传播，感兴趣可以去看看。</p>
<p>在上一节主要讲了RPN里面的<code>AnchorTargetCreator</code>，<code>ProposalCreator</code>，<code>ProposalTargetCreator</code>，而RPN网络的核心类<code>RegionProposalNetwork</code>还没讲，这里先看一下，代码在<code>model/region_proposal_network.py</code>里面，细节如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RegionProposalNetwork</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span> in_channels<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> mid_channels<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            anchor_scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> feat_stride<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
            proposal_creator_params<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RegionProposalNetwork<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 首先生成上述以（0，0）为中心的9个base anchor</span>
        self<span class="token punctuation">.</span>anchor_base <span class="token operator">=</span> generate_anchor_base<span class="token punctuation">(</span>
            anchor_scales<span class="token operator">=</span>anchor_scales<span class="token punctuation">,</span> ratios<span class="token operator">=</span>ratios<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>feat_stride <span class="token operator">=</span> feat_stride
        self<span class="token punctuation">.</span>proposal_layer <span class="token operator">=</span> ProposalCreator<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>proposal_creator_params<span class="token punctuation">)</span>
        n_anchor <span class="token operator">=</span> self<span class="token punctuation">.</span>anchor_base<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> n_anchor <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>loc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> n_anchor <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>loc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token comment"># x的尺寸为(batch_size，512,H/16,W/16），其中H，W分别为原图的高和宽</span>
        <span class="token comment"># x为feature map，n为batch_size,此版本代码为1. hh，ww即为宽高</span>
        n<span class="token punctuation">,</span> _<span class="token punctuation">,</span> hh<span class="token punctuation">,</span> ww <span class="token operator">=</span> x<span class="token punctuation">.</span>shape
        <span class="token comment"># 在9个base_anchor基础上生成hh*ww*9个anchor，对应到原图坐标</span>
        <span class="token comment"># feat_stride=16 ，因为是经4次pool后提到的特征，故feature map较</span>
        <span class="token comment"># 原图缩小了16倍</span>
        anchor <span class="token operator">=</span> _enumerate_shifted_anchor<span class="token punctuation">(</span>
            np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchor_base<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span>
            self<span class="token punctuation">.</span>feat_stride<span class="token punctuation">,</span> hh<span class="token punctuation">,</span> ww<span class="token punctuation">)</span>
        
        <span class="token comment"># （hh * ww * 9）/hh*ww = 9 </span>
        n_anchor <span class="token operator">=</span> anchor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token punctuation">(</span>hh <span class="token operator">*</span> ww<span class="token punctuation">)</span> 
        <span class="token comment"># 512个3x3卷积(512, H/16,W/16)</span>
        h <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># n_anchor（9）* 4个1x1卷积，回归坐标偏移量。（9*4，hh,ww)</span>
        rpn_locs <span class="token operator">=</span> self<span class="token punctuation">.</span>loc<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
        <span class="token comment"># UNNOTE: check whether need contiguous</span>
        <span class="token comment"># A: Yes</span>
        <span class="token comment"># 转换为（n，hh，ww，9*4）后变为（n，hh*ww*9，4）</span>
        rpn_locs <span class="token operator">=</span> rpn_locs<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token comment"># n_anchor（9）*2个1x1卷积，回归类别。（9*2，hh,ww）</span>
        rpn_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>score<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
        <span class="token comment"># 转换为（n，hh，ww，9*2）</span>
        rpn_scores <span class="token operator">=</span> rpn_scores<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算&#123;Softmax&#125;(x_&#123;i&#125;) = \&#123;enp(x_i)&#125;&#123;\sum_j enp(x_j)&#125;</span>
        rpn_softmax_scores <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>rpn_scores<span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> hh<span class="token punctuation">,</span> ww<span class="token punctuation">,</span> n_anchor<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token comment"># 得到前景的分类概率</span>
        rpn_fg_scores <span class="token operator">=</span> rpn_softmax_scores<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 得到所有anchor的前景分类概率</span>
        rpn_fg_scores <span class="token operator">=</span> rpn_fg_scores<span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 得到每一张feature map上所有anchor的网络输出值</span>
        rpn_scores <span class="token operator">=</span> rpn_scores<span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        rois <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        roi_indices <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># n为batch_size数</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 调用ProposalCreator函数， rpn_locs维度（hh*ww*9，4）</span>
            <span class="token comment"># ，rpn_fg_scores维度为（hh*ww*9），anchor的维度为</span>
            <span class="token comment"># （hh*ww*9，4）， img_size的维度为（3，H，W），H和W是</span>
            <span class="token comment"># 经过数据预处理后的。计算（H/16）x(W/16)x9(大概20000)</span>
            <span class="token comment"># 个anchor属于前景的概率，取前12000个并经过NMS得到2000个</span>
            <span class="token comment"># 近似目标框G^的坐标。roi的维度为(2000,4)</span>
            roi <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_layer<span class="token punctuation">(</span>
                rpn_locs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                rpn_fg_scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                anchor<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span>
                scale<span class="token operator">=</span>scale<span class="token punctuation">)</span>
            batch_index <span class="token operator">=</span> i <span class="token operator">*</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
            <span class="token comment"># rois为所有batch_size的roi</span>
            rois<span class="token punctuation">.</span>append<span class="token punctuation">(</span>roi<span class="token punctuation">)</span>
            roi_indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span>batch_index<span class="token punctuation">)</span>
        <span class="token comment"># 按行拼接（即没有batch_size的区分，每一个[]里都是一个anchor的四个坐标）</span>
        rois <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>rois<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># 这个 roi_indices在此代码中是多余的，因为我们实现的是batch_siae=1的</span>
        <span class="token comment"># 网络，一个batch只会输入一张图象。如果多张图像的话就需要存储索引以找到</span>
        <span class="token comment"># 对应图像的roi</span>
        roi_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>roi_indices<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># rpn_locs的维度（hh*ww*9，4），rpn_scores维度为（hh*ww*9，2），</span>
        <span class="token comment"># rois的维度为（2000,4），roi_indices用不到，</span>
        <span class="token comment"># anchor的维度为（hh*ww*9，4）</span>
        <span class="token keyword">return</span> rpn_locs<span class="token punctuation">,</span> rpn_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">,</span> anchor</code></pre>
<p>可以看到RegionProposalNetwork继承于nn.Module，这个网络我们在上一个推文讲的很细节了，在继续阅读之前，请确保你已经理解了RPN和ROI Head。</p>
<p>接下来，我们需要知道在<code>model/roi_module.py</code>里面主要利用了<code>cupy</code>(专用于GPU的numpy)实现ROI Pooling的前向传播和反向传播。NMS和ROI pooling利用了：<strong>「cupy」</strong>和<strong>「chainer」</strong> 。</p>
<p>其主要任务是对于一张图像得到的特征图()，然后利用<code>sample_roi</code>的bbox坐标去在特征图上裁剪下来所有<code>roi</code>对应的特征图（训练：）、（测试：）。</p>
<p>接下来就是搭建网络模型的文件<code>model/faster_rcnn.py</code>，这个脚本定义了Faster RCNN的基本类<strong>「FasterRCNN」</strong>。我们知道Faster RCNN的三个核心步骤就是：</p>
<ul>
<li>特征提取：输入一张图片得到其特征图feature map</li>
<li>RPN：给定特征图后产生一系列RoIs</li>
<li>ROI Head：利用这些RoIs对应的特征图对这些RoIs中的类别进行分类，并提升定位精度</li>
</ul>
<p>在<strong>「FasterRCNN」</strong>这个类中就初始化了这三个重要的步骤，即<code>self.extrator</code>，<code>self.rpn</code>，<code>self.head</code>。</p>
<p><strong>「FasterRCNN」</strong>类中，<code>forward</code>函数实现前向传播，代码如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 实现前向传播</span>
        img_size <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

        h <span class="token operator">=</span> self<span class="token punctuation">.</span>extractor<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        rpn_locs<span class="token punctuation">,</span> rpn_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">,</span> anchor <span class="token operator">=</span> \
            self<span class="token punctuation">.</span>rpn<span class="token punctuation">(</span>h<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> scale<span class="token punctuation">)</span>
        roi_cls_locs<span class="token punctuation">,</span> roi_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>head<span class="token punctuation">(</span>
            h<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">)</span>
        <span class="token keyword">return</span> roi_cls_locs<span class="token punctuation">,</span> roi_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices</code></pre>
<p>也可以用下图来更清晰的表示：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193439.png" srcset="/img/loading.gif" alt="Faster RCNN前向传播网络"></p>
<p>而这个<code>forward</code>过程中边界框的数量变化可以表示为下图：</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193420.png" srcset="/img/loading.gif" alt="边界框数量变化"></p>
<p>接下来我们看一下预测函数<code>predict</code>，这个函数实现了对测试集图片的预测，同样<code>batch=1</code>，即每次输入一张图片。详解如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> imgs<span class="token punctuation">,</span>sizes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>visualize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 设置为eval模式</span>
        self<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 是否开启可视化</span>
        <span class="token keyword">if</span> visualize<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>use_preset<span class="token punctuation">(</span><span class="token string">'visualize'</span><span class="token punctuation">)</span>
            prepared_imgs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            sizes <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> img <span class="token keyword">in</span> imgs<span class="token punctuation">:</span>
                size <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                img <span class="token operator">=</span> preprocess<span class="token punctuation">(</span>at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
                prepared_imgs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                sizes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
             prepared_imgs <span class="token operator">=</span> imgs 
        bboxes <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        labels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        scores <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> img<span class="token punctuation">,</span> size <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>prepared_imgs<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 对读入的图片求尺度scale，因为输入的图像经预处理就会有缩放，</span>
            <span class="token comment"># 所以需记录缩放因子scale，这个缩放因子在ProposalCreator</span>
            <span class="token comment"># 筛选roi时有用到，即将所有候选框按这个缩放因子映射回原图，</span>
            <span class="token comment"># 超出原图边框的趋于将被截断。</span>
            scale <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token comment"># 执行forward</span>
            roi_cls_loc<span class="token punctuation">,</span> roi_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">(</span>img<span class="token punctuation">,</span> scale<span class="token operator">=</span>scale<span class="token punctuation">)</span>
            <span class="token comment"># We are assuming that batch size is 1.</span>

            roi_score <span class="token operator">=</span> roi_scores<span class="token punctuation">.</span>data
            roi_cls_loc <span class="token operator">=</span> roi_cls_loc<span class="token punctuation">.</span>data
            roi <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>rois<span class="token punctuation">)</span> <span class="token operator">/</span> scale

            <span class="token comment"># Convert predictions to bounding boxes in image coordinates.</span>
            <span class="token comment"># Bounding boxes are scaled to the scale of the input images.</span>
            <span class="token comment"># 为ProposalCreator对loc做了归一化（-mean /std）处理，所以这里</span>
            <span class="token comment"># 需要再*std+mean，此时的位置参数loc为roi_cls_loc。然后将这128</span>
            <span class="token comment"># 个roi利用roi_cls_loc进行微调，得到新的cls_bbox。</span>
            mean <span class="token operator">=</span> t<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>loc_normalize_mean<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \
                repeat<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_class<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
            std <span class="token operator">=</span> t<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>loc_normalize_std<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \
                repeat<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_class<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>

            roi_cls_loc <span class="token operator">=</span> <span class="token punctuation">(</span>roi_cls_loc <span class="token operator">*</span> std <span class="token operator">+</span> mean<span class="token punctuation">)</span>
            roi_cls_loc <span class="token operator">=</span> roi_cls_loc<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
            roi <span class="token operator">=</span> roi<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enpand_as<span class="token punctuation">(</span>roi_cls_loc<span class="token punctuation">)</span>
            cls_bbox <span class="token operator">=</span> loc2bbox<span class="token punctuation">(</span>at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>roi_cls_loc<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            cls_bbox <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>cls_bbox<span class="token punctuation">)</span>
            cls_bbox <span class="token operator">=</span> cls_bbox<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token comment"># clip bounding box</span>
            cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># 对于分类得分roi_scores，我们需要将其经过softmax后转为概率prob。</span>
            <span class="token comment"># 值得注意的是我们此时得到的是对所有输入128个roi以及位置参数、得分</span>
            <span class="token comment"># 的预处理，下面将筛选出最后最终的预测结果。</span>
            prob <span class="token operator">=</span> at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>roi_score<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            raw_cls_bbox <span class="token operator">=</span> at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>cls_bbox<span class="token punctuation">)</span>
            raw_prob <span class="token operator">=</span> at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>prob<span class="token punctuation">)</span>

            bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> score <span class="token operator">=</span> self<span class="token punctuation">.</span>_suppress<span class="token punctuation">(</span>raw_cls_bbox<span class="token punctuation">,</span> raw_prob<span class="token punctuation">)</span>
            bboxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>bbox<span class="token punctuation">)</span>
            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
            scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>use_preset<span class="token punctuation">(</span><span class="token string">'evaluate'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> bboxes<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> scores</code></pre>
<p><strong>「注意！」</strong> 训练完<code>train_datasets</code>之后，<code>model</code>要来测试样本了。在<code>model(test_datasets)</code>之前，需要加上<code>model.eval()</code>。否则的话，有输入数据，即使不训练，它也会改变权值。这是<code>model</code>中含有<code>batch normalization</code>层所带来的的性质。</p>
<p>所以我们看到在第一行使用了<code>self.eval()</code>，那么为什么在最后一行函数返回<code>bboxes</code>，<code>labels</code>，<code>scores</code>之后还要加一行<code>self.train</code>呢？这是因为这次预测之后下次要接着训练，训练的时候需要设置模型类型为<code>train</code>。</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193707.png" srcset="/img/loading.gif" alt="model.train和model.eval受到网络里面BN和Dropout的影响"></p>
<p>上面的步骤是对网络RoIhead网络输出的预处理，函数<code>_suppress</code>将得到真正的预测结果。<code>_suppress</code>函数解释如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># predict函数是对网络RoIhead网络输出的预处理</span>
    <span class="token comment"># 函数_suppress将得到真正的预测结果。</span>
    <span class="token comment"># 此函数是一个按类别的循环，l从1至20（0类为背景类）。</span>
    <span class="token comment"># 即预测思想是按20个类别顺序依次验证，如果有满足该类的预测结果，</span>
    <span class="token comment"># 则记录，否则转入下一类（一张图中也就几个类别而已）。例如筛选</span>
    <span class="token comment"># 预测出第1类的结果，首先在cls_bbox中将所有128个预测第1类的</span>
    <span class="token comment"># bbox坐标找出，然后从prob中找出128个第1类的概率。因为阈值为0.7，</span>
    <span class="token comment"># 也即概率>0.7的所有边框初步被判定预测正确，记录下来。然而可能有</span>
    <span class="token comment"># 多个边框预测第1类中同一个物体，同类中一个物体只需一个边框，</span>
    <span class="token comment"># 所以需再经基于类的NMS后使得每类每个物体只有一个边框，至此</span>
    <span class="token comment"># 第1类预测完成，记录第1类的所有边框坐标、标签、置信度。</span>
    <span class="token comment"># 接着下一类...，直至20类都记录下来，那么一张图片（也即一个batch）</span>
    <span class="token comment"># 的预测也就结束了。</span>
    <span class="token keyword">def</span> <span class="token function">_suppress</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_cls_bbox<span class="token punctuation">,</span> raw_prob<span class="token punctuation">)</span><span class="token punctuation">:</span>
        bbox <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        score <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># skip cls_id = 0 because it is the background class</span>
        <span class="token keyword">for</span> l <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class<span class="token punctuation">)</span><span class="token punctuation">:</span>
            cls_bbox_l <span class="token operator">=</span> raw_cls_bbox<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            prob_l <span class="token operator">=</span> raw_prob<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> l<span class="token punctuation">]</span>
            mask <span class="token operator">=</span> prob_l <span class="token operator">></span> self<span class="token punctuation">.</span>score_thresh
            cls_bbox_l <span class="token operator">=</span> cls_bbox_l<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
            prob_l <span class="token operator">=</span> prob_l<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
            keep <span class="token operator">=</span> non_maximum_suppression<span class="token punctuation">(</span>
                cp<span class="token punctuation">.</span>array<span class="token punctuation">(</span>cls_bbox_l<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nms_thresh<span class="token punctuation">,</span> prob_l<span class="token punctuation">)</span>
            keep <span class="token operator">=</span> cp<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span>keep<span class="token punctuation">)</span>
            bbox<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls_bbox_l<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># The labels are in [0, self.n_class - 2].</span>
            label<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>keep<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            score<span class="token punctuation">.</span>append<span class="token punctuation">(</span>prob_l<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">)</span>
        bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        label <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>label<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
        score <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>score<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> score</code></pre>
<p>这里还定义了优化器optimizer，对于需要求导的参数 按照是否含bias赋予不同的学习率。默认是使用SGD，可选Adam，不过需更小的学习率。代码如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># 定义了优化器optimizer，对于需要求导的参数 按照是否含bias赋予不同的学习率。</span>
    <span class="token comment"># 默认是使用SGD，可选Adam，不过需更小的学习率。</span>
    <span class="token keyword">def</span> <span class="token function">get_optimizer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        return optimizer, It could be overwriten if you want to specify 
        special optimizer
        """</span>
        lr <span class="token operator">=</span> opt<span class="token punctuation">.</span>lr
        params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> value<span class="token punctuation">.</span>requires_grad<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token string">'bias'</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
                    params <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'params'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'lr'</span><span class="token punctuation">:</span> lr <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    params <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'params'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'lr'</span><span class="token punctuation">:</span> lr<span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> opt<span class="token punctuation">.</span>weight_decay<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>use_adam<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> t<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> t<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>params<span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>optimizer

    <span class="token keyword">def</span> <span class="token function">scale_lr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decay<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> param_group <span class="token keyword">in</span> self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
            param_group<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> decay
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>optimizer</code></pre>
<p>解释完了这个基类，我们来看看这份代码里面实现的基于VGG16的Faster RCNN的这个类<code>FasterRCNNVGG16</code>，它继承了<strong>「FasterRCNN」</strong>。</p>
<p>首先引入VGG16，然后拆分为特征提取网络和分类网络。冻结分类网络的前几层，不进行反向传播。</p>
<p>然后实现<strong>「VGG16RoIHead」</strong>网络。实现输入特征图、<code>rois</code>、<code>roi_indices</code>,输出<code>roi_cls_locs</code>和<code>roi_scores</code>。</p>
<p>类<code>FasterRCNNVGG16</code>分别对VGG16的特征提取部分、分类部分、RPN网络、VGG16RoIHead网络进行了实例化。</p>
<p>此外在对VGG16RoIHead网络的全连接层权重初始化过程中，按照图像是否为<code>truncated</code>（截断）分了两种初始化分方法，至于这个截断具体有什么用呢，也不是很明白这里似乎也没用。</p>
<p>详细解释如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">decom_vgg16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># the 30th layer of features is relu of conv5_3</span>
    <span class="token comment"># 是否使用Caffe下载下来的预训练模型</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>caffe_pretrain<span class="token punctuation">:</span>
        model <span class="token operator">=</span> vgg16<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>load_path<span class="token punctuation">:</span>
            <span class="token comment"># 加载参数信息</span>
            model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>t<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>caffe_pretrain_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> vgg16<span class="token punctuation">(</span><span class="token keyword">not</span> opt<span class="token punctuation">.</span>load_path<span class="token punctuation">)</span>

    <span class="token comment"># 加载预训练模型vgg16的conv5_3之前的部分</span>
    features <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>features<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">]</span>

    classifier <span class="token operator">=</span> model<span class="token punctuation">.</span>classifier
    <span class="token comment"># 分类部分放到一个list里面</span>
    classifier <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>classifier<span class="token punctuation">)</span>
    <span class="token comment"># 删除输出分类结果层</span>
    <span class="token keyword">del</span> classifier<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
    <span class="token comment"># 删除两个dropout</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>use_drop<span class="token punctuation">:</span>
        <span class="token keyword">del</span> classifier<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> classifier<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>classifier<span class="token punctuation">)</span>

    <span class="token comment"># 冻结vgg16前2个stage,不进行反向传播</span>
    <span class="token keyword">for</span> layer <span class="token keyword">in</span> features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> p <span class="token keyword">in</span> layer<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            p<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token comment"># 拆分为特征提取网络和分类网络</span>
    <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>features<span class="token punctuation">)</span><span class="token punctuation">,</span> classifier


<span class="token comment"># 分别对特征VGG16的特征提取部分、分类部分、RPN网络、</span>
<span class="token comment"># VGG16RoIHead网络进行了实例化</span>
<span class="token keyword">class</span> <span class="token class-name">FasterRCNNVGG16</span><span class="token punctuation">(</span>FasterRCNN<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># vgg16通过5个stage下采样16倍</span>
    feat_stride <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># downsample 16x for output of conv5 in vgg16</span>
    <span class="token comment"># 总类别数为20类，三种尺度三种比例的anchor</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 n_fg_class<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
                 ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 anchor_scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token comment"># conv5_3及之前的部分，分类器</span>
        extractor<span class="token punctuation">,</span> classifier <span class="token operator">=</span> decom_vgg16<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 返回rpn_locs, rpn_scores, rois, roi_indices, anchor</span>
        rpn <span class="token operator">=</span> RegionProposalNetwork<span class="token punctuation">(</span>
            <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span>
            ratios<span class="token operator">=</span>ratios<span class="token punctuation">,</span>
            anchor_scales<span class="token operator">=</span>anchor_scales<span class="token punctuation">,</span>
            feat_stride<span class="token operator">=</span>self<span class="token punctuation">.</span>feat_stride<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment"># 下面讲</span>
        head <span class="token operator">=</span> VGG16RoIHead<span class="token punctuation">(</span>
            n_class<span class="token operator">=</span>n_fg_class <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
            roi_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>
            spatial_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>feat_stride<span class="token punctuation">)</span><span class="token punctuation">,</span>
            classifier<span class="token operator">=</span>classifier
        <span class="token punctuation">)</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNNVGG16<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
            extractor<span class="token punctuation">,</span>
            rpn<span class="token punctuation">,</span>
            head<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">VGG16RoIHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n_class<span class="token punctuation">,</span> roi_size<span class="token punctuation">,</span> spatial_scale<span class="token punctuation">,</span>
                 classifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># n_class includes the background</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>VGG16RoIHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># vgg16中的最后两个全连接层</span>
        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> classifier 
        self<span class="token punctuation">.</span>cls_loc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> n_class <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> n_class<span class="token punctuation">)</span>
        <span class="token comment"># 全连接层权重初始化</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cls_loc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
        <span class="token comment"># 加上背景21类</span>
        self<span class="token punctuation">.</span>n_class <span class="token operator">=</span> n_class
        <span class="token comment"># 7x7</span>
        self<span class="token punctuation">.</span>roi_size <span class="token operator">=</span> roi_size
        <span class="token comment"># 1/16</span>
        self<span class="token punctuation">.</span>spatial_scale <span class="token operator">=</span> spatial_scale
        <span class="token comment"># 将大小不同的roi变成大小一致，得到pooling后的特征，</span>
        <span class="token comment"># 大小为[300, 512, 7, 7]。利用Cupy实现在线编译的</span>
        self<span class="token punctuation">.</span>roi <span class="token operator">=</span> RoIPooling2D<span class="token punctuation">(</span>self<span class="token punctuation">.</span>roi_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>roi_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>spatial_scale<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 前面解释过这里的roi_indices其实是多余的，因为batch_size一直为1</span>
        <span class="token comment"># in case roi_indices is  ndarray</span>
        roi_indices <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>roi_indices<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#ndarray->tensor</span>
        rois <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>rois<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        indices_and_rois <span class="token operator">=</span> t<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>roi_indices<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rois<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># NOTE: important: yx->xy</span>
        xy_indices_and_rois <span class="token operator">=</span> indices_and_rois<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment"># 把tensor变成在内存中连续分布的形式</span>
        indices_and_rois <span class="token operator">=</span>  xy_indices_and_rois<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 接下来分析roi_module.py中的RoI（）</span>
        pool <span class="token operator">=</span> self<span class="token punctuation">.</span>roi<span class="token punctuation">(</span>x<span class="token punctuation">,</span> indices_and_rois<span class="token punctuation">)</span>
        <span class="token comment"># flat操作</span>
        pool <span class="token operator">=</span> pool<span class="token punctuation">.</span>view<span class="token punctuation">(</span>pool<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># decom_vgg16（）得到的calssifier,得到4096</span>
        fc7 <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>pool<span class="token punctuation">)</span>
        <span class="token comment"># （4096->84）</span>
        roi_cls_locs <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_loc<span class="token punctuation">(</span>fc7<span class="token punctuation">)</span>
        <span class="token comment"># （4096->21）</span>
        roi_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>score<span class="token punctuation">(</span>fc7<span class="token punctuation">)</span>
        <span class="token keyword">return</span> roi_cls_locs<span class="token punctuation">,</span> roi_scores


<span class="token keyword">def</span> <span class="token function">normal_init</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> mean<span class="token punctuation">,</span> stddev<span class="token punctuation">,</span> truncated<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    weight initalizer: truncated normal and random normal.
    """</span>
    <span class="token comment"># x is a parameter</span>
    <span class="token keyword">if</span> truncated<span class="token punctuation">:</span>
        m<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fmod_<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mul_<span class="token punctuation">(</span>stddev<span class="token punctuation">)</span><span class="token punctuation">.</span>add_<span class="token punctuation">(</span>mean<span class="token punctuation">)</span>  <span class="token comment"># not a perfect approximation</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        m<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>mean<span class="token punctuation">,</span> stddev<span class="token punctuation">)</span>
        m<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/">计算机视觉</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Faster-RCNN/">Faster RCNN</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/5e67f605/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Numpy.prod问题</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/17e7acb0/">
                        <span class="hidden-mobile">frp内网穿透搭建指南</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "ViwB1XmjsmmXpFx2gikUmM5V-gzGzoHsz",
          app_key: "7r6Y8CzBkl8MJwPNmCqSdLWW",
          placeholder: "来都来了，不说点什么吗⊙(・◇・)？",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: false,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-tags-fill"></i>&nbsp;<a href="http://www.beian.miit.gov.cn/" target="_blank">鲁ICP备19062448号</a>&nbsp&nbsp;| &nbsp&nbsp <i class="iconfont icon-addrcard"></i>&nbsp; 2018~2022<a href="https://www.jngwl.top/" target="_blank"> 清风与归_G</a>&nbsp&nbsp;|&nbsp&nbsp;  <i class="iconfont icon-docker"></i> <a href="https://hexo.io/" target="_blank">&nbsp Hexo</a>&nbsp & &nbsp <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank">Fluid</a><br> 你的骄傲多半来自于自己的无知，共勉之

  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  
    
  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>



  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
