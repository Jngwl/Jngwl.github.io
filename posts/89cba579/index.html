

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="æ¸…é£ä¸å½’_G">
  <meta name="keywords" content="">
  <title>Faster RCNNä»£ç è§£æ - æ¸…é£ä¸å½’_G</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      
        
          
          
          
        
        <link  rel="stylesheet" href="https://cdn.staticfile.org/prism/1.22.0/themes/prism-tomorrow.min.css" />
      
      
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.jngwl.top","root":"/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ViwB1XmjsmmXpFx2gikUmM5V-gzGzoHsz","app_key":"7r6Y8CzBkl8MJwPNmCqSdLWW","server_url":"https://viwb1xmj.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>æ¸…é£ä¸å½’_G</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20201121211851.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Faster RCNNä»£ç è§£æ">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-05-04 10:36" pubdate>
        2020å¹´5æœˆ4æ—¥ ä¸Šåˆ
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      12.2k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      167
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Faster RCNNä»£ç è§£æ</h1>
            
              <p class="note note-info">
                
                  æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2021å¹´1æœˆ8æ—¥ æ™šä¸Š
                
              </p>
            
            <div class="markdown-body">
              <blockquote>
<p>æœ¬æ–‡è½¬è½½è‡ª<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/jhsXSr8xX8YvBK4jIpgX-g">GiantPandaCV</a>ï¼Œæ„Ÿè°¢æ•´ç†åˆ†äº«ã€‚</p>
</blockquote>
<h2 id="ğŸ“–-Faster-RCNNæ•´ä½“ç»“æ„"><a href="#ğŸ“–-Faster-RCNNæ•´ä½“ç»“æ„" class="headerlink" title="ğŸ“– Faster RCNNæ•´ä½“ç»“æ„"></a>ğŸ“– Faster RCNNæ•´ä½“ç»“æ„</h2><p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200504133455.png" srcset="/img/loading.gif" alt="Faster RCNN æ•´ä½“ç»“æ„"></p>
<p>Faster RCNNå¤§æ¦‚å¯ä»¥åˆ†æˆç»¿è‰²æè¿°çš„ä¸ªéƒ¨åˆ†ï¼Œå³ï¼š</p>
<ul>
<li><code>DataSet</code>ï¼šä»£è¡¨æ•°æ®é›†ï¼Œå…¸å‹çš„æ¯”å¦‚VOCå’ŒCOCOã€‚</li>
<li><code>Extrator</code>ï¼šç‰¹å¾æå–å™¨ï¼Œä¹Ÿå³æ˜¯æˆ‘ä»¬å¸¸è¯´çš„Backboneç½‘ç»œï¼Œå…¸å‹çš„æœ‰VGGå’ŒResNetã€‚</li>
<li><code>RPN</code>ï¼šå…¨ç§°Region Proposal Networkï¼Œè´Ÿè´£äº§ç”Ÿå€™é€‰åŒºåŸŸ(<code>rois</code>)ï¼Œæ¯å¼ å›¾å¤§æ¦‚ç»™å‡º2000ä¸ªå€™é€‰æ¡†ã€‚</li>
<li><code>RoIHead</code>ï¼šè´Ÿè´£å¯¹<code>rois</code>è¿›è¡Œåˆ†ç±»å’Œå›å½’å¾®è°ƒã€‚</li>
</ul>
<p>æ‰€ä»¥Faster RCNNçš„æµç¨‹å¯ä»¥æ€»ç»“ä¸ºï¼š</p>
<p><strong>åŸå§‹å›¾åƒ</strong>â€”-&gt;<strong>ç‰¹å¾æå–</strong>â€”â€”â€”&gt;<strong>RPNäº§ç”Ÿå€™é€‰æ¡†</strong>â€”â€”â€”&gt;<strong>å¯¹å€™é€‰æ¡†è¿›è¡Œåˆ†ç±»å’Œå›å½’å¾®è°ƒ</strong>ã€‚</p>
<h2 id="ğŸ”-Faster-RCNNçš„å››ä¸ªæ¨¡å—"><a href="#ğŸ”-Faster-RCNNçš„å››ä¸ªæ¨¡å—" class="headerlink" title="ğŸ” Faster RCNNçš„å››ä¸ªæ¨¡å—"></a>ğŸ” Faster RCNNçš„å››ä¸ªæ¨¡å—</h2><p>Faster R-CNNæ˜¯ç›®æ ‡æ£€æµ‹ä¸­è¾ƒæ—©æå‡ºæ¥çš„ä¸¤é˜¶æ®µç½‘ç»œï¼Œå…¶ç½‘ç»œæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505143105.png" srcset="/img/loading.gif" alt="Faster RCNN"></p>
<p>å¯ä»¥çœ‹å‡ºå¯ä»¥å¤§ä½“åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><code>Conv Layers</code> å·ç§¯ç¥ç»ç½‘ç»œç”¨äºæå–ç‰¹å¾ï¼Œå¾—åˆ°feature mapã€‚</li>
<li><code>RPN</code>ç½‘ç»œï¼Œç”¨äºæå–Region of Interests(RoI)ã€‚</li>
<li><code>RoI pooling</code>, ç”¨äºç»¼åˆRoIå’Œfeature map, å¾—åˆ°å›ºå®šå¤§å°çš„resizeåçš„featureã€‚</li>
<li><code>classifier</code>, ç”¨äºåˆ†ç±»RoIå±äºå“ªä¸ªç±»åˆ«ã€‚</li>
</ol>
<h3 id="1-Conv-Layers"><a href="#1-Conv-Layers" class="headerlink" title="1. Conv Layers"></a>1. Conv Layers</h3><p>åœ¨Conv Layersä¸­ï¼Œå¯¹è¾“å…¥çš„å›¾ç‰‡è¿›è¡Œå·ç§¯å’Œæ± åŒ–ï¼Œç”¨äºæå–å›¾ç‰‡ç‰¹å¾ï¼Œæœ€ç»ˆå¸Œæœ›å¾—åˆ°çš„æ˜¯feature mapã€‚åœ¨Faster R-CNNä¸­ï¼Œå…ˆå°†å›¾ç‰‡Resizeåˆ°å›ºå®šå°ºå¯¸ï¼Œç„¶åä½¿ç”¨äº†VGG16ä¸­çš„13ä¸ªå·ç§¯å±‚ã€13ä¸ªReLUå±‚ã€4ä¸ªmanpoolingå±‚ã€‚ï¼ˆVGG16ä¸­è¿›è¡Œäº†5æ¬¡ä¸‹é‡‡æ ·ï¼Œè¿™é‡Œèˆå¼ƒäº†ç¬¬å››æ¬¡ä¸‹é‡‡æ ·åçš„éƒ¨åˆ†ï¼Œå°†å‰©ä¸‹éƒ¨åˆ†ä½œä¸ºConv Layeræå–ç‰¹å¾ã€‚ï¼‰</p>
<p>ä¸YOLOv3ä¸åŒï¼ŒFaster R-CNNä¸‹é‡‡æ ·åçš„åˆ†è¾¨ç‡ä¸ºåŸå§‹å›¾ç‰‡åˆ†è¾¨ç‡çš„1/16ï¼ˆYOLOv3æ˜¯å˜ä¸ºåŸæ¥çš„1/32ï¼‰ã€‚feature mapçš„åˆ†è¾¨ç‡è¦æ¯”YOLOv3çš„Backboneå¾—åˆ°çš„åˆ†è¾¨ç‡è¦å¤§ï¼Œè¿™ä¹Ÿå¯ä»¥è§£é‡Šä¸ºä½•Faster R-CNNåœ¨å°ç›®æ ‡ä¸Šçš„æ£€æµ‹æ•ˆæœè¦ä¼˜äºYOLOv3ã€‚</p>
<h3 id="2-Region-Proposal-Network"><a href="#2-Region-Proposal-Network" class="headerlink" title="2. Region Proposal Network"></a>2. Region Proposal Network</h3><p>ç®€ç§°RPNç½‘ç»œï¼Œç”¨äºæ¨èå€™é€‰åŒºåŸŸï¼ˆRegion of Interestsï¼‰ï¼Œæ¥å—çš„è¾“å…¥ä¸ºåŸå›¾ç‰‡ç»è¿‡Conv Layeråå¾—åˆ°çš„feature mapã€‚</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505185813.jpg" srcset="/img/loading.gif" alt="RPN"></p>
<p>ä¸Šå›¾å‚è€ƒçš„å®ç°æ˜¯ï¼š<a target="_blank" rel="noopener" href="https://github.com/ruotianluo/pytorch-faster-rcnn">https://github.com/ruotianluo/pytorch-faster-rcnn</a></p>
<p>RPNç½‘ç»œå°†feature mapä½œä¸ºè¾“å…¥ï¼Œç„¶åç”¨äº†ä¸€ä¸ª3x3å·ç§¯å°†filterå‡åŠä¸º512,ç„¶åè¿›å…¥ä¸¤ä¸ªåˆ†æ”¯ï¼š</p>
<p>ä¸€ä¸ªåˆ†æ”¯ç”¨äºè®¡ç®—å¯¹åº”anchorçš„foregroundå’Œbackgroundçš„æ¦‚ç‡ï¼Œç›®æ ‡æ˜¯foregroundã€‚</p>
<p>ä¸€ä¸ªåˆ†æ”¯ç”¨äºè®¡ç®—å¯¹åº”anchorçš„Bounding boxçš„åç§»é‡ï¼Œæ¥è·å¾—å…¶ç›®æ ‡çš„å®šä½ã€‚</p>
<p>é€šè¿‡RPNç½‘ç»œï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æ¯ä¸ªanchoræ˜¯å¦å«æœ‰ç›®æ ‡å’Œåœ¨å«æœ‰ç›®æ ‡æƒ…å†µä¸‹ç›®æ ‡çš„ä½ç½®ä¿¡æ¯ã€‚</p>
<p><strong>å¯¹æ¯”RPNå’ŒYOLOv3:</strong></p>
<p><strong>RPN:</strong> åˆ†ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸€ä¸ªåˆ†æ”¯é¢„æµ‹ç›®æ ‡æ¡†ï¼Œä¸€ä¸ªåˆ†æ”¯é¢„æµ‹å‰æ™¯æˆ–è€…èƒŒæ™¯ã€‚å°†ä¸¤ä¸ªå·¥ä½œåˆ†å¼€æ¥åšçš„ï¼Œå¹¶ä¸”å…¶ä¸­å‰æ™¯èƒŒæ™¯é¢„æµ‹åˆ†æ”¯åŠŸèƒ½æ˜¯åˆ¤æ–­è¿™ä¸ªanchoræ˜¯å¦å«æœ‰ç›®æ ‡ï¼Œå¹¶ä¸ä¼šå¯¹ç›®æ ‡è¿›è¡Œåˆ†ç±»ã€‚å¦å¤–å°±æ˜¯anchorçš„è®¾ç½®æ˜¯é€šè¿‡å…ˆéªŒå¾—åˆ°çš„ã€‚</p>
<p><strong>YOLOv3</strong>: å°†æ•´ä¸ªé—®é¢˜å½“åšå›å½’é—®é¢˜ï¼Œç›´æ¥å°±å¯ä»¥è·å–ç›®æ ‡ç±»åˆ«å’Œåæ ‡ã€‚Anchoræ˜¯é€šè¿‡IoUèšç±»å¾—åˆ°çš„ã€‚</p>
<p><strong>åŒºåˆ«</strong>ï¼šAnchorçš„è®¾ç½®ï¼ŒGround truthå’ŒAnchorçš„åŒ¹é…ç»†èŠ‚ä¸ä¸€æ ·ã€‚</p>
<p><strong>è”ç³»</strong>ï¼šä¸¤ä¸ªéƒ½æ˜¯åœ¨æœ€åçš„feature mapï¼ˆw/16,h/16æˆ–è€…w/32ï¼Œh/32ï¼‰ä¸Šæ¯ä¸ªç‚¹éƒ½åˆ†é…äº†å¤šä¸ªanchorï¼Œç„¶åè¿›è¡ŒåŒ¹é…ã€‚è™½ç„¶å…·ä½“å®ç°æœ‰è¾ƒå¤§çš„å·®è·ï¼Œä½†æ˜¯è¿™ä¸ªæƒ³æ³•æœ‰å…±åŒç‚¹ã€‚</p>
<h3 id="3-ROI-Pooling"><a href="#3-ROI-Pooling" class="headerlink" title="3. ROI Pooling"></a>3. ROI Pooling</h3><p>è¿™é‡Œçœ‹ä¸€ä¸ªæ¥è‡ªdeepsense.aiæä¾›çš„ä¾‹å­ï¼š</p>
<p>RoI Poolingè¾“å…¥æ˜¯feature mapå’ŒRoIsï¼š</p>
<p>å‡è®¾feature mapæ˜¯å¦‚ä¸‹å†…å®¹ï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505185929.jpg" srcset="/img/loading.gif" alt="feature map"></p>
<p>RPNæä¾›çš„å…¶ä¸­ä¸€ä¸ªRoIä¸ºï¼šå·¦ä¸Šè§’åæ ‡ï¼ˆ0,3)ï¼Œå³ä¸‹è§’åæ ‡ï¼ˆ7,8ï¼‰</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190009.jpg" srcset="/img/loading.gif" alt="roi"></p>
<p>ç„¶åå°†RoIå¯¹åº”åˆ°feature mapä¸Šçš„éƒ¨åˆ†åˆ‡å‰²ä¸º2x2å¤§å°çš„å—ï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190042.jpg" srcset="/img/loading.gif" alt="åˆ†å—"></p>
<p>å°†æ¯ä¸ªå—åšç±»ä¼¼max poolingçš„æ“ä½œï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190101.png" srcset="/img/loading.gif" alt="max pooling"></p>
<p>ä»¥ä¸Šå°±æ˜¯ROI poolingçš„å®Œæ•´æ“ä½œï¼Œæƒ³ä¸€æƒ³<strong>ä¸ºä½•è¦è¿™æ ·åš</strong>ï¼Ÿ</p>
<ul>
<li>ä¿è¯æ— è®ºè¾“å…¥ç‰¹å¾å›¾å°ºå¯¸å¦‚ä½•ï¼Œè¾“å…¥åˆ°åç»­å…¨è¿æ¥å±‚çš„ç‰¹å¾å›¾å°ºå¯¸å›ºå®šï¼Œé¿å…å› å›¾åƒè£å‰ªç­‰é€ æˆåƒç´ ç¼ºå¤±ã€‚</li>
<li>è¾“å…¥ç‰¹å¾å›¾å°ºå¯¸ä¸ºMÃ—Nï¼ŒROIæ± åŒ–å±‚å…ˆå°†å…¶æ˜ å°„ä¸ºM/16Ã—N/16ï¼Œç»“åˆROIè·å¾—åŸå§‹ç‰¹å¾å›¾çš„åŒºåŸŸå»ºè®®åæ ‡ï¼Œç„¶åå°†è¯¥åŒºåŸŸåˆ†å—ï¼Œåˆ†åˆ«è¿›è¡Œmax poolingï¼Œå¾—åˆ°æœ€ç»ˆçš„åŒºåŸŸå»ºè®®</li>
</ul>
<p>åœ¨RPNé˜¶æ®µï¼Œæˆ‘ä»¬å¾—çŸ¥äº†å½“å‰å›¾ç‰‡æ˜¯å¦æœ‰ç›®æ ‡ï¼Œåœ¨æœ‰ç›®æ ‡æƒ…å†µä¸‹ç›®æ ‡çš„ä½ç½®ã€‚ç°åœ¨å”¯ä¸€ç¼ºå°‘çš„ä¿¡æ¯å°±æ˜¯è¿™ä¸ªç›®æ ‡åˆ°åº•å±äºå“ªä¸ªç±»åˆ«ï¼ˆé€šè¿‡RPNåªèƒ½å¾—çŸ¥è¿™ä¸ªç›®æ ‡å±äºå‰æ™¯ï¼Œä½†å¹¶ä¸èƒ½å¾—åˆ°å…·ä½“ç±»åˆ«ï¼‰ã€‚</p>
<p>å¦‚æœæƒ³è¦å¾—çŸ¥è¿™ä¸ªç›®æ ‡å±äºå“ªä¸ªç±»åˆ«ï¼Œæœ€ç®€å•çš„æƒ³æ³•å°±æ˜¯å°†å¾—åˆ°çš„æ¡†å†…çš„å›¾ç‰‡æ”¾å…¥ä¸€ä¸ªCNNè¿›è¡Œåˆ†ç±»ï¼Œå¾—åˆ°æœ€ç»ˆç±»åˆ«ã€‚è¿™å°±æ¶‰åŠåˆ°æœ€åä¸€ä¸ªæ¨¡å—ï¼šclassification</p>
<h3 id="4-Classification"><a href="#4-Classification" class="headerlink" title="4. Classification"></a>4. Classification</h3><p>ROI Poolingåå¾—åˆ°çš„æ˜¯å¤§å°ä¸€è‡´çš„feature mapï¼Œç„¶ååˆ†ä¸ºä¸¤ä¸ªåˆ†æ”¯ï¼Œé ä¸‹çš„ä¸€ä¸ªåˆ†æ”¯å»è¿›è¡Œåˆ†ç±»ï¼Œä¸Šä¸€ä¸ªåˆ†æ”¯æ˜¯ç”¨äºBounding boxå›å½’ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæ¥è‡ªçŸ¥ä¹ï¼‰ï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505190124.jpg" srcset="/img/loading.gif" alt="åˆ†ç±»"></p>
<p>åˆ†ç±»è¿™ä¸ªåˆ†æ”¯å¾ˆå®¹æ˜“ç†è§£ï¼Œç”¨äºè®¡ç®—åˆ°åº•å±äºå“ªä¸ªç±»åˆ«ã€‚Bounding boxå›å½’çš„åˆ†æ”¯ç”¨äºè°ƒæ•´RPNé¢„æµ‹å¾—åˆ°çš„Bounding boxï¼Œè®©å›å½’çš„ç»“æœæ›´åŠ ç²¾ç¡®ã€‚</p>
<h2 id="â›³-æ•°æ®é¢„å¤„ç†åŠå®ç°ç»†èŠ‚"><a href="#â›³-æ•°æ®é¢„å¤„ç†åŠå®ç°ç»†èŠ‚" class="headerlink" title="â›³ æ•°æ®é¢„å¤„ç†åŠå®ç°ç»†èŠ‚"></a>â›³ æ•°æ®é¢„å¤„ç†åŠå®ç°ç»†èŠ‚</h2><p>é¦–å…ˆè®©æˆ‘ä»¬è¿›å…¥åˆ°è¿™ä¸ªPytorchçš„Faster RCNNå·¥ç¨‹ï¼š<code>https://github.com/chenyuntc/simple-faster-rcnn-pytorch</code>ã€‚æ•°æ®é¢„å¤„ç†çš„ç›¸å…³ç»†èŠ‚éƒ½åœ¨<code>data</code>è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ï¼Œå®ç°æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200504111632.png" srcset="/img/loading.gif" alt="Faster RCNNé¢„å¤„ç†æµç¨‹å›¾ï¼Œmade by BBuf"></p>
<h3 id="data-dataset-py"><a href="#data-dataset-py" class="headerlink" title="data/dataset.py"></a>data/dataset.py</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># å»æ­£åˆ™åŒ–,imgç»´åº¦ä¸º[[B,G,R],H,W],å› ä¸ºcaffeé¢„è®­ç»ƒæ¨¡å‹è¾“å…¥ä¸ºBGR 0-255å›¾ç‰‡ï¼Œpytorché¢„è®­ç»ƒæ¨¡å‹é‡‡ç”¨RGB 0-1å›¾ç‰‡</span>
<span class="token keyword">def</span> <span class="token function">inverse_normalize</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>caffe_pretrain<span class="token punctuation">:</span>
        <span class="token comment"># [122.7717, 115.9465, 102.9801]reshapeä¸º[3,1,1]ä¸imgç»´åº¦ç›¸åŒå°±å¯ä»¥ç›¸åŠ äº†ï¼Œ</span>
        <span class="token comment"># pytorch_normalizeä¹‹å‰æœ‰å‡å‡å€¼é¢„å¤„ç†ï¼Œç°åœ¨è¿˜åŸå›å»ã€‚</span>
        img <span class="token operator">=</span> img <span class="token operator">+</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">122.7717</span><span class="token punctuation">,</span> <span class="token number">115.9465</span><span class="token punctuation">,</span> <span class="token number">102.9801</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># å°†BGRè½¬æ¢ä¸ºRGBå›¾ç‰‡ï¼ˆpython [::-1]ä¸ºé€†åºè¾“å‡ºï¼‰</span>
        <span class="token keyword">return</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token comment"># pytorch_normalzeä¸­æ ‡å‡†åŒ–ä¸º å‡å‡å€¼é™¤ä»¥æ ‡å‡†å·®ï¼Œç°åœ¨ä¹˜ä»¥æ ‡å‡†å·®åŠ ä¸Šå‡å€¼è¿˜åŸå›å»ï¼Œè½¬æ¢ä¸º0-255</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>img <span class="token operator">*</span> <span class="token number">0.225</span> <span class="token operator">+</span> <span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span>

<span class="token comment"># é‡‡ç”¨pytorché¢„è®­ç»ƒæ¨¡å‹å¯¹å›¾ç‰‡é¢„å¤„ç†(å½’ä¸€åŒ–)ï¼Œå‡½æ•°è¾“å…¥çš„imgä¸º 0~1</span>
<span class="token comment"># å‡½æ•°è¾“å‡ºä¸º -1~1ï¼ŒRGBï¼Œå‡å»å‡å€¼å†é™¤ä»¥æ ‡å‡†å·®</span>
<span class="token keyword">def</span> <span class="token function">pytorch_normalze</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    https://github.com/pytorch/vision/issues/223
    return appr -1~1 RGB
    """</span>
    <span class="token comment"># #transforms.Normalizeä½¿ç”¨å¦‚ä¸‹å…¬å¼è¿›è¡Œå½’ä¸€åŒ–</span>
    <span class="token comment"># channel=ï¼ˆchannel-meanï¼‰/std,è½¬æ¢ä¸º[-1,1]</span>
    normalize <span class="token operator">=</span> tvtsf<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># nddarry->Tensor</span>
    img <span class="token operator">=</span> normalize<span class="token punctuation">(</span>t<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> img<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># é‡‡ç”¨caffeé¢„è®­ç»ƒæ¨¡å‹æ—¶å¯¹è¾“å…¥å›¾åƒè¿›è¡Œæ ‡å‡†åŒ–ï¼Œå‡½æ•°è¾“å…¥çš„imgä¸º 0~1</span>
<span class="token comment"># å‡½æ•°è¾“å‡ºä¸º -125~125ï¼ŒBGRï¼Œåªå‡äº†å‡å€¼ï¼Œæœªé™¤æ ‡å‡†å·®</span>
<span class="token keyword">def</span> <span class="token function">caffe_normalize</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    return appr -125-125 BGR
    """</span>
    <span class="token comment"># RGB-BGR</span>
    img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># RGB-BGR</span>
    img <span class="token operator">=</span> img <span class="token operator">*</span> <span class="token number">255</span>
    <span class="token comment"># è½¬æ¢ä¸ºä¸imgç»´åº¦ç›¸åŒ</span>
    mean <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">122.7717</span><span class="token punctuation">,</span> <span class="token number">115.9465</span><span class="token punctuation">,</span> <span class="token number">102.9801</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># å‡å‡å€¼æ“ä½œ</span>
    img <span class="token operator">=</span> <span class="token punctuation">(</span>img <span class="token operator">-</span> mean<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> copy<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> img

<span class="token comment"># å‡½æ•°è¾“å…¥çš„imgä¸º0-255</span>
<span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> min_size<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># å›¾ç‰‡è¿›è¡Œç¼©æ”¾ï¼Œä½¿å¾—é•¿è¾¹å°äºç­‰äº1000ï¼ŒçŸ­è¾¹å°äºç­‰äº600ï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªç­‰äºï¼‰ã€‚</span>
    <span class="token comment"># å¯¹ç›¸åº”çš„bounding boxes ä¹Ÿä¹Ÿè¿›è¡ŒåŒç­‰å°ºåº¦çš„ç¼©æ”¾ã€‚</span>
    C<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
    scale1 <span class="token operator">=</span> min_size <span class="token operator">/</span> <span class="token builtin">min</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">)</span>
    scale2 <span class="token operator">=</span> max_size <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">)</span>
    <span class="token comment"># é€‰å°çš„æ¯”ä¾‹ï¼Œè¿™æ ·é•¿å’Œå®½éƒ½èƒ½æ”¾ç¼©åˆ°è§„å®šçš„å°ºå¯¸</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>scale1<span class="token punctuation">,</span> scale2<span class="token punctuation">)</span>
    img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">.</span>
    <span class="token comment"># resizeåˆ°ï¼ˆH * scale, W * scaleï¼‰å¤§å°ï¼Œanti_aliasingä¸ºæ˜¯å¦é‡‡ç”¨é«˜æ–¯æ»¤æ³¢</span>
    img <span class="token operator">=</span> sktsf<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> H <span class="token operator">*</span> scale<span class="token punctuation">,</span> W <span class="token operator">*</span> scale<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'reflect'</span><span class="token punctuation">,</span>anti_aliasing<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment">#è°ƒç”¨pytorch_normalzeæˆ–è€…caffe_normalzeå¯¹å›¾åƒè¿›è¡Œæ­£åˆ™åŒ–ï¼Œè¾“å…¥ä¸º0~1</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>caffe_pretrain<span class="token punctuation">:</span>
        normalize <span class="token operator">=</span> caffe_normalize
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        normalize <span class="token operator">=</span> pytorch_normalze
    <span class="token keyword">return</span> normalize<span class="token punctuation">(</span>img<span class="token punctuation">)</span>

<span class="token comment"># å¯¹åŸå›¾å’Œbboxè¿›è¡Œç¼©æ”¾ã€éšæœºç¿»è½¬</span>
<span class="token keyword">class</span> <span class="token class-name">Transform</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> min_size<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>min_size <span class="token operator">=</span> min_size
        self<span class="token punctuation">.</span>max_size <span class="token operator">=</span> max_size

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label <span class="token operator">=</span> in_data
        _<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
        <span class="token comment"># è°ƒç”¨å‰é¢å®šä¹‰çš„preprocesså‡½æ•°è¿›è¡Œå›¾åƒç­‰æ¯”ä¾‹ç¼©æ”¾</span>
        img <span class="token operator">=</span> preprocess<span class="token punctuation">(</span>img<span class="token punctuation">,</span> self<span class="token punctuation">.</span>min_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span>
        _<span class="token punctuation">,</span> o_H<span class="token punctuation">,</span> o_W <span class="token operator">=</span> img<span class="token punctuation">.</span>shape
        <span class="token comment"># å¾—å‡ºç¼©æ”¾æ¯”å› å­</span>
        scale <span class="token operator">=</span> o_H <span class="token operator">/</span> H
        <span class="token comment"># bboxæŒ‰ç…§ä¸åŸå›¾ç­‰æ¯”ä¾‹ç¼©æ”¾</span>
        bbox <span class="token operator">=</span> util<span class="token punctuation">.</span>resize_bbox<span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> <span class="token punctuation">(</span>H<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>o_H<span class="token punctuation">,</span> o_W<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># å°†å›¾ç‰‡è¿›è¡Œéšæœºæ°´å¹³ç¿»è½¬ï¼Œæ²¡æœ‰è¿›è¡Œå‚ç›´ç¿»è½¬</span>
        img<span class="token punctuation">,</span> params <span class="token operator">=</span> util<span class="token punctuation">.</span>random_flip<span class="token punctuation">(</span>
            img<span class="token punctuation">,</span> x_random<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> return_param<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># åŒæ ·åœ°å°†bboxè¿›è¡Œä¸å¯¹åº”å›¾ç‰‡åŒæ ·çš„æ°´å¹³ç¿»è½¬</span>
        bbox <span class="token operator">=</span> util<span class="token punctuation">.</span>flip_bbox<span class="token punctuation">(</span>
            bbox<span class="token punctuation">,</span> <span class="token punctuation">(</span>o_H<span class="token punctuation">,</span> o_W<span class="token punctuation">)</span><span class="token punctuation">,</span> x_flip<span class="token operator">=</span>params<span class="token punctuation">[</span><span class="token string">'x_flip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> scale

<span class="token comment"># è®­ç»ƒé›†æ ·æœ¬çš„ç”Ÿæˆ</span>
<span class="token keyword">class</span> <span class="token class-name">Dataset</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>opt <span class="token operator">=</span> opt
         <span class="token comment"># å®ä¾‹åŒ– VOCBboxDataset ç±»</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> VOCBboxDataset<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>voc_data_dir<span class="token punctuation">)</span>
        <span class="token comment"># å®ä¾‹åŒ– Transform ç±»</span>
        self<span class="token punctuation">.</span>tsf <span class="token operator">=</span> Transform<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>min_size<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>max_size<span class="token punctuation">)</span>
        
    <span class="token comment"># __ xxx__è¿è¡ŒDatasetç±»æ—¶è‡ªåŠ¨è¿è¡Œ</span>
    
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># è°ƒç”¨VOCBboxDatasetä¸­çš„get_example()ä»æ•°æ®é›†å­˜å‚¨è·¯å¾„ä¸­å°†img, bbox, label, difficult ä¸€ä¸ªä¸ªçš„è·å–å‡ºæ¥</span>
        ori_img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_example<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        <span class="token comment"># è°ƒç”¨å‰é¢çš„Transformå‡½æ•°å°†å›¾ç‰‡,labelè¿›è¡Œæœ€å°å€¼æœ€å¤§å€¼æ”¾ç¼©å½’ä¸€åŒ–ï¼Œ</span>
        <span class="token comment"># é‡æ–°è°ƒæ•´bboxesçš„å¤§å°ï¼Œç„¶åéšæœºåè½¬ï¼Œæœ€åå°†æ•°æ®é›†è¿”å›</span>
        img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> scale <span class="token operator">=</span> self<span class="token punctuation">.</span>tsf<span class="token punctuation">(</span><span class="token punctuation">(</span>ori_img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># TODO: check whose stride is negative to fix this instead copy all</span>
        <span class="token comment"># some of the strides of a given numpy array are negative.</span>
        <span class="token keyword">return</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bbox<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> label<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scale

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">)</span>

<span class="token comment"># æµ‹è¯•é›†æ ·æœ¬çš„ç”Ÿæˆ</span>
<span class="token keyword">class</span> <span class="token class-name">TestDataset</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">,</span> use_difficult<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>opt <span class="token operator">=</span> opt
        <span class="token comment"># æ­¤å¤„è®¾ç½®äº†use_difficult,</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> VOCBboxDataset<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>voc_data_dir<span class="token punctuation">,</span> split<span class="token operator">=</span>split<span class="token punctuation">,</span> use_difficult<span class="token operator">=</span>use_difficult<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ori_img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_example<span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
        <span class="token comment"># å¯¹åŸå›¾è¿›è¡Œç¼©æ”¾</span>
        img <span class="token operator">=</span> preprocess<span class="token punctuation">(</span>ori_img<span class="token punctuation">)</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> ori_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">)</span></code></pre>
<h3 id="data-voc-dataset-py"><a href="#data-voc-dataset-py" class="headerlink" title="data/voc_dataset.py"></a>data/voc_dataset.py</h3><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">VOCBboxDataset</span><span class="token punctuation">:</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">'trainval'</span><span class="token punctuation">,</span>
                 use_difficult<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> return_difficult<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># if split not in ['train', 'trainval', 'val']:</span>
        <span class="token comment">#     if not (split == 'test' and year == '2007'):</span>
        <span class="token comment">#         warnings.warn(</span>
        <span class="token comment">#             'please pick split from \'train\', \'trainval\', \'val\''</span>
        <span class="token comment">#             'for 2012 dataset. For 2007 dataset, you can pick \'test\''</span>
        <span class="token comment">#             ' in addition to the above mentioned splits.'</span>
        <span class="token comment">#         )</span>
        
        <span class="token comment"># id_list_fileä¸ºsplit.txtï¼Œsplitä¸º'trainval'æˆ–è€…'test'</span>
        id_list_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> <span class="token string">'ImageSets/Main/&#123;0&#125;.txt'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># id_ä¸ºæ¯ä¸ªæ ·æœ¬æ–‡ä»¶å</span>
        self<span class="token punctuation">.</span>ids <span class="token operator">=</span> <span class="token punctuation">[</span>id_<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> id_ <span class="token keyword">in</span> <span class="token builtin">open</span><span class="token punctuation">(</span>id_list_file<span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># strip()ä¼šå»æ‰å‰åç©ºæ ¼</span>
        <span class="token comment"># å†™åˆ°/VOC2007/çš„è·¯å¾„</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>use_difficult <span class="token operator">=</span> use_difficult
        self<span class="token punctuation">.</span>return_difficult <span class="token operator">=</span> return_difficult
        <span class="token comment"># 20ç±»</span>
        self<span class="token punctuation">.</span>label_names <span class="token operator">=</span> VOC_BBOX_LABEL_NAMES

    <span class="token comment"># trainval.txtæœ‰5011ä¸ªï¼Œtest.txtæœ‰210ä¸ª</span>
    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ids<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_example</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#è¯»å…¥xmlæ ‡ç­¾æ–‡ä»¶</span>
        id_ <span class="token operator">=</span> self<span class="token punctuation">.</span>ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token comment"># ElementTree è°ƒç”¨parse()æ–¹æ³•ï¼Œè¿”å›è§£ææ ‘</span>
        anno <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">'Annotations'</span><span class="token punctuation">,</span> id_ <span class="token operator">+</span> <span class="token string">'.xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        bbox <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        difficult <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">#è§£æxmlæ–‡ä»¶</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> anno<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># æ ‡ä¸ºdifficultçš„ç›®æ ‡åœ¨æµ‹è¯•è¯„ä¼°ä¸­ä¸€èˆ¬ä¼šè¢«å¿½ç•¥</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>use_difficult <span class="token keyword">and</span> <span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token comment">#xmlæ–‡ä»¶ä¸­åŒ…å«object nameå’Œdifficult(0æˆ–è€…1,0ä»£è¡¨å®¹æ˜“æ£€æµ‹)</span>
            difficult<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'difficult'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># bndboxï¼ˆxmin,ymin,xmax,ymax),è¡¨ç¤ºæ¡†å·¦ä¸‹è§’å’Œå³ä¸Šè§’åæ ‡</span>
            bndbox_anno <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bndbox'</span><span class="token punctuation">)</span>
            <span class="token comment"># è®©åæ ‡åŸºäºï¼ˆ0,0ï¼‰ï¼Œæ„ä¹‰ä½•åœ¨ï¼Ÿ</span>
            bbox<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>bndbox_anno<span class="token punctuation">.</span>find<span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
                <span class="token keyword">for</span> tag <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'ymin'</span><span class="token punctuation">,</span> <span class="token string">'xmin'</span><span class="token punctuation">,</span> <span class="token string">'ymax'</span><span class="token punctuation">,</span> <span class="token string">'xmax'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># æ¡†ä¸­object name</span>
            name <span class="token operator">=</span> obj<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            label<span class="token punctuation">.</span>append<span class="token punctuation">(</span>VOC_BBOX_LABEL_NAMES<span class="token punctuation">.</span>index<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># æ‰€æœ‰objectçš„bboxåæ ‡å­˜åœ¨åˆ—è¡¨é‡Œ</span>
        bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>bbox<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token comment"># æ‰€æœ‰objectçš„labelå­˜åœ¨åˆ—è¡¨é‡Œ</span>
        label <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
        <span class="token comment"># PyTorch ä¸æ”¯æŒ np.boolï¼Œæ‰€ä»¥è¿™é‡Œè½¬æ¢ä¸ºuint8</span>
        difficult <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>difficult<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  

        <span class="token comment"># æ ¹æ®å›¾ç‰‡ç¼–å·åœ¨/JPEGImages/å–å›¾ç‰‡</span>
        img_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> <span class="token string">'JPEGImages'</span><span class="token punctuation">,</span> id_ <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span>
        <span class="token comment"># å¦‚æœcolor=Trueï¼Œåˆ™è½¬æ¢ä¸ºRGBå›¾</span>
        img <span class="token operator">=</span> read_image<span class="token punctuation">(</span>img_file<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># if self.return_difficult:</span>
        <span class="token comment">#     return img, bbox, label, difficult</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> difficult

    <span class="token comment"># ä¸€èˆ¬å¦‚æœæƒ³ä½¿ç”¨ç´¢å¼•è®¿é—®å…ƒç´ æ—¶ï¼Œå°±å¯ä»¥åœ¨ç±»ä¸­å®šä¹‰è¿™ä¸ªæ–¹æ³•ï¼ˆ__getitem__(self, key) )</span>
    __getitem__ <span class="token operator">=</span> get_example

<span class="token comment"># ç±»åˆ«å’Œåå­—å¯¹åº”çš„åˆ—è¡¨</span>
VOC_BBOX_LABEL_NAMES <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token string">'aeroplane'</span><span class="token punctuation">,</span>
    <span class="token string">'bicycle'</span><span class="token punctuation">,</span>
    <span class="token string">'bird'</span><span class="token punctuation">,</span>
    <span class="token string">'boat'</span><span class="token punctuation">,</span>
    <span class="token string">'bottle'</span><span class="token punctuation">,</span>
    <span class="token string">'bus'</span><span class="token punctuation">,</span>
    <span class="token string">'car'</span><span class="token punctuation">,</span>
    <span class="token string">'cat'</span><span class="token punctuation">,</span>
    <span class="token string">'chair'</span><span class="token punctuation">,</span>
    <span class="token string">'cow'</span><span class="token punctuation">,</span>
    <span class="token string">'diningtable'</span><span class="token punctuation">,</span>
    <span class="token string">'dog'</span><span class="token punctuation">,</span>
    <span class="token string">'horse'</span><span class="token punctuation">,</span>
    <span class="token string">'motorbike'</span><span class="token punctuation">,</span>
    <span class="token string">'person'</span><span class="token punctuation">,</span>
    <span class="token string">'pottedplant'</span><span class="token punctuation">,</span>
    <span class="token string">'sheep'</span><span class="token punctuation">,</span>
    <span class="token string">'sofa'</span><span class="token punctuation">,</span>
    <span class="token string">'train'</span><span class="token punctuation">,</span>
    <span class="token string">'tvmonitor'</span><span class="token punctuation">)</span></code></pre>
<p>å†æ¥ä¸‹æ¥æ˜¯<code>utils.py</code>é‡Œé¢ä¸€äº›ç”¨åˆ°çš„ç›¸å…³å‡½æ•°çš„æ³¨é‡Šï¼Œåªé€‰äº†å…¶ä¸­å‡ ä¸ªï¼Œå¹¶ä¸”æœ‰ä¸€äº›å‡½æ•°æ²¡æœ‰ç”¨åˆ°ï¼Œå…¨éƒ¨æ”¾ä¸Šæ¥ç¯‡å¹…å¤ªå¤šï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">resize_bbox</span><span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> in_size<span class="token punctuation">,</span> out_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># æ ¹æ®å›¾ç‰‡resizeçš„æƒ…å†µæ¥ç¼©æ”¾bbox</span>
    bbox <span class="token operator">=</span> bbox<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#  #è·å¾—ä¸åŸå›¾åŒæ ·çš„ç¼©æ”¾æ¯”</span>
    y_scale <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>out_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> in_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    x_scale <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>out_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> in_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment"># #æŒ‰ä¸åŸå›¾åŒç­‰æ¯”ä¾‹ç¼©æ”¾bbox</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_scale <span class="token operator">*</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> bbox


<span class="token keyword">def</span> <span class="token function">flip_bbox</span><span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> size<span class="token punctuation">,</span> y_flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> x_flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># æ ¹æ®å›¾ç‰‡flipçš„æƒ…å†µæ¥flip bbox</span>
    H<span class="token punctuation">,</span> W <span class="token operator">=</span> size <span class="token comment">#ç¼©æ”¾åå›¾ç‰‡çš„size</span>
    bbox <span class="token operator">=</span> bbox<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> y_flip<span class="token punctuation">:</span>  <span class="token comment">#è¿›è¡Œå‚ç›´ç¿»è½¬</span>
        <span class="token comment"># bboxä¸º(channel,(ymin,xmin,ymax,xmax))</span>
        y_max <span class="token operator">=</span> H <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        y_min <span class="token operator">=</span> H <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_min
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> y_max
    <span class="token keyword">if</span> x_flip<span class="token punctuation">:</span> <span class="token comment">#è¿›è¡Œæ°´å¹³ç¿»è½¬</span>
        x_max <span class="token operator">=</span> W <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        x_min <span class="token operator">=</span> W <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">#è®¡ç®—æ°´å¹³ç¿»è½¬åå·¦ä¸‹è§’å’Œå³ä¸Šè§’çš„åæ ‡</span>
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_min
        bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> x_max
    <span class="token keyword">return</span> bbox

<span class="token keyword">def</span> <span class="token function">random_flip</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> y_random<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> x_random<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                return_param<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> copy<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># æ•°æ®å¢å¼ºï¼Œéšæœºç¿»è½¬</span>
    y_flip<span class="token punctuation">,</span> x_flip <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span>
    <span class="token comment"># éšæœºé€‰æ‹©å›¾ç‰‡æ˜¯å¦è¿›è¡Œå‚ç›´ã€æ°´å¹³ç¿»è½¬</span>
    <span class="token keyword">if</span> y_random<span class="token punctuation">:</span>
        y_flip <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    
    <span class="token keyword">if</span> x_random<span class="token punctuation">:</span>
        x_flip <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> y_flip<span class="token punctuation">:</span>
        <span class="token comment"># channelï¼Œheightï¼Œweight</span>
        img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> x_flip<span class="token punctuation">:</span>
        <span class="token comment"># python [::-1]ä¸ºé€†åºè¾“å‡ºï¼Œè¿™é‡ŒæŒ‡æ°´å¹³ç¿»è½¬</span>
        img <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> copy<span class="token punctuation">:</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> return_param<span class="token punctuation">:</span>
        <span class="token comment">#è¿”å›imgå’Œx_flip(ä¸ºäº†è®©bboxæœ‰åŒæ ·çš„æ°´å¹³ç¿»è½¬æ“ä½œ)</span>
        <span class="token keyword">return</span> img<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token string">'y_flip'</span><span class="token punctuation">:</span> y_flip<span class="token punctuation">,</span> <span class="token string">'x_flip'</span><span class="token punctuation">:</span> x_flip<span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> img</code></pre>
<h2 id="ğŸ«-RPNå’ŒROI-Head"><a href="#ğŸ«-RPNå’ŒROI-Head" class="headerlink" title="ğŸ« RPNå’ŒROI Head"></a>ğŸ« RPNå’ŒROI Head</h2><p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200504133455.png" srcset="/img/loading.gif" alt="Faster RCNN æ•´ä½“ç»“æ„"></p>
<p>åŸå§‹å›¾ç‰‡é¦–å…ˆä¼šç»è¿‡ä¸€ä¸ªç‰¹å¾æå–å™¨Extratorï¼ˆè¿™é‡Œæ˜¯VGG16ï¼‰ï¼Œåœ¨åŸå§‹è®ºæ–‡ä¸­ä½œè€…ä½¿ç”¨äº†Caffeçš„é¢„è®­ç»ƒæ¨¡å‹ã€‚åŒæ—¶å°†VGG16æ¨¡å‹çš„å‰4å±‚å·ç§¯å±‚çš„å‚æ•°å†»ç»“ï¼ˆåœ¨Caffeä¸­å°†å…¶å­¦ä¹ ç‡è®¾ä¸º<code>0</code>ï¼‰ï¼Œå¹¶å°†æœ€å3å±‚å…¨è¿æ¥å±‚çš„å‰ä¸¤å±‚ä¿ç•™å¹¶ç”¨æ¥åˆå§‹åŒ–ROI Headé‡Œé¢éƒ¨åˆ†å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥å°†Extratorç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505191528.png" srcset="/img/loading.gif" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°å¯¹äºä¸€ä¸ªå°ºå¯¸ä¸º<code>HÃ—WÃ—C</code>çš„å›¾ç‰‡ï¼Œç»è¿‡è¿™ä¸ªç‰¹å¾æå–ç½‘ç»œä¹‹åä¼šå¾—åˆ°ä¸€ä¸ª<code>H/16 Ã— W/16 Ã— 512</code>çš„ç‰¹å¾å›¾ï¼Œä¹Ÿå³æ˜¯å›¾ä¸­çš„çº¢è‰²ç®­å¤´ä»£è¡¨çš„<strong>Features</strong>ã€‚</p>
<p>ä»æ•´ä½“ç»“æ„å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°RPNè¿™ä¸ªå€™é€‰æ¡†ç”Ÿæˆç½‘ç»œæ¥æ”¶äº†ä¸¤ä¸ªè¾“å…¥ï¼Œä¸€ä¸ªæ˜¯<strong>ç‰¹å¾å›¾</strong>ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšæåˆ°çš„ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯æ•°æ®é›†æä¾›çš„<strong>GT Box</strong>ï¼Œè¿™é‡Œé¢ç©¶ç«Ÿæ˜¯æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿ</p>
<h3 id="Anchorç”Ÿæˆ"><a href="#Anchorç”Ÿæˆ" class="headerlink" title="Anchorç”Ÿæˆ"></a>Anchorç”Ÿæˆ</h3><p>æˆ‘ä»¬çŸ¥é“RPNç½‘ç»œä½¿ç”¨æ¥æå–å€™é€‰æ¡†çš„ï¼Œå®ƒæœ€å¤§çš„è´¡çŒ®å°±åœ¨äºå®ƒæå‡ºäº†ä¸€ä¸ª<code>Anchor</code>çš„æ€æƒ³ï¼Œè¿™ä¹Ÿæ˜¯åé¢One-Stageä»¥åŠTwo-Stageçš„å„ç±»ç›®æ ‡æ£€æµ‹ç®—æ³•çš„å‡ºå‘ç‚¹ï¼Œ<code>Anchor</code>è¡¨ç¤ºçš„æ˜¯å¤§å°å’Œå°ºå¯¸å›ºå®šçš„å€™é€‰æ¡†ï¼Œè®ºæ–‡ä¸­ç”¨åˆ°äº†ä¸‰ç§æ¯”ä¾‹å’Œä¸‰ç§å°ºå¯¸ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äºç‰¹å¾å›¾çš„æ¯ä¸ªç‚¹éƒ½å°†äº§ç”Ÿ9ç§ä¸åŒå¤§å°çš„<code>Anchor</code>å€™é€‰æ¡†ï¼Œå…¶ä¸­ä¸‰ç§å°ºå¯¸åˆ†åˆ«æ˜¯<code>128ã€256ã€512</code>ï¼Œè€Œä¸‰ç§æ¯”ä¾‹åˆ†åˆ«ä¸ºï¼š<code>1:2ã€2:1ã€1:1</code>ã€‚Faster RCNNçš„ä¹ç§Anchorçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505191708.png" srcset="/img/loading.gif" alt="ä¸åŒå°ºå¯¸å’Œçºµæ¨ªæ¯”çš„Anchor"></p>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ç”ŸæˆAnchorçš„è¿‡ç¨‹ï¼Œå…·ä½“æ˜¯åœ¨<code>model/util</code>æ–‡ä»¶å¤¹ä¸‹ã€‚æˆ‘ä»¬é¦–å…ˆæ¥çœ‹<code>bbox_tools.py</code>æ–‡ä»¶ï¼Œå…¶ä¸­æ¶‰åŠåˆ°äº†RCNNä¸­æåˆ°çš„è¾¹æ¡†å›å½’å…¬å¼ï¼Œ$\hat{G}$ä»£è¡¨å€™é€‰æ¡†ï¼Œè€Œå›å½’å­¦ä¹ å°±æ˜¯å­¦ä¹  $d<em>{x},d</em>{y}, d<em>{h},d</em>{w}$ è¿™ 4 ä¸ªåç§»é‡ ã€‚</p>
<p>çœŸæ­£çš„ç›®æ ‡æ¡†Gå’Œå€™é€‰æ¡†Pä¹‹é—´çš„åç§»å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p>
<script type="math/tex; mode=display">
d_{y}=\left(G_{y}-P_{y}\right) / P_{h} \quad \quad d_{x}=\left(G_{x}-P_{x}\right) / P_{w}</script><script type="math/tex; mode=display">
d_{h}=\log \left(G_{h} / P_{h}\right)â€‹\quad \quad d_{w}=\log \left(G_{w} / P_{w}\right)â€‹</script><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">loc2bbox</span><span class="token punctuation">(</span>src_bbox<span class="token punctuation">,</span> loc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># å·²çŸ¥æºè¾¹ç•Œæ¡†src_bboxå’Œä½ç½®åå·®locï¼Œæ±‚ç›®æ ‡æ¡†dst_bbox</span>
    <span class="token comment"># src_bboxï¼šshapeä¸ºï¼ˆRï¼Œ4ï¼‰ï¼ŒRä¸ºbboxä¸ªæ•°ï¼Œ4ä¸ºå·¦ä¸Šè§’å’Œå³ä¸‹è§’å››ä¸ªåæ ‡</span>
    <span class="token comment"># scr_bbox=[[ymin,xmin,ymax,xmax]</span>
    <span class="token comment"># 			[ymin,xmin,ymax,xmax]</span>
    <span class="token comment">#           ...</span>
    <span class="token comment">#			[ymin,xmin,ymax,xmax]]</span>
    <span class="token comment">#</span>
    <span class="token comment"># locä¸º[[dy,dx,dh,dw,dy,dx,dh,dw...]  # å›¾ç‰‡1çš„è¾¹ç•Œæ¡†ä½ç½®åå·®ï¼Ÿ</span>
    <span class="token comment">#      [dy,dx,dh,dw,dy,dx,dh,dw...]</span>
    <span class="token comment">#      ...</span>
    <span class="token comment">#      [dy,dx,dh,dw,dy,dx,dh,dw...]]</span>
    
    <span class="token keyword">if</span> src_bbox<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>loc<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>

    src_bbox <span class="token operator">=</span> src_bbox<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>src_bbox<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> copy<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>	
    
    <span class="token comment"># src_heightä¸ºPhï¼Œsrc_widthä¸ºPwï¼Œsrc_ctr_yä¸ºPyï¼Œsrc_ctr_xä¸ºPx</span>
    src_height <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># ymax-ymin</span>
    src_width <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment"># xmax-xmin</span>
    src_ctr_y <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> src_height <span class="token comment"># y_min+0.5h,è®¡ç®—å‡ºä¸­å¿ƒç‚¹åæ ‡</span>
    src_ctr_x <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> src_width  <span class="token comment"># x_min+0.5w</span>

    <span class="token comment"># python [start:stop:step] </span>
    dy <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    dx <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    dh <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    dw <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>

    <span class="token comment"># RCNNä¸­æå‡ºçš„è¾¹æ¡†å›å½’ï¼šå¯»æ‰¾åŸå§‹proposalä¸è¿‘ä¼¼ç›®æ ‡æ¡†Gä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œå…¬å¼åœ¨ä¸Šé¢</span>
    <span class="token comment"># å¾—åˆ°å›å½’åçš„ç›®æ ‡æ¡†çš„é«˜åº¦ã€å®½åº¦å’Œä¸­å¿ƒç‚¹åæ ‡ï¼ˆGx,Gy,Gh,Gwï¼‰</span>
    ctr_y <span class="token operator">=</span> dy <span class="token operator">*</span> src_height<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token operator">+</span> src_ctr_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># ctr_yä¸ºGy</span>
    ctr_x <span class="token operator">=</span> dx <span class="token operator">*</span> src_width<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token operator">+</span> src_ctr_x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># ctr_xä¸ºGx</span>
    h <span class="token operator">=</span> np<span class="token punctuation">.</span>enp<span class="token punctuation">(</span>dh<span class="token punctuation">)</span> <span class="token operator">*</span> src_height<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># hä¸ºGh</span>
    w <span class="token operator">=</span> np<span class="token punctuation">.</span>enp<span class="token punctuation">(</span>dw<span class="token punctuation">)</span> <span class="token operator">*</span> src_width<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span> <span class="token comment"># wä¸ºGw</span>


    <span class="token comment"># ç”±ä¸­å¿ƒç‚¹è½¬æ¢ä¸ºå·¦ä¸Šè§’å’Œå³ä¸‹è§’åæ ‡</span>
    dst_bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>loc<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>loc<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_y <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> h  <span class="token comment"># y_min</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_x <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> w  <span class="token comment"># x_min</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_y <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> h  <span class="token comment"># y_max</span>
    dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ctr_x <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> w  <span class="token comment"># x_max</span>

    <span class="token keyword">return</span> dst_bbox



<span class="token comment"># å·²çŸ¥æºæ¡†src_bboxå’Œç›®æ ‡æ¡†dst_bboxï¼Œæ±‚å‡ºå…¶ä½ç½®åå·®</span>
<span class="token keyword">def</span> <span class="token function">bbox2loc</span><span class="token punctuation">(</span>src_bbox<span class="token punctuation">,</span> dst_bbox<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># è®¡ç®—å‡ºæºæ¡†ä¸­å¿ƒç‚¹åæ ‡</span>
    height <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># y_max-y_min</span>
    width <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># x_max-x_min</span>
    ctr_y <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> height
    ctr_x <span class="token operator">=</span> src_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> width

    <span class="token comment"># è®¡ç®—å‡ºç›®æ ‡æ¡†ä¸­å¿ƒç‚¹åæ ‡</span>
    base_height <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    base_width <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    base_ctr_y <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> base_height
    base_ctr_x <span class="token operator">=</span> dst_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> base_width

    <span class="token comment"># æ±‚å‡ºæœ€å°çš„æ­£æ•°</span>
    eps <span class="token operator">=</span> np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>height<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">.</span>eps
    <span class="token comment"># å°†height,widthä¸å…¶æ¯”è¾ƒä¿è¯å…¨éƒ¨æ˜¯éè´Ÿ</span>
    height <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>height<span class="token punctuation">,</span> eps<span class="token punctuation">)</span>
    width <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>width<span class="token punctuation">,</span> eps<span class="token punctuation">)</span>

    <span class="token comment"># æ ¹æ®ä¸Šé¢çš„å…¬å¼äºŒè®¡ç®—dxï¼Œdyï¼Œdhï¼Œdw</span>
    dy <span class="token operator">=</span> <span class="token punctuation">(</span>base_ctr_y <span class="token operator">-</span> ctr_y<span class="token punctuation">)</span> <span class="token operator">/</span> height
    dx <span class="token operator">=</span> <span class="token punctuation">(</span>base_ctr_x <span class="token operator">-</span> ctr_x<span class="token punctuation">)</span> <span class="token operator">/</span> width
    dh <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>base_height <span class="token operator">/</span> height<span class="token punctuation">)</span>
    dw <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>base_width <span class="token operator">/</span> width<span class="token punctuation">)</span>

    <span class="token comment"># np.vstackæŒ‰ç…§è¡Œçš„é¡ºåºæŠŠæ•°ç»„ç»™å †å èµ·æ¥</span>
    loc <span class="token operator">=</span> np<span class="token punctuation">.</span>vstack<span class="token punctuation">(</span><span class="token punctuation">(</span>dy<span class="token punctuation">,</span> dx<span class="token punctuation">,</span> dh<span class="token punctuation">,</span> dw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> loc



<span class="token comment"># æ±‚ä¸¤ä¸ªbboxçš„ç›¸äº¤çš„äº¤å¹¶æ¯”</span>
<span class="token keyword">def</span> <span class="token function">bbox_iou</span><span class="token punctuation">(</span>bbox_a<span class="token punctuation">,</span> bbox_b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># bbox_a=[[ymin,xmin,ymax,xmax]</span>
    <span class="token comment"># 		  [ymin,xmin,ymax,xmax]</span>
    <span class="token comment">#         ...</span>
    <span class="token comment">#		  [ymin,xmin,ymax,xmax]]</span>
    
    <span class="token comment"># ç¡®ä¿bboxç¬¬äºŒç»´ä¸ºbboxçš„å››ä¸ªåæ ‡ï¼ˆyminï¼Œxminï¼Œymaxï¼Œxmaxï¼‰</span>
    <span class="token keyword">if</span> bbox_a<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token keyword">or</span> bbox_b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> IndexError

    <span class="token comment"># top left</span>
    <span class="token comment"># lä¸ºäº¤å‰éƒ¨åˆ†æ¡†å·¦ä¸Šè§’åæ ‡æœ€å¤§å€¼ï¼Œä¸ºäº†åˆ©ç”¨numpyçš„å¹¿æ’­æ€§è´¨ï¼Œ</span>
    <span class="token comment"># bbox_a[:, None, :2]çš„shapeæ˜¯(N,1,2)ï¼Œbbox_b[:, :2]çš„shapeæ˜¯(K,2)</span>
    <span class="token comment"># ç”±numpyçš„å¹¿æ’­æ€§è´¨ï¼Œä¸¤ä¸ªæ•°ç»„shapeéƒ½å˜æˆ(N,K,2)ï¼Œä¹Ÿå°±æ˜¯å¯¹aé‡Œæ¯ä¸ªbboxéƒ½åˆ†åˆ«å’Œbé‡Œçš„æ¯ä¸ªbboxæ±‚å·¦ä¸Šè§’ç‚¹åæ ‡æœ€å¤§å€¼</span>
    tl <span class="token operator">=</span> np<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># bottom right</span>
    <span class="token comment"># brä¸ºäº¤å‰éƒ¨åˆ†æ¡†å³ä¸‹è§’åæ ‡æœ€å°å€¼</span>
    br <span class="token operator">=</span> np<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># æ‰€æœ‰åæ ‡è½´ä¸Štl&lt;bræ—¶ï¼Œè¿”å›æ•°ç»„å…ƒç´ çš„ä¹˜ç§¯(y1max-yimin)X(x1max-x1min)ï¼Œ</span>
    <span class="token comment"># bboxaä¸bboxbç›¸äº¤åŒºåŸŸçš„é¢ç§¯</span>
    area_i <span class="token operator">=</span> np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>br <span class="token operator">-</span> tl<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>tl <span class="token operator">&lt;</span> br<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment"># è®¡ç®—bboxaçš„é¢ç§¯</span>
    area_a <span class="token operator">=</span> np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># è®¡ç®—bboxbçš„é¢ç§¯</span>
    area_b <span class="token operator">=</span> np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox_b<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># è®¡ç®—IOU</span>
    <span class="token keyword">return</span> area_i <span class="token operator">/</span> <span class="token punctuation">(</span>area_a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> area_b <span class="token operator">-</span> area_i<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">__test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    __test<span class="token punctuation">(</span><span class="token punctuation">)</span>

    
<span class="token comment"># å¯¹ç‰¹å¾å›¾featuresä»¥åŸºå‡†é•¿åº¦ä¸º16ã€é€‰æ‹©åˆé€‚çš„ratioså’Œscaleså–åŸºå‡†é”šç‚¹</span>
 <span class="token comment"># anchor_baseã€‚ï¼ˆé€‰æ‹©é•¿åº¦ä¸º16çš„åŸå› æ˜¯å›¾ç‰‡å¤§å°ä¸º600*800å·¦å³ï¼ŒåŸºå‡†é•¿åº¦</span>
 <span class="token comment"># 16å¯¹åº”çš„åŸå›¾åŒºåŸŸæ˜¯256*256ï¼Œè€ƒè™‘æ”¾ç¼©åçš„å¤§å°æœ‰128*128ï¼Œ512*512æ¯”è¾ƒåˆé€‚ï¼‰</span>
<span class="token keyword">def</span> <span class="token function">generate_anchor_base</span><span class="token punctuation">(</span>base_size<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         anchor_scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># æ ¹æ®åŸºå‡†ç‚¹ç”Ÿæˆ9ä¸ªåŸºæœ¬çš„anchorçš„åŠŸèƒ½ï¼Œratios=[0.5,1,2],anchor_scales=</span>
    <span class="token comment"># [8,16,32]æ˜¯é•¿å®½æ¯”å’Œç¼©æ”¾æ¯”ä¾‹,anchor_scalesä¹Ÿå°±æ˜¯åœ¨base_sizeçš„åŸºç¡€ä¸Šå†å¢</span>
    <span class="token comment"># åŠ çš„é‡ï¼Œæœ¬ä»£ç ä¸­å¯¹åº”ç€ä¸‰ç§é¢ç§¯çš„å¤§å°(16*8)^2 ,(16*16)^2  (16*32)^2  </span>
    <span class="token comment"># ä¹Ÿå°±æ˜¯128,256,512çš„å¹³æ–¹å¤§å°</span>

    py <span class="token operator">=</span> base_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
    px <span class="token operator">=</span> base_size <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>

    <span class="token comment">#ï¼ˆ9ï¼Œ4ï¼‰ï¼Œæ³¨æ„ï¼šè¿™é‡Œåªæ˜¯ä»¥ç‰¹å¾å›¾çš„å·¦ä¸Šè§’ç‚¹ä¸ºåŸºå‡†äº§ç”Ÿçš„9ä¸ªanchor,</span>
    anchor_base <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ratios<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor_scales<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    <span class="token comment"># six.moves æ˜¯ç”¨æ¥å¤„ç†é‚£äº›åœ¨python2 å’Œ 3é‡Œé¢å‡½æ•°çš„ä½ç½®æœ‰å˜åŒ–çš„ï¼Œ</span>
    <span class="token comment"># ç›´æ¥ç”¨six.moveså°±å¯ä»¥å±è”½æ‰è¿™äº›å˜åŒ–</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> six<span class="token punctuation">.</span>moves<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ratios<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> six<span class="token punctuation">.</span>moves<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>anchor_scales<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># ç”Ÿæˆ9ç§ä¸åŒæ¯”ä¾‹çš„hå’Œw</span>
            h <span class="token operator">=</span> base_size <span class="token operator">*</span> anchor_scales<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>ratios<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            w <span class="token operator">=</span> base_size <span class="token operator">*</span> anchor_scales<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> ratios<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

            index <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor_scales<span class="token punctuation">)</span> <span class="token operator">+</span> j
            <span class="token comment"># è®¡ç®—å‡ºanchor_baseç”»çš„9ä¸ªæ¡†çš„å·¦ä¸‹è§’å’Œå³ä¸Šè§’çš„4ä¸ªanchoråæ ‡å€¼</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> py <span class="token operator">-</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> px <span class="token operator">-</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> py <span class="token operator">+</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
            anchor_base<span class="token punctuation">[</span>index<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> px <span class="token operator">+</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> anchor_base</code></pre>
<p>åœ¨ä¸Šé¢çš„<code>generate_anchor_base</code>å‡½æ•°ä¸­ï¼Œè¾“å‡º<strong>Anchor</strong>çš„å½¢çŠ¶ä»¥åŠè¿™9ä¸ªAnchorçš„å·¦ä¸Šå³ä¸‹åæ ‡å¦‚ä¸‹ï¼š</p>
<pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># è¿™9ä¸ªanchorå½¢çŠ¶ä¸ºï¼š</span>
<span class="token number">90.50967</span> *181.01933    <span class="token operator">=</span> <span class="token number">128</span>^2
<span class="token number">181.01933</span> * <span class="token number">362.03867</span> <span class="token operator">=</span> <span class="token number">256</span>^2
<span class="token number">362.03867</span> * <span class="token number">724.07733</span> <span class="token operator">=</span> <span class="token number">512</span>^2
<span class="token number">128.0</span> * <span class="token number">128.0</span> <span class="token operator">=</span> <span class="token number">128</span>^2
<span class="token number">256.0</span> * <span class="token number">256.0</span> <span class="token operator">=</span> <span class="token number">256</span>^2
<span class="token number">512.0</span> * <span class="token number">512.0</span> <span class="token operator">=</span> <span class="token number">512</span>^2
<span class="token number">181.01933</span> * <span class="token number">90.50967</span>   <span class="token operator">=</span> <span class="token number">128</span>^2
<span class="token number">362.03867</span> * <span class="token number">181.01933</span> <span class="token operator">=</span> <span class="token number">256</span>^2
<span class="token number">724.07733</span> * <span class="token number">362.03867</span> <span class="token operator">=</span> <span class="token number">512</span>^2

<span class="token comment"># 9ä¸ªanchorçš„å·¦ä¸Šå³ä¸‹åæ ‡ï¼š</span>
-37.2548 -82.5097 <span class="token number">53.2548</span> <span class="token number">98.5097</span>
-82.5097 -173.019 <span class="token number">98.5097</span> <span class="token number">189.019</span>
-173.019 -354.039 <span class="token number">189.019</span> <span class="token number">370.039</span>
-56 -56 <span class="token number">72</span> <span class="token number">72</span>
-120 -120 <span class="token number">136</span> <span class="token number">136</span>
-248 -248 <span class="token number">264</span> <span class="token number">264</span>
-82.5097 -37.2548 <span class="token number">98.5097</span> <span class="token number">53.2548</span>
-173.019 -82.5097 <span class="token number">189.019</span> <span class="token number">98.5097</span>
-354.039 -173.019 <span class="token number">370.039</span> <span class="token number">189.019</span></code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<pre class="language-none"><code class="language-none">anchor_base &#x3D; np.zeros((len(ratios) * len(anchor_scales), 4), dtype&#x3D;np.float32)</code></pre>
<p>è¿™è¡Œä»£ç è¡¨ç¤ºçš„æ˜¯åªæ˜¯ä»¥ç‰¹å¾å›¾çš„å·¦ä¸Šè§’ä¸ºåŸºå‡†äº§ç”Ÿçš„9ä¸ªAnchorï¼Œè€Œæˆ‘ä»¬çŸ¥é“Faster RCNNæ˜¯ä¼šåœ¨ç‰¹å¾å›¾çš„æ¯ä¸ªç‚¹äº§ç”Ÿ9ä¸ªAnchorçš„ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åœ¨<code>mode/region_proposal_network.py</code>é‡Œé¢ï¼Œè¿™é‡Œé¢çš„<code>_enumerate_shifted_anchor</code>è¿™ä¸ªå‡½æ•°å°±å®ç°äº†è¿™ä¸€åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»”ç»†çœ‹çœ‹è¿™ä¸ªå‡½æ•°æ˜¯å¦‚ä½•äº§ç”Ÿæ•´ä¸ªç‰¹å¾å›¾çš„æ‰€æœ‰Anchorçš„ï¼ˆä¸€å…±20000+ä¸ªå·¦å³Anchorï¼Œå¦å¤–äº§ç”Ÿçš„Anchoråæ ‡ä¼šæˆªæ–­åˆ°å›¾åƒåæ ‡èŒƒå›´é‡Œé¢ï¼‰ã€‚ä¸‹é¢æ¥çœ‹çœ‹<code>model/region_proposal_network.py</code>é‡Œé¢çš„<code>_enumerate_shifted_anchor</code>å‡½æ•°</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ©ç”¨anchor_baseç”Ÿæˆæ‰€æœ‰å¯¹åº”feature mapçš„anchor</span>
<span class="token keyword">def</span> <span class="token function">_enumerate_shifted_anchor</span><span class="token punctuation">(</span>anchor_base<span class="token punctuation">,</span> feat_stride<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Enumerate all shifted anchors:</span>
    <span class="token comment">#</span>
    <span class="token comment"># add A anchors (1, A, 4) to</span>
    <span class="token comment"># cell K shifts (K, 1, 4) to get</span>
    <span class="token comment"># shift anchors (K, A, 4)</span>
    <span class="token comment"># reshape to (K*A, 4) shifted anchors</span>
    <span class="token comment"># return (K*A, 4)</span>

    <span class="token comment"># !TODO: add support for torch.CudaTensor</span>
    <span class="token comment"># np = cuda.get_array_module(anchor_base)</span>
    <span class="token comment"># it seems that it can't be boosed using GPU</span>
    <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
    <span class="token comment"># çºµå‘åç§»é‡ï¼ˆ0ï¼Œ16ï¼Œ32ï¼Œ...ï¼‰</span>
    shift_y <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">*</span> feat_stride<span class="token punctuation">,</span> feat_stride<span class="token punctuation">)</span>
    <span class="token comment"># æ¨ªå‘åç§»é‡ï¼ˆ0ï¼Œ16ï¼Œ32ï¼Œ...ï¼‰</span>
    shift_x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> width <span class="token operator">*</span> feat_stride<span class="token punctuation">,</span> feat_stride<span class="token punctuation">)</span>
    <span class="token comment"># shift_x = [[0ï¼Œ16ï¼Œ32ï¼Œ..],[0ï¼Œ16ï¼Œ32ï¼Œ..],[0ï¼Œ16ï¼Œ32ï¼Œ..]...],</span>
    <span class="token comment"># shift_y = [[0ï¼Œ0ï¼Œ0ï¼Œ..],[16ï¼Œ16ï¼Œ16ï¼Œ..],[32ï¼Œ32ï¼Œ32ï¼Œ..]...],</span>
    <span class="token comment"># å°±æ˜¯å½¢æˆäº†ä¸€ä¸ªçºµæ¨ªå‘åç§»é‡çš„çŸ©é˜µï¼Œä¹Ÿå°±æ˜¯ç‰¹å¾å›¾çš„æ¯ä¸€ç‚¹éƒ½èƒ½å¤Ÿé€šè¿‡è¿™ä¸ª</span>
    <span class="token comment"># çŸ©é˜µæ‰¾åˆ°æ˜ å°„åœ¨åŸå›¾ä¸­çš„å…·ä½“ä½ç½®ï¼</span>
    shift_x<span class="token punctuation">,</span> shift_y <span class="token operator">=</span> np<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>shift_x<span class="token punctuation">,</span> shift_y<span class="token punctuation">)</span>
    <span class="token comment"># #ç»è¿‡åˆšæ‰çš„å˜åŒ–ï¼Œå…¶å®å¤§X,Yçš„å…ƒç´ ä¸ªæ•°å·²ç»ç›¸åŒï¼Œçœ‹çŸ©é˜µçš„ç»“æ„ä¹Ÿèƒ½çœ‹å‡ºï¼Œ</span>
    <span class="token comment"># çŸ©é˜µå¤§å°æ˜¯ç›¸åŒçš„ï¼ŒX.ravel()ä¹‹åå˜æˆä¸€è¡Œï¼Œæ­¤æ—¶shift_x,shift_yçš„å…ƒ</span>
    <span class="token comment"># ç´ ä¸ªæ•°æ˜¯ç›¸åŒçš„ï¼Œéƒ½ç­‰äºç‰¹å¾å›¾çš„é•¿å®½çš„ä¹˜ç§¯(åƒç´ ç‚¹ä¸ªæ•°)ï¼Œä¸åŒçš„æ˜¯æ­¤æ—¶</span>
    <span class="token comment"># çš„shift_xé‡Œé¢è£…å¾—æ˜¯æ¨ªå‘çœ‹çš„xçš„ä¸€è¡Œä¸€è¡Œçš„åç§»åæ ‡ï¼Œè€Œæ­¤æ—¶çš„yé‡Œé¢è£…</span>
    <span class="token comment"># çš„æ˜¯å¯¹åº”çš„çºµå‘çš„åç§»åæ ‡ï¼ä¸‹å›¾æ˜¾ç¤º np.meshgridï¼ˆï¼‰ï¼Œshift_y.ravel()</span>
    <span class="token comment"># æ“ä½œç¤ºä¾‹</span>
    shift <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>shift_y<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shift_x<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      shift_y<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shift_x<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># A=9</span>
    A <span class="token operator">=</span> anchor_base<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># è¯»å–ç‰¹å¾å›¾ä¸­å…ƒç´ çš„æ€»ä¸ªæ•°</span>
    K <span class="token operator">=</span> shift<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">#ç”¨åŸºç¡€çš„9ä¸ªanchorçš„åæ ‡åˆ†åˆ«å’Œåç§»é‡ç›¸åŠ ï¼Œæœ€åå¾—å‡ºäº†æ‰€æœ‰çš„anchorçš„åæ ‡ï¼Œ</span>
    <span class="token comment"># å››åˆ—å¯ä»¥å ªç§°æ˜¯å·¦ä¸Šè§’çš„åæ ‡å’Œå³ä¸‹è§’çš„åæ ‡åŠ åç§»é‡çš„åŒæ­¥æ‰§è¡Œï¼Œé£é€Ÿçš„ä»</span>
    <span class="token comment"># ä¸Šå¾€ä¸‹æ‹ä¸€éï¼Œæ‰€æœ‰çš„anchorå°±éƒ½å‡ºæ¥äº†ï¼ä¸€å…±Kä¸ªç‰¹å¾ç‚¹ï¼Œæ¯ä¸€ä¸ªæœ‰A(9)ä¸ª</span>
    <span class="token comment"># åŸºæœ¬çš„anchorï¼Œæ‰€ä»¥æœ€åreshape((K*A),4)çš„å½¢å¼ï¼Œä¹Ÿå°±å¾—åˆ°äº†æœ€åçš„æ‰€æœ‰</span>
    <span class="token comment"># çš„anchorå·¦ä¸‹è§’å’Œå³ä¸Šè§’åæ ‡.          </span>
    anchor <span class="token operator">=</span> anchor<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>K <span class="token operator">*</span> A<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

    anchor <span class="token operator">=</span> anchor_base<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> A<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> \
             shift<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> K<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    anchor <span class="token operator">=</span> anchor<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span>K <span class="token operator">*</span> A<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    <span class="token keyword">return</span> anchor</code></pre>
<p>æˆ‘ä»¬ç»“åˆä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹<code>shift_x, shift_y = np.meshgrid(shift_x, shift_y)å‡½æ•°æ“</code>è¿™ä¸ªå‡½æ•°åˆ°åº•æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œï¼Ÿå…¶ä¸­<code>np</code>å°±æ˜¯<code>numpy</code>ã€‚</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505140046.png" srcset="/img/loading.gif" alt="np.meshgridæ“ä½œä¾‹å­"></p>
<p>ç„¶å<code>shift = np.stack((shift_y.ravel(), shift_x.ravel(),shift_y.ravel(), shift_x.ravel()), axis=1)</code>è¿™è¡Œä»£ç åˆ™æ˜¯äº§ç”Ÿåæ ‡åç§»å¯¹ï¼Œä¸€ä¸ªæ˜¯<code>x</code>æ–¹å‘ï¼Œä¸€ä¸ªæ˜¯<code>y</code>æ–¹å‘ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦å°†ç‰¹å¾å›¾å¯¹åº”å›åŸå›¾å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¦æ¡†ä½çš„ç›®æ ‡æ˜¯åœ¨åŸå›¾ä¸Šï¼Œè€Œæˆ‘ä»¬é€‰Anchoræ˜¯åœ¨ç‰¹å¾å›¾ä¸Šï¼ŒPoolingä¹‹åç‰¹å¾ä¹‹é—´çš„ç›¸å¯¹ä½ç½®ä¸å˜ï¼Œä½†æ˜¯å°ºå¯¸å·²ç»å‡å°‘ä¸ºäº†åŸå§‹å›¾çš„$1/16$ï¼Œè€Œæˆ‘ä»¬çš„Anchoræ˜¯ä¸ºäº†æ¡†ä½åŸå›¾ä¸Šçš„ç›®æ ‡è€Œéç‰¹å¾å›¾ä¸Šçš„ï¼Œæ‰€ä»¥æ³¨æ„ä¸€ä¸‹Anchorä¸€å®šæŒ‡çš„æ˜¯é’ˆå¯¹åŸå›¾çš„ï¼Œè€Œéç‰¹å¾å›¾ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è®­ç»ƒRPNçš„ä¸€äº›ç»†èŠ‚ï¼ŒRPNçš„æ€»ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505191855.png" srcset="/img/loading.gif" alt="RPNæ€»ä½“æ¶æ„"></p>
<p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®Anchorçš„æ•°é‡æ˜¯å’Œç‰¹å¾å›¾ç›¸å…³çš„ï¼Œä¸åŒçš„ç‰¹å¾å›¾å¯¹åº”çš„Anchoræ•°é‡ä¹Ÿä¸ä¸€æ ·ã€‚RPNåœ¨<code>Extractor</code>è¾“å‡ºçš„ç‰¹å¾å›¾åŸºç¡€ä¸Šå…ˆå¢åŠ äº†ä¸€ä¸ª$3Ã—3$å·ç§¯ï¼Œç„¶ååˆ©ç”¨ä¸¤ä¸ª$1Ã—1$å·ç§¯åˆ†åˆ«è¿›è¡ŒäºŒåˆ†ç±»å’Œä½ç½®å›å½’ã€‚è¿›è¡Œåˆ†ç±»çš„å·ç§¯æ ¸é€šé“æ•°ä¸º$9Ã—2$ï¼ˆ9ä¸ªAnchorï¼Œæ¯ä¸ªAnchor äºŒåˆ†ç±»ï¼Œä½¿ç”¨äº¤å‰ç†µæŸå¤±ï¼‰ï¼Œè¿›è¡Œå›å½’çš„å·ç§¯æ ¸é€šé“æ•°ä¸º$9Ã—4$ï¼ˆ9ä¸ªAnchorï¼Œæ¯ä¸ªAnchoræœ‰4ä¸ªä½ç½®å‚æ•°ï¼‰ã€‚RPNæ˜¯ä¸€ä¸ªå…¨å·ç§¯ç½‘ç»œï¼Œè¿™æ ·å¯¹è¾“å…¥å›¾ç‰‡çš„å°ºå¯¸æ˜¯æ²¡æœ‰è¦æ±‚çš„ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦è®²åˆ°ä»Šå¤©çš„é‡ç‚¹éƒ¨åˆ†äº†ï¼Œå³<code>AnchorTargetCreator</code>ï¼Œ<code>ProposalCreator</code>ï¼Œ<code>ProposalTargetCreator</code>ï¼Œä¹Ÿå°±æ˜¯ROI Headæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼š</p>
<h3 id="AnchorTargetCreator"><a href="#AnchorTargetCreator" class="headerlink" title="AnchorTargetCreator"></a>AnchorTargetCreator</h3><p>AnchorTargetCreatorå°±æ˜¯å°†20000å¤šä¸ªå€™é€‰çš„Anchoré€‰å‡º256ä¸ªAnchorè¿›è¡Œåˆ†ç±»å’Œå›å½’ï¼Œé€‰æ‹©è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯¹äºæ¯ä¸€ä¸ªGT bboxï¼Œé€‰æ‹©å’Œå®ƒäº¤å¹¶æ¯”æœ€å¤§çš„ä¸€ä¸ªAnchorä½œä¸ºæ­£æ ·æœ¬ã€‚</li>
<li>å¯¹äºå‰©ä¸‹çš„Anchorï¼Œä»ä¸­é€‰æ‹©å’Œä»»æ„ä¸€ä¸ªGT bboxäº¤å¹¶æ¯”è¶…è¿‡0.7çš„Anchorä½œä¸ºæ­£æ ·æœ¬ï¼Œæ­£æ ·æœ¬æ•°ç›®ä¸è¶…è¿‡128ä¸ªã€‚</li>
<li>éšæœºé€‰æ‹©å’ŒGT bboxäº¤å¹¶æ¯”å°äº0.3çš„Anchorä½œä¸ºè´Ÿæ ·æœ¬ï¼Œè´Ÿæ ·æœ¬å’Œæ­£æ ·æœ¬çš„æ€»æ•°ä¸º256ã€‚</li>
</ul>
<p>å¯¹äºæ¯ä¸€ä¸ªAnchoræ¥è¯´ï¼ŒGT_Labelè¦ä¹ˆä¸º1ï¼ˆå‰æ™¯ï¼‰ï¼Œè¦ä¹ˆä¸º0ï¼ˆèƒŒæ™¯ï¼‰ï¼Œè€ŒGT_Locåˆ™æ˜¯ç”±4ä¸ªä½ç½®å‚æ•°ç»„æˆï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è®²çš„ç›®æ ‡æ¡†å’Œå€™é€‰æ¡†ä¹‹é—´çš„åç§»ã€‚</p>
<p>è®¡ç®—åˆ†ç±»æŸå¤±ä½¿ç”¨çš„æ˜¯äº¤å‰ç†µæŸå¤±ï¼Œè€Œè®¡ç®—å›å½’æŸå¤±åˆ™ä½¿ç”¨äº†SmoothL1Lossï¼Œåœ¨è®¡ç®—å›å½’æŸå¤±çš„æ—¶å€™åªè®¡ç®—æ­£æ ·æœ¬ï¼ˆå‰æ™¯ï¼‰çš„æŸå¤±ï¼Œä¸è®¡ç®—è´Ÿæ ·æœ¬çš„æŸå¤±ã€‚</p>
<p>ä»£ç å®ç°åœ¨<code>model/utils/creator_tool.py</code>é‡Œé¢ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># AnchorTargetCreatorä½œç”¨æ˜¯ç”Ÿæˆè®­ç»ƒè¦ç”¨çš„anchor(æ­£è´Ÿæ ·æœ¬</span>
<span class="token comment"># å„128ä¸ªæ¡†çš„åæ ‡å’Œ256ä¸ªlabelï¼ˆ0æˆ–è€…1ï¼‰)</span>
<span class="token comment"># åˆ©ç”¨æ¯å¼ å›¾ä¸­bboxçš„çœŸå®æ ‡ç­¾æ¥ä¸ºæ‰€æœ‰ä»»åŠ¡åˆ†é…ground truth</span>
<span class="token keyword">class</span> <span class="token class-name">AnchorTargetCreator</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 n_sample<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
                 pos_iou_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> neg_iou_thresh<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
                 pos_ratio<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>n_sample <span class="token operator">=</span> n_sample
        self<span class="token punctuation">.</span>pos_iou_thresh <span class="token operator">=</span> pos_iou_thresh
        self<span class="token punctuation">.</span>neg_iou_thresh <span class="token operator">=</span> neg_iou_thresh
        self<span class="token punctuation">.</span>pos_ratio <span class="token operator">=</span> pos_ratio

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> img_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ç‰¹å¾å›¾å¤§å°</span>
        img_H<span class="token punctuation">,</span> img_W <span class="token operator">=</span> img_size
        <span class="token comment"># ä¸€èˆ¬å¯¹åº”20000ä¸ªå·¦å³anchor</span>
        n_anchor <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>anchor<span class="token punctuation">)</span>
        <span class="token comment"># å°†é‚£äº›è¶…å‡ºå›¾ç‰‡èŒƒå›´çš„anchorå…¨éƒ¨å»æ‰,åªä¿ç•™ä½äºå›¾ç‰‡å†…éƒ¨çš„åºå·</span>
        inside_index <span class="token operator">=</span> _get_inside_index<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> img_H<span class="token punctuation">,</span> img_W<span class="token punctuation">)</span>
        <span class="token comment"># ä¿ç•™ä½äºå›¾ç‰‡å†…éƒ¨çš„anchor</span>
        anchor <span class="token operator">=</span> anchor<span class="token punctuation">[</span>inside_index<span class="token punctuation">]</span>
        <span class="token comment"># ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„æ­£ä¾‹128ä¸ªè´Ÿä¾‹128å¹¶ç»™å®ƒä»¬é™„ä¸Šç›¸åº”çš„label</span>
        argmax_ious<span class="token punctuation">,</span> label <span class="token operator">=</span> self<span class="token punctuation">.</span>_create_label<span class="token punctuation">(</span>
            inside_index<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span>

        <span class="token comment"># è®¡ç®—æ¯ä¸€ä¸ªanchorä¸å¯¹åº”bboxæ±‚å¾—iouæœ€å¤§çš„bboxè®¡ç®—åç§»</span>
        <span class="token comment"># é‡ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯ä½äºå›¾ç‰‡å†…éƒ¨çš„æ¯ä¸€ä¸ªï¼‰</span>
        loc <span class="token operator">=</span> bbox2loc<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">[</span>argmax_ious<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># å°†ä½äºå›¾ç‰‡å†…éƒ¨çš„æ¡†çš„labelå¯¹åº”åˆ°æ‰€æœ‰ç”Ÿæˆçš„20000ä¸ªæ¡†ä¸­</span>
        <span class="token comment"># ï¼ˆlabelåŸæœ¬ä¸ºæ‰€æœ‰åœ¨å›¾ç‰‡ä¸­çš„æ¡†çš„ï¼‰</span>
        label <span class="token operator">=</span> _unmap<span class="token punctuation">(</span>label<span class="token punctuation">,</span> n_anchor<span class="token punctuation">,</span> inside_index<span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># å°†å›å½’çš„æ¡†å¯¹åº”åˆ°æ‰€æœ‰ç”Ÿæˆçš„20000ä¸ªæ¡†ä¸­ï¼ˆlabelåŸæœ¬ä¸º</span>
        <span class="token comment"># æ‰€æœ‰åœ¨å›¾ç‰‡ä¸­çš„æ¡†çš„ï¼‰</span>
        loc <span class="token operator">=</span> _unmap<span class="token punctuation">(</span>loc<span class="token punctuation">,</span> n_anchor<span class="token punctuation">,</span> inside_index<span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> loc<span class="token punctuation">,</span> label
    <span class="token comment"># ä¸‹é¢ä¸ºè°ƒç”¨çš„_creat_labelï¼ˆï¼‰ å‡½æ•°</span>
    <span class="token keyword">def</span> <span class="token function">_create_label</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inside_index<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># inside_indexä¸ºæ‰€æœ‰åœ¨å›¾ç‰‡èŒƒå›´å†…çš„anchoråºå·</span>
        label <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>inside_index<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
        <span class="token comment"># #å…¨éƒ¨å¡«å……-1</span>
        label<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># è°ƒç”¨_calc_iousï¼ˆï¼‰å‡½æ•°å¾—åˆ°æ¯ä¸ªanchorä¸å“ªä¸ªbboxçš„iouæœ€å¤§</span>
        <span class="token comment"># ä»¥åŠè¿™ä¸ªiouå€¼ã€æ¯ä¸ªbboxä¸å“ªä¸ªanchorçš„iouæœ€å¤§(éœ€è¦ä½“ä¼šä»</span>
        <span class="token comment"># è¡Œå’Œåˆ—å–æœ€å¤§å€¼çš„åŒºåˆ«)</span>
        argmax_ious<span class="token punctuation">,</span> max_ious<span class="token punctuation">,</span> gt_argmax_ious <span class="token operator">=</span> \
            self<span class="token punctuation">.</span>_calc_ious<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> inside_index<span class="token punctuation">)</span>

        <span class="token comment"># #æŠŠæ¯ä¸ªanchorä¸å¯¹åº”çš„æ¡†æ±‚å¾—çš„iouå€¼ä¸è´Ÿæ ·æœ¬é˜ˆå€¼æ¯”è¾ƒï¼Œè‹¥å°</span>
        <span class="token comment"># äºè´Ÿæ ·æœ¬é˜ˆå€¼ï¼Œåˆ™labelè®¾ä¸º0ï¼Œpos_iou_thresh=0.7, </span>
        <span class="token comment"># neg_iou_thresh=0.3</span>
        label<span class="token punctuation">[</span>max_ious <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>neg_iou_thresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment"># æŠŠä¸æ¯ä¸ªbboxæ±‚å¾—iouå€¼æœ€å¤§çš„anchorçš„labelè®¾ä¸º1</span>
        label<span class="token punctuation">[</span>gt_argmax_ious<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

        <span class="token comment"># æŠŠæ¯ä¸ªanchorä¸å¯¹åº”çš„æ¡†æ±‚å¾—çš„iouå€¼ä¸æ­£æ ·æœ¬é˜ˆå€¼æ¯”è¾ƒï¼Œ</span>
        <span class="token comment"># è‹¥å¤§äºæ­£æ ·æœ¬é˜ˆå€¼ï¼Œåˆ™labelè®¾ä¸º1</span>
        label<span class="token punctuation">[</span>max_ious <span class="token operator">>=</span> self<span class="token punctuation">.</span>pos_iou_thresh<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>

        <span class="token comment"># æŒ‰ç…§æ¯”ä¾‹è®¡ç®—å‡ºæ­£æ ·æœ¬æ•°é‡ï¼Œpos_ratio=0.5ï¼Œn_sample=256</span>
        n_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pos_ratio <span class="token operator">*</span> self<span class="token punctuation">.</span>n_sample<span class="token punctuation">)</span>
        <span class="token comment"># å¾—åˆ°æ‰€æœ‰æ­£æ ·æœ¬çš„ç´¢å¼•</span>
        pos_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>label <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># å¦‚æœé€‰å–å‡ºæ¥çš„æ­£æ ·æœ¬æ•°å¤šäºé¢„è®¾å®šçš„æ­£æ ·æœ¬æ•°ï¼Œåˆ™éšæœºæŠ›å¼ƒï¼Œå°†é‚£äº›æŠ›å¼ƒçš„æ ·æœ¬çš„labelè®¾ä¸º-1</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pos_index<span class="token punctuation">)</span> <span class="token operator">></span> n_pos<span class="token punctuation">:</span>
            disable_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                pos_index<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>pos_index<span class="token punctuation">)</span> <span class="token operator">-</span> n_pos<span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            label<span class="token punctuation">[</span>disable_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

        <span class="token comment"># è®¾å®šçš„è´Ÿæ ·æœ¬çš„æ•°é‡</span>
        n_neg <span class="token operator">=</span> self<span class="token punctuation">.</span>n_sample <span class="token operator">-</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>label <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># è´Ÿæ ·æœ¬çš„ç´¢å¼•</span>
        neg_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>label <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>neg_index<span class="token punctuation">)</span> <span class="token operator">></span> n_neg<span class="token punctuation">:</span>
            <span class="token comment"># éšæœºé€‰æ‹©ä¸è¦çš„è´Ÿæ ·æœ¬ï¼Œä¸ªæ•°ä¸ºlen(neg_index)-neg_indexï¼Œlabelå€¼è®¾ä¸º-1</span>
            disable_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                neg_index<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>neg_index<span class="token punctuation">)</span> <span class="token operator">-</span> n_neg<span class="token punctuation">)</span><span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            label<span class="token punctuation">[</span>disable_index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

        <span class="token keyword">return</span> argmax_ious<span class="token punctuation">,</span> label
    <span class="token comment"># _calc_iouså‡½æ•°</span>
    <span class="token keyword">def</span> <span class="token function">_calc_ious</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> inside_index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ious between the anchors and the gt boxes</span>
        <span class="token comment"># è°ƒç”¨bbox_iouå‡½æ•°è®¡ç®—anchorä¸bboxçš„IOUï¼Œ iousï¼šï¼ˆN,Kï¼‰ï¼Œ</span>
        <span class="token comment"># Nä¸ºanchorä¸­ç¬¬Nä¸ªï¼ŒKä¸ºbboxä¸­ç¬¬Kä¸ªï¼ŒNå¤§æ¦‚æœ‰15000ä¸ª</span>
        ious <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span>
        <span class="token comment"># 1ä»£è¡¨è¡Œï¼Œ0ä»£è¡¨åˆ—</span>
        argmax_ious <span class="token operator">=</span> ious<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># æ±‚å‡ºæ¯ä¸ªanchorä¸å“ªä¸ªbboxçš„iouæœ€å¤§ï¼Œä»¥åŠæœ€å¤§å€¼ï¼Œmax_ious:[1,N]</span>
        max_ious <span class="token operator">=</span> ious<span class="token punctuation">[</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>inside_index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> argmax_ious<span class="token punctuation">]</span>
        gt_argmax_ious <span class="token operator">=</span> ious<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># æ±‚å‡ºæ¯ä¸ªbboxä¸å“ªä¸ªanchorçš„iouæœ€å¤§ï¼Œä»¥åŠæœ€å¤§å€¼,gt_max_ious:[1,K]</span>
        gt_max_ious <span class="token operator">=</span> ious<span class="token punctuation">[</span>gt_argmax_ious<span class="token punctuation">,</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>ious<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token comment"># ç„¶åè¿”å›æœ€å¤§iouçš„ç´¢å¼•ï¼ˆæ¯ä¸ªbboxä¸å“ªä¸ªanchorçš„iouæœ€å¤§),æœ‰Kä¸ª</span>
        gt_argmax_ious <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>ious <span class="token operator">==</span> gt_max_ious<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> argmax_ious<span class="token punctuation">,</span> max_ious<span class="token punctuation">,</span> gt_argmax_ious</code></pre>
<h3 id="ProposalCreator"><a href="#ProposalCreator" class="headerlink" title="ProposalCreator"></a>ProposalCreator</h3><p>RPNåœ¨è‡ªèº«è®­ç»ƒçš„æ—¶å€™è¿˜ä¼šæä¾›ROIsç»™Faster RCNNçš„ROI Headä½œä¸ºè®­ç»ƒæ ·æœ¬ã€‚RPNç”ŸæˆROIsçš„è¿‡ç¨‹å°±æ˜¯ProposalCreatorï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯¹äºæ¯å¼ å›¾ç‰‡ï¼Œåˆ©ç”¨å®ƒçš„ç‰¹å¾å›¾ï¼Œè®¡ç®—$\frac{H}{16} \times \frac{W}{16} \times 9$ï¼ˆå¤§çº¦20000ä¸ªï¼‰Anchorå±äºå‰æ™¯çš„æ¦‚ç‡ä»¥åŠå¯¹åº”çš„ä½ç½®å‚æ•°ã€‚</li>
<li>é€‰å–æ¦‚ç‡è¾ƒå¤§çš„12000ä¸ªAnchorã€‚</li>
<li>åˆ©ç”¨å›å½’çš„ä½ç½®å‚æ•°ä¿®æ­£è¿™12000ä¸ªAnchorçš„ä½ç½®ï¼Œè·å¾—ROIsã€‚</li>
<li>åˆ©ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼Œé€‰å‡ºæ¦‚ç‡æœ€å¤§çš„2000ä¸ªROIsã€‚</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„ï¼</strong> åœ¨æ¨ç†é˜¶æ®µï¼Œä¸ºäº†æé«˜å¤„ç†é€Ÿåº¦ï¼Œ12000å’Œ2000åˆ†åˆ«å˜æˆäº†6000å’Œ300ã€‚å¹¶ä¸”è¿™éƒ¨åˆ†æ“ä½œä¸éœ€è¦åå‘ä¼ æ’­ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨numpyæˆ–è€…tensorå®ç°ã€‚å› æ­¤ï¼ŒRPNçš„è¾“å‡ºå°±æ˜¯å½¢å¦‚$2000Ã—4$æˆ–è€…$300Ã—4$çš„Tensorã€‚</p>
</blockquote>
<p>RPNç»™å‡ºäº†å€™é€‰æ¡†ï¼Œç„¶åROI Headå°±æ˜¯åœ¨å€™é€‰æ¡†çš„åŸºç¡€ä¸Šç»§ç»­è¿›è¡Œåˆ†ç±»å’Œä½ç½®å‚æ•°çš„å›å½’è·å¾—æœ€åçš„ç»“æœï¼ŒROI Headçš„ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505141253.png" srcset="/img/loading.gif" alt="ROIHeadç½‘ç»œç»“æ„"></p>
<p>ä»£ç å®ç°åœ¨<code>model/utils/creator_tool.py</code>é‡Œé¢ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¸‹é¢æ˜¯ProposalCreatorçš„ä»£ç ï¼š è¿™éƒ¨åˆ†çš„æ“ä½œä¸éœ€è¦è¿›è¡Œåå‘ä¼ æ’­</span>
<span class="token comment"># å› æ­¤å¯ä»¥åˆ©ç”¨numpy/tensorå®ç°</span>
<span class="token keyword">class</span> <span class="token class-name">ProposalCreator</span><span class="token punctuation">:</span>
    <span class="token comment"># å¯¹äºæ¯å¼ å›¾ç‰‡ï¼Œåˆ©ç”¨å®ƒçš„feature mapï¼Œè®¡ç®—ï¼ˆH/16ï¼‰x(W/16)x9(å¤§æ¦‚20000)</span>
    <span class="token comment"># ä¸ªanchorå±äºå‰æ™¯çš„æ¦‚ç‡ï¼Œç„¶åä»ä¸­é€‰å–æ¦‚ç‡è¾ƒå¤§çš„12000å¼ ï¼Œåˆ©ç”¨ä½ç½®å›å½’å‚</span>
    <span class="token comment"># æ•°ï¼Œä¿®æ­£è¿™12000ä¸ªanchorçš„ä½ç½®ï¼Œ åˆ©ç”¨éæå¤§å€¼æŠ‘åˆ¶ï¼Œé€‰å‡º2000ä¸ªROISä»¥åŠ</span>
    <span class="token comment"># å¯¹åº”çš„ä½ç½®å‚æ•°ã€‚</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 parent_model<span class="token punctuation">,</span>
                 nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
                 n_train_pre_nms<span class="token operator">=</span><span class="token number">12000</span><span class="token punctuation">,</span>
                 n_train_post_nms<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span>
                 n_test_pre_nms<span class="token operator">=</span><span class="token number">6000</span><span class="token punctuation">,</span>
                 n_test_post_nms<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span>
                 min_size<span class="token operator">=</span><span class="token number">16</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>parent_model <span class="token operator">=</span> parent_model
        self<span class="token punctuation">.</span>nms_thresh <span class="token operator">=</span> nms_thresh
        self<span class="token punctuation">.</span>n_train_pre_nms <span class="token operator">=</span> n_train_pre_nms
        self<span class="token punctuation">.</span>n_train_post_nms <span class="token operator">=</span> n_train_post_nms
        self<span class="token punctuation">.</span>n_test_pre_nms <span class="token operator">=</span> n_test_pre_nms
        self<span class="token punctuation">.</span>n_test_post_nms <span class="token operator">=</span> n_test_post_nms
        self<span class="token punctuation">.</span>min_size <span class="token operator">=</span> min_size
    <span class="token comment"># è¿™é‡Œçš„locå’Œscoreæ˜¯ç»è¿‡region_proposal_networkä¸­</span>
    <span class="token comment"># ç»è¿‡1x1å·ç§¯åˆ†ç±»å’Œå›å½’å¾—åˆ°çš„ã€‚</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loc<span class="token punctuation">,</span> score<span class="token punctuation">,</span>
                 anchor<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>parent_model<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
            n_pre_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_train_pre_nms <span class="token comment">#12000</span>
            n_post_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_train_post_nms <span class="token comment">#ç»è¿‡NMSåæœ‰2000ä¸ª</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            n_pre_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_test_pre_nms <span class="token comment">#6000</span>
            n_post_nms <span class="token operator">=</span> self<span class="token punctuation">.</span>n_test_post_nms <span class="token comment">#ç»è¿‡NMSåæœ‰300ä¸ª</span>

        <span class="token comment"># å°†bboxè½¬æ¢ä¸ºè¿‘ä¼¼groudtruthçš„anchor(å³rois)</span>
        roi <span class="token operator">=</span> loc2bbox<span class="token punctuation">(</span>anchor<span class="token punctuation">,</span> loc<span class="token punctuation">)</span>

        <span class="token comment"># sliceè¡¨ç¤ºåˆ‡ç‰‡æ“ä½œ</span>
        <span class="token comment"># è£å‰ªå°†roisçš„ymin,ymaxé™å®šåœ¨[0,H]</span>
        roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>
            roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># è£å‰ªå°†roisçš„xmin,xmaxé™å®šåœ¨[0,W]</span>
        roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>
            roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Remove predicted boxes with either height or width &lt; threshold.</span>
        min_size <span class="token operator">=</span> self<span class="token punctuation">.</span>min_size <span class="token operator">*</span> scale <span class="token comment">#16</span>
        <span class="token comment"># roisçš„å®½</span>
        hs <span class="token operator">=</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># roisçš„é«˜</span>
        ws <span class="token operator">=</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> roi<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># ç¡®ä¿roisçš„é•¿å®½å¤§äºæœ€å°é˜ˆå€¼</span>
        keep <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>hs <span class="token operator">>=</span> min_size<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ws <span class="token operator">>=</span> min_size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>keep<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># å¯¹å‰©ä¸‹çš„ROIsè¿›è¡Œæ‰“åˆ†ï¼ˆæ ¹æ®region_proposal_networkä¸­roisçš„é¢„æµ‹å‰æ™¯æ¦‚ç‡ï¼‰</span>
        score <span class="token operator">=</span> score<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>

        <span class="token comment"># Sort all (proposal, score) pairs by score from highest to lowest.</span>
        <span class="token comment"># Take top pre_nms_topN (e.g. 6000).</span>
        <span class="token comment"># å°†scoreæ‹‰ä¼¸å¹¶é€†åºï¼ˆä»é«˜åˆ°ä½ï¼‰æ’åº</span>
        order <span class="token operator">=</span> score<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argsort<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token comment"># trainæ—¶ä»20000ä¸­å–å‰12000ä¸ªroisï¼Œtestå–å‰6000ä¸ª</span>
        <span class="token keyword">if</span> n_pre_nms <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            order <span class="token operator">=</span> order<span class="token punctuation">[</span><span class="token punctuation">:</span>n_pre_nms<span class="token punctuation">]</span>
        roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>order<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>

        <span class="token comment"># Apply nms (e.g. threshold = 0.7).</span>
        <span class="token comment"># Take after_nms_topN (e.g. 300).</span>

        <span class="token comment"># unNOTE: somthing is wrong here!</span>
        <span class="token comment"># TODO: remove cuda.to_gpu</span>
        <span class="token comment"># #ï¼ˆå…·ä½“éœ€è¦çœ‹NMSçš„åŸç†ä»¥åŠè¾“å…¥å‚æ•°çš„ä½œç”¨ï¼‰è°ƒç”¨éæå¤§å€¼æŠ‘åˆ¶å‡½æ•°ï¼Œ</span>
        <span class="token comment"># å°†é‡å¤çš„æŠ‘åˆ¶æ‰ï¼Œå°±å¯ä»¥å°†ç­›é€‰åROISè¿›è¡Œè¿”å›ã€‚ç»è¿‡NMSå¤„ç†åTrain</span>
        <span class="token comment"># æ•°æ®é›†å¾—åˆ°2000ä¸ªæ¡†ï¼ŒTestæ•°æ®é›†å¾—åˆ°300ä¸ªæ¡†</span>
        keep <span class="token operator">=</span> non_maximum_suppression<span class="token punctuation">(</span>
            cp<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>cp<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            thresh<span class="token operator">=</span>self<span class="token punctuation">.</span>nms_thresh<span class="token punctuation">)</span>
        <span class="token keyword">if</span> n_post_nms <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            keep <span class="token operator">=</span> keep<span class="token punctuation">[</span><span class="token punctuation">:</span>n_post_nms<span class="token punctuation">]</span>
        <span class="token comment"># å–å‡ºæœ€ç»ˆçš„2000æˆ–300ä¸ªrois</span>
        roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>
        <span class="token keyword">return</span> roi</code></pre>
<h3 id="ProposalTargetCreator"><a href="#ProposalTargetCreator" class="headerlink" title="ProposalTargetCreator"></a>ProposalTargetCreator</h3><p>ROIsç»™å‡ºäº†2000ä¸ªå€™é€‰æ¡†ï¼Œåˆ†åˆ«å¯¹åº”äº†ä¸åŒå¤§å°çš„Anchorã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ©ç”¨ProposalTargetCreatoræŒ‘é€‰å‡º128ä¸ª<code>sample_rois</code>ï¼Œç„¶åä½¿ç”¨äº†ROI Poolingå°†è¿™äº›ä¸åŒå°ºå¯¸çš„åŒºåŸŸå…¨éƒ¨Poolingåˆ°åŒä¸€ä¸ªå°ºåº¦($7Ã—7$)ä¸Šï¼Œå…³äºROI Poolingè¿™é‡Œå°±ä¸å¤šè®²äº†ï¼Œå…·ä½“è§ï¼š<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA4MjY4NTk0NQ==&amp;mid=2247484605&amp;idx=1&amp;sn=a3ebfc4cedaad84a60020cd1781f119c&amp;scene=21#wechat_redirect">å®ä¾‹åˆ†å‰²ç®—æ³•ä¹‹Mask R-CNNè®ºæ–‡è§£è¯»</a> ã€‚é‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦Poolingæˆ$7Ã—7$å¤§å°å‘¢ï¼Ÿ</p>
<p>è¿™æ˜¯ä¸ºäº†å…±äº«æƒé‡ï¼Œå‰é¢åœ¨<code>Extrator</code>éƒ¨åˆ†è¯´åˆ°Faster RCNNé™¤äº†å‰é¢åŸºå±‚å·ç§¯è¢«ç”¨åˆ°ä¹‹å¤–ï¼Œæœ€åå…¨è¿æ¥å±‚çš„æƒé‡ä¹Ÿå¯ä»¥ç»§ç»­åˆ©ç”¨ã€‚å½“æ‰€æœ‰çš„RoIséƒ½è¢«Resizeåˆ°$512Ã—512Ã—7$çš„ç‰¹å¾å›¾ä¹‹åï¼Œå°†å®ƒReshapeæˆä¸€ä¸ªä¸€ç»´çš„å‘é‡ï¼Œå°±å¯ä»¥åˆ©ç”¨VGG16é¢„è®­ç»ƒçš„æƒé‡åˆå§‹åŒ–å‰ä¸¤å±‚å…¨è¿æ¥å±‚äº†ã€‚æœ€åï¼Œå†æ¥ä¸Šä¸¤ä¸ªå…¨è¿æ¥å±‚FC21ç”¨æ¥åˆ†ç±»ï¼ˆ20ä¸ªç±»+èƒŒæ™¯ï¼ŒVOCï¼‰å’Œå›å½’ï¼ˆ21ä¸ªç±»ï¼Œæ¯ä¸ªç±»æœ‰4ä¸ªä½ç½®å‚æ•°ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ProposalTargetCreatorå…·ä½“æ˜¯å¦‚ä½•é€‰æ‹©128ä¸ªROIsè¿›è¡Œè®­ç»ƒçš„ï¼Ÿè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>RoIså’ŒGT boxçš„IOUå¤§äº0.5çš„ï¼Œé€‰æ‹©ä¸€äº›å¦‚32ä¸ªã€‚</li>
<li>RoIså’Œgt_bboxesçš„IoUå°äºç­‰äº0ï¼ˆæˆ–è€…0.1ï¼‰çš„é€‰æ‹©ä¸€äº›ï¼ˆæ¯”å¦‚ 128-32=96ä¸ªï¼‰ä½œä¸ºè´Ÿæ ·æœ¬ã€‚</li>
</ul>
<p>åŒæ—¶ä¸ºäº†æ–¹ä¾¿è®­ç»ƒï¼Œå¯¹é€‰æ‹©å‡ºçš„128ä¸ªRoIsçš„<code>gt_roi_loc</code>è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ï¼ˆå‡å‡å€¼é™¤ä»¥æ ‡å‡†å·®ï¼‰ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹çœ‹ä»£ç å®ç°ï¼ŒåŒæ ·æ˜¯åœ¨<code>model/utils/creator_tool.py</code>é‡Œé¢ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¸‹é¢æ˜¯ProposalTargetCreatorä»£ç ï¼šProposalCreatoräº§ç”Ÿ2000ä¸ªROISï¼Œ</span>
<span class="token comment"># ä½†æ˜¯è¿™äº›ROISå¹¶ä¸éƒ½ç”¨äºè®­ç»ƒï¼Œç»è¿‡æœ¬ProposalTargetCreatorçš„ç­›é€‰äº§ç”Ÿ</span>
<span class="token comment"># 128ä¸ªç”¨äºè‡ªèº«çš„è®­ç»ƒ</span>

<span class="token keyword">class</span> <span class="token class-name">ProposalTargetCreator</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 n_sample<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>
                 pos_ratio<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> pos_iou_thresh<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
                 neg_iou_thresh_hi<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span> neg_iou_thresh_lo<span class="token operator">=</span><span class="token number">0.0</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>n_sample <span class="token operator">=</span> n_sample
        self<span class="token punctuation">.</span>pos_ratio <span class="token operator">=</span> pos_ratio
        self<span class="token punctuation">.</span>pos_iou_thresh <span class="token operator">=</span> pos_iou_thresh
        self<span class="token punctuation">.</span>neg_iou_thresh_hi <span class="token operator">=</span> neg_iou_thresh_hi
        self<span class="token punctuation">.</span>neg_iou_thresh_lo <span class="token operator">=</span> neg_iou_thresh_lo  <span class="token comment"># NOTE:default 0.1 in py-faster-rcnn</span>
    <span class="token comment"># è¾“å…¥ï¼š2000ä¸ªroisã€ä¸€ä¸ªbatchï¼ˆä¸€å¼ å›¾ï¼‰ä¸­æ‰€æœ‰çš„bbox ground truthï¼ˆRï¼Œ4ï¼‰ã€</span>
    <span class="token comment"># å¯¹åº”bboxæ‰€åŒ…å«çš„labelï¼ˆRï¼Œ1ï¼‰ï¼ˆVOC2007æ¥è¯´20ç±»0-19ï¼‰</span>
    <span class="token comment"># è¾“å‡ºï¼š128ä¸ªsample roiï¼ˆ128ï¼Œ4ï¼‰ã€128ä¸ªgt_roi_locï¼ˆ128ï¼Œ4ï¼‰ã€</span>
    <span class="token comment"># 128ä¸ªgt_roi_labelï¼ˆ128ï¼Œ1ï¼‰</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> roi<span class="token punctuation">,</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span>
                 loc_normalize_mean<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 loc_normalize_std<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        n_bbox<span class="token punctuation">,</span> _ <span class="token operator">=</span> bbox<span class="token punctuation">.</span>shape
        <span class="token comment"># é¦–å…ˆå°†2000ä¸ªroiå’Œmä¸ªbboxç»™concatenateäº†ä¸€ä¸‹æˆä¸º</span>
        <span class="token comment"># æ–°çš„roiï¼ˆ2000+mï¼Œ4ï¼‰ã€‚</span>
        roi <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>roi<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># n_sample = 128,pos_ratio=0.5ï¼Œround å¯¹ä¼ å…¥çš„æ•°æ®è¿›è¡Œå››èˆäº”å…¥</span>
        pos_roi_per_image <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_sample <span class="token operator">*</span> self<span class="token punctuation">.</span>pos_ratio<span class="token punctuation">)</span>
        <span class="token comment"># è®¡ç®—æ¯ä¸€ä¸ªroiä¸æ¯ä¸€ä¸ªbboxçš„iou</span>
        iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>roi<span class="token punctuation">,</span> bbox<span class="token punctuation">)</span>
        <span class="token comment"># æŒ‰è¡Œæ‰¾åˆ°æœ€å¤§å€¼ï¼Œè¿”å›æœ€å¤§å€¼å¯¹åº”çš„åºå·ä»¥åŠå…¶çœŸæ­£çš„IOUã€‚</span>
        <span class="token comment"># è¿”å›çš„æ˜¯æ¯ä¸ªroiä¸å“ªä¸ªbboxçš„æœ€å¤§ï¼Œä»¥åŠæœ€å¤§çš„iouå€¼</span>
        gt_assignment <span class="token operator">=</span> iou<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># æ¯ä¸ªroiä¸å¯¹åº”bboxæœ€å¤§çš„iou</span>
        max_iou <span class="token operator">=</span> iou<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># ä»1å¼€å§‹çš„ç±»åˆ«åºå·ï¼Œç»™æ¯ä¸ªç±»å¾—åˆ°çœŸæ­£çš„label(å°†0-19å˜ä¸º1-20)</span>
        gt_roi_label <span class="token operator">=</span> label<span class="token punctuation">[</span>gt_assignment<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>

        <span class="token comment"># åŒæ ·çš„æ ¹æ®iouçš„æœ€å¤§å€¼å°†æ­£è´Ÿæ ·æœ¬æ‰¾å‡ºæ¥ï¼Œpos_iou_thresh=0.5</span>
        pos_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>max_iou <span class="token operator">>=</span> self<span class="token punctuation">.</span>pos_iou_thresh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># éœ€è¦ä¿ç•™çš„roiä¸ªæ•°ï¼ˆæ»¡è¶³å¤§äºpos_iou_threshæ¡ä»¶çš„roiä¸64ä¹‹é—´è¾ƒå°çš„ä¸€ä¸ªï¼‰</span>
        pos_roi_per_this_image <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>pos_roi_per_image<span class="token punctuation">,</span> pos_index<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># æ‰¾å‡ºçš„æ ·æœ¬æ•°ç›®è¿‡å¤šå°±éšæœºä¸¢æ‰ä¸€äº›</span>
        <span class="token keyword">if</span> pos_index<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            pos_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                pos_index<span class="token punctuation">,</span> size<span class="token operator">=</span>pos_roi_per_this_image<span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token comment"># neg_iou_thresh_hi=0.5ï¼Œneg_iou_thresh_lo=0.0</span>
        neg_index <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span><span class="token punctuation">(</span>max_iou <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>neg_iou_thresh_hi<span class="token punctuation">)</span> <span class="token operator">&amp;</span>
                             <span class="token punctuation">(</span>max_iou <span class="token operator">>=</span> self<span class="token punctuation">.</span>neg_iou_thresh_lo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        neg_roi_per_this_image <span class="token operator">=</span> self<span class="token punctuation">.</span>n_sample <span class="token operator">-</span> pos_roi_per_this_image
        neg_roi_per_this_image <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>neg_roi_per_this_image<span class="token punctuation">,</span>
                                         neg_index<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> neg_index<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
            neg_index <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>
                neg_index<span class="token punctuation">,</span> size<span class="token operator">=</span>neg_roi_per_this_image<span class="token punctuation">,</span> replace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token comment"># The indices that we're selecting (both positive and negative).</span>
        keep_index <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pos_index<span class="token punctuation">,</span> neg_index<span class="token punctuation">)</span>
        gt_roi_label <span class="token operator">=</span> gt_roi_label<span class="token punctuation">[</span>keep_index<span class="token punctuation">]</span>
        gt_roi_label<span class="token punctuation">[</span>pos_roi_per_this_image<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># è´Ÿæ ·æœ¬label è®¾ä¸º0</span>
        sample_roi <span class="token operator">=</span> roi<span class="token punctuation">[</span>keep_index<span class="token punctuation">]</span>
        <span class="token comment"># æ­¤æ—¶è¾“å‡ºçš„128*4çš„sample_roiå°±å¯ä»¥å»æ‰”åˆ° RoIHeadç½‘ç»œé‡Œå»è¿›è¡Œåˆ†ç±»</span>
        <span class="token comment"># ä¸å›å½’äº†ã€‚åŒæ ·ï¼Œ RoIHeadç½‘ç»œåˆ©ç”¨è¿™sample_roi+featueä¸ºè¾“å…¥ï¼Œè¾“å‡º</span>
        <span class="token comment"># æ˜¯åˆ†ç±»ï¼ˆ21ç±»ï¼‰å’Œå›å½’ï¼ˆè¿›ä¸€æ­¥å¾®è°ƒbboxï¼‰çš„é¢„æµ‹å€¼ï¼Œé‚£ä¹ˆåˆ†ç±»å›å½’çš„groud </span>
        <span class="token comment"># truthå°±æ˜¯ProposalTargetCreatorè¾“å‡ºçš„gt_roi_labelå’Œgt_roi_locã€‚</span>
        <span class="token comment"># Compute offsets and scales to match sampled RoIs to the GTs.</span>
        <span class="token comment"># æ±‚è¿™128ä¸ªæ ·æœ¬çš„groundtruth</span>
        gt_roi_loc <span class="token operator">=</span> bbox2loc<span class="token punctuation">(</span>sample_roi<span class="token punctuation">,</span> bbox<span class="token punctuation">[</span>gt_assignment<span class="token punctuation">[</span>keep_index<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># ProposalTargetCreatoré¦–æ¬¡ç”¨åˆ°äº†çœŸå®çš„21ä¸ªç±»çš„label,</span>
        <span class="token comment"># ä¸”è¯¥ç±»æœ€åå¯¹locè¿›è¡Œäº†å½’ä¸€åŒ–å¤„ç†ï¼Œæ‰€ä»¥é¢„æµ‹æ—¶è¦è¿›è¡Œå‡å€¼æ–¹å·®å¤„ç†</span>
        gt_roi_loc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gt_roi_loc <span class="token operator">-</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>loc_normalize_mean<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
                       <span class="token punctuation">)</span> <span class="token operator">/</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>loc_normalize_std<span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> sample_roi<span class="token punctuation">,</span> gt_roi_loc<span class="token punctuation">,</span> gt_roi_label</code></pre>
<h2 id="ğŸ“Ÿ-Faster-RCNNç½‘ç»œæ¨¡å‹æ­å»º"><a href="#ğŸ“Ÿ-Faster-RCNNç½‘ç»œæ¨¡å‹æ­å»º" class="headerlink" title="ğŸ“Ÿ Faster RCNNç½‘ç»œæ¨¡å‹æ­å»º"></a>ğŸ“Ÿ Faster RCNNç½‘ç»œæ¨¡å‹æ­å»º</h2><p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193036.png" srcset="/img/loading.gif" alt="Faster RCNNç½‘ç»œ"></p>
<p>æ³¨æ„ç½‘ç»œç»“æ„å›¾ä¸­çš„è“è‰²ç®­å¤´çš„çº¿ä»£è¡¨äº†è®¡ç®—å›¾ï¼Œæ¢¯åº¦åå‘ä¼ æ’­ä¼šç»è¿‡ã€‚è€Œçº¢è‰²çš„çº¿ä¸éœ€è¦åå‘ä¼ æ’­ã€‚ä¸€ä¸ªæœ‰è¶£çš„äº‹æƒ…æ˜¯åœ¨Instance-aware Semantic Segmentation via Multi-task Network Cascadesè¿™ç¯‡è®ºæ–‡ï¼ˆ<code>https://arxiv.org/abs/1512.04412</code>ï¼‰ä¸­æåˆ°ProposalCreatorç”ŸæˆRoIsçš„è¿‡ç¨‹ä¹Ÿå¯ä»¥è¿›è¡Œåå‘ä¼ æ’­ï¼Œæ„Ÿå…´è¶£å¯ä»¥å»çœ‹çœ‹ã€‚</p>
<p>åœ¨ä¸Šä¸€èŠ‚ä¸»è¦è®²äº†RPNé‡Œé¢çš„<code>AnchorTargetCreator</code>ï¼Œ<code>ProposalCreator</code>ï¼Œ<code>ProposalTargetCreator</code>ï¼Œè€ŒRPNç½‘ç»œçš„æ ¸å¿ƒç±»<code>RegionProposalNetwork</code>è¿˜æ²¡è®²ï¼Œè¿™é‡Œå…ˆçœ‹ä¸€ä¸‹ï¼Œä»£ç åœ¨<code>model/region_proposal_network.py</code>é‡Œé¢ï¼Œç»†èŠ‚å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RegionProposalNetwork</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span> in_channels<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> mid_channels<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            anchor_scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> feat_stride<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
            proposal_creator_params<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>RegionProposalNetwork<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># é¦–å…ˆç”Ÿæˆä¸Šè¿°ä»¥ï¼ˆ0ï¼Œ0ï¼‰ä¸ºä¸­å¿ƒçš„9ä¸ªbase anchor</span>
        self<span class="token punctuation">.</span>anchor_base <span class="token operator">=</span> generate_anchor_base<span class="token punctuation">(</span>
            anchor_scales<span class="token operator">=</span>anchor_scales<span class="token punctuation">,</span> ratios<span class="token operator">=</span>ratios<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>feat_stride <span class="token operator">=</span> feat_stride
        self<span class="token punctuation">.</span>proposal_layer <span class="token operator">=</span> ProposalCreator<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>proposal_creator_params<span class="token punctuation">)</span>
        n_anchor <span class="token operator">=</span> self<span class="token punctuation">.</span>anchor_base<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> mid_channels<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> n_anchor <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>loc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>mid_channels<span class="token punctuation">,</span> n_anchor <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>loc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token comment"># xçš„å°ºå¯¸ä¸º(batch_sizeï¼Œ512,H/16,W/16ï¼‰ï¼Œå…¶ä¸­Hï¼ŒWåˆ†åˆ«ä¸ºåŸå›¾çš„é«˜å’Œå®½</span>
        <span class="token comment"># xä¸ºfeature mapï¼Œnä¸ºbatch_size,æ­¤ç‰ˆæœ¬ä»£ç ä¸º1. hhï¼Œwwå³ä¸ºå®½é«˜</span>
        n<span class="token punctuation">,</span> _<span class="token punctuation">,</span> hh<span class="token punctuation">,</span> ww <span class="token operator">=</span> x<span class="token punctuation">.</span>shape
        <span class="token comment"># åœ¨9ä¸ªbase_anchoråŸºç¡€ä¸Šç”Ÿæˆhh*ww*9ä¸ªanchorï¼Œå¯¹åº”åˆ°åŸå›¾åæ ‡</span>
        <span class="token comment"># feat_stride=16 ï¼Œå› ä¸ºæ˜¯ç»4æ¬¡poolåæåˆ°çš„ç‰¹å¾ï¼Œæ•…feature mapè¾ƒ</span>
        <span class="token comment"># åŸå›¾ç¼©å°äº†16å€</span>
        anchor <span class="token operator">=</span> _enumerate_shifted_anchor<span class="token punctuation">(</span>
            np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>anchor_base<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">/</span>
            self<span class="token punctuation">.</span>feat_stride<span class="token punctuation">,</span> hh<span class="token punctuation">,</span> ww<span class="token punctuation">)</span>
        
        <span class="token comment"># ï¼ˆhh * ww * 9ï¼‰/hh*ww = 9 </span>
        n_anchor <span class="token operator">=</span> anchor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> <span class="token punctuation">(</span>hh <span class="token operator">*</span> ww<span class="token punctuation">)</span> 
        <span class="token comment"># 512ä¸ª3x3å·ç§¯(512, H/16,W/16)</span>
        h <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># n_anchorï¼ˆ9ï¼‰* 4ä¸ª1x1å·ç§¯ï¼Œå›å½’åæ ‡åç§»é‡ã€‚ï¼ˆ9*4ï¼Œhh,ww)</span>
        rpn_locs <span class="token operator">=</span> self<span class="token punctuation">.</span>loc<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
        <span class="token comment"># UNNOTE: check whether need contiguous</span>
        <span class="token comment"># A: Yes</span>
        <span class="token comment"># è½¬æ¢ä¸ºï¼ˆnï¼Œhhï¼Œwwï¼Œ9*4ï¼‰åå˜ä¸ºï¼ˆnï¼Œhh*ww*9ï¼Œ4ï¼‰</span>
        rpn_locs <span class="token operator">=</span> rpn_locs<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token comment"># n_anchorï¼ˆ9ï¼‰*2ä¸ª1x1å·ç§¯ï¼Œå›å½’ç±»åˆ«ã€‚ï¼ˆ9*2ï¼Œhh,wwï¼‰</span>
        rpn_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>score<span class="token punctuation">(</span>h<span class="token punctuation">)</span>
        <span class="token comment"># è½¬æ¢ä¸ºï¼ˆnï¼Œhhï¼Œwwï¼Œ9*2ï¼‰</span>
        rpn_scores <span class="token operator">=</span> rpn_scores<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># è®¡ç®—&#123;Softmax&#125;(x_&#123;i&#125;) = \&#123;enp(x_i)&#125;&#123;\sum_j enp(x_j)&#125;</span>
        rpn_softmax_scores <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>rpn_scores<span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> hh<span class="token punctuation">,</span> ww<span class="token punctuation">,</span> n_anchor<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token comment"># å¾—åˆ°å‰æ™¯çš„åˆ†ç±»æ¦‚ç‡</span>
        rpn_fg_scores <span class="token operator">=</span> rpn_softmax_scores<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># å¾—åˆ°æ‰€æœ‰anchorçš„å‰æ™¯åˆ†ç±»æ¦‚ç‡</span>
        rpn_fg_scores <span class="token operator">=</span> rpn_fg_scores<span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># å¾—åˆ°æ¯ä¸€å¼ feature mapä¸Šæ‰€æœ‰anchorçš„ç½‘ç»œè¾“å‡ºå€¼</span>
        rpn_scores <span class="token operator">=</span> rpn_scores<span class="token punctuation">.</span>view<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        rois <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        roi_indices <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># nä¸ºbatch_sizeæ•°</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># è°ƒç”¨ProposalCreatorå‡½æ•°ï¼Œ rpn_locsç»´åº¦ï¼ˆhh*ww*9ï¼Œ4ï¼‰</span>
            <span class="token comment"># ï¼Œrpn_fg_scoresç»´åº¦ä¸ºï¼ˆhh*ww*9ï¼‰ï¼Œanchorçš„ç»´åº¦ä¸º</span>
            <span class="token comment"># ï¼ˆhh*ww*9ï¼Œ4ï¼‰ï¼Œ img_sizeçš„ç»´åº¦ä¸ºï¼ˆ3ï¼ŒHï¼ŒWï¼‰ï¼ŒHå’ŒWæ˜¯</span>
            <span class="token comment"># ç»è¿‡æ•°æ®é¢„å¤„ç†åçš„ã€‚è®¡ç®—ï¼ˆH/16ï¼‰x(W/16)x9(å¤§æ¦‚20000)</span>
            <span class="token comment"># ä¸ªanchorå±äºå‰æ™¯çš„æ¦‚ç‡ï¼Œå–å‰12000ä¸ªå¹¶ç»è¿‡NMSå¾—åˆ°2000ä¸ª</span>
            <span class="token comment"># è¿‘ä¼¼ç›®æ ‡æ¡†G^çš„åæ ‡ã€‚roiçš„ç»´åº¦ä¸º(2000,4)</span>
            roi <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_layer<span class="token punctuation">(</span>
                rpn_locs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                rpn_fg_scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                anchor<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span>
                scale<span class="token operator">=</span>scale<span class="token punctuation">)</span>
            batch_index <span class="token operator">=</span> i <span class="token operator">*</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
            <span class="token comment"># roisä¸ºæ‰€æœ‰batch_sizeçš„roi</span>
            rois<span class="token punctuation">.</span>append<span class="token punctuation">(</span>roi<span class="token punctuation">)</span>
            roi_indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span>batch_index<span class="token punctuation">)</span>
        <span class="token comment"># æŒ‰è¡Œæ‹¼æ¥ï¼ˆå³æ²¡æœ‰batch_sizeçš„åŒºåˆ†ï¼Œæ¯ä¸€ä¸ª[]é‡Œéƒ½æ˜¯ä¸€ä¸ªanchorçš„å››ä¸ªåæ ‡ï¼‰</span>
        rois <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>rois<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># è¿™ä¸ª roi_indicesåœ¨æ­¤ä»£ç ä¸­æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºæˆ‘ä»¬å®ç°çš„æ˜¯batch_siae=1çš„</span>
        <span class="token comment"># ç½‘ç»œï¼Œä¸€ä¸ªbatchåªä¼šè¾“å…¥ä¸€å¼ å›¾è±¡ã€‚å¦‚æœå¤šå¼ å›¾åƒçš„è¯å°±éœ€è¦å­˜å‚¨ç´¢å¼•ä»¥æ‰¾åˆ°</span>
        <span class="token comment"># å¯¹åº”å›¾åƒçš„roi</span>
        roi_indices <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>roi_indices<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># rpn_locsçš„ç»´åº¦ï¼ˆhh*ww*9ï¼Œ4ï¼‰ï¼Œrpn_scoresç»´åº¦ä¸ºï¼ˆhh*ww*9ï¼Œ2ï¼‰ï¼Œ</span>
        <span class="token comment"># roisçš„ç»´åº¦ä¸ºï¼ˆ2000,4ï¼‰ï¼Œroi_indicesç”¨ä¸åˆ°ï¼Œ</span>
        <span class="token comment"># anchorçš„ç»´åº¦ä¸ºï¼ˆhh*ww*9ï¼Œ4ï¼‰</span>
        <span class="token keyword">return</span> rpn_locs<span class="token punctuation">,</span> rpn_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">,</span> anchor</code></pre>
<p>å¯ä»¥çœ‹åˆ°RegionProposalNetworkç»§æ‰¿äºnn.Moduleï¼Œè¿™ä¸ªç½‘ç»œæˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªæ¨æ–‡è®²çš„å¾ˆç»†èŠ‚äº†ï¼Œåœ¨ç»§ç»­é˜…è¯»ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ å·²ç»ç†è§£äº†RPNå’ŒROI Headã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“åœ¨<code>model/roi_module.py</code>é‡Œé¢ä¸»è¦åˆ©ç”¨äº†<code>cupy</code>(ä¸“ç”¨äºGPUçš„numpy)å®ç°ROI Poolingçš„å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ã€‚NMSå’ŒROI poolingåˆ©ç”¨äº†ï¼š<strong>ã€Œcupyã€</strong>å’Œ<strong>ã€Œchainerã€</strong> ã€‚</p>
<p>å…¶ä¸»è¦ä»»åŠ¡æ˜¯å¯¹äºä¸€å¼ å›¾åƒå¾—åˆ°çš„ç‰¹å¾å›¾()ï¼Œç„¶ååˆ©ç”¨<code>sample_roi</code>çš„bboxåæ ‡å»åœ¨ç‰¹å¾å›¾ä¸Šè£å‰ªä¸‹æ¥æ‰€æœ‰<code>roi</code>å¯¹åº”çš„ç‰¹å¾å›¾ï¼ˆè®­ç»ƒï¼šï¼‰ã€ï¼ˆæµ‹è¯•ï¼šï¼‰ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æ­å»ºç½‘ç»œæ¨¡å‹çš„æ–‡ä»¶<code>model/faster_rcnn.py</code>ï¼Œè¿™ä¸ªè„šæœ¬å®šä¹‰äº†Faster RCNNçš„åŸºæœ¬ç±»<strong>ã€ŒFasterRCNNã€</strong>ã€‚æˆ‘ä»¬çŸ¥é“Faster RCNNçš„ä¸‰ä¸ªæ ¸å¿ƒæ­¥éª¤å°±æ˜¯ï¼š</p>
<ul>
<li>ç‰¹å¾æå–ï¼šè¾“å…¥ä¸€å¼ å›¾ç‰‡å¾—åˆ°å…¶ç‰¹å¾å›¾feature map</li>
<li>RPNï¼šç»™å®šç‰¹å¾å›¾åäº§ç”Ÿä¸€ç³»åˆ—RoIs</li>
<li>ROI Headï¼šåˆ©ç”¨è¿™äº›RoIså¯¹åº”çš„ç‰¹å¾å›¾å¯¹è¿™äº›RoIsä¸­çš„ç±»åˆ«è¿›è¡Œåˆ†ç±»ï¼Œå¹¶æå‡å®šä½ç²¾åº¦</li>
</ul>
<p>åœ¨<strong>ã€ŒFasterRCNNã€</strong>è¿™ä¸ªç±»ä¸­å°±åˆå§‹åŒ–äº†è¿™ä¸‰ä¸ªé‡è¦çš„æ­¥éª¤ï¼Œå³<code>self.extrator</code>ï¼Œ<code>self.rpn</code>ï¼Œ<code>self.head</code>ã€‚</p>
<p><strong>ã€ŒFasterRCNNã€</strong>ç±»ä¸­ï¼Œ<code>forward</code>å‡½æ•°å®ç°å‰å‘ä¼ æ’­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># å®ç°å‰å‘ä¼ æ’­</span>
        img_size <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

        h <span class="token operator">=</span> self<span class="token punctuation">.</span>extractor<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        rpn_locs<span class="token punctuation">,</span> rpn_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">,</span> anchor <span class="token operator">=</span> \
            self<span class="token punctuation">.</span>rpn<span class="token punctuation">(</span>h<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> scale<span class="token punctuation">)</span>
        roi_cls_locs<span class="token punctuation">,</span> roi_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>head<span class="token punctuation">(</span>
            h<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">)</span>
        <span class="token keyword">return</span> roi_cls_locs<span class="token punctuation">,</span> roi_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices</code></pre>
<p>ä¹Ÿå¯ä»¥ç”¨ä¸‹å›¾æ¥æ›´æ¸…æ™°çš„è¡¨ç¤ºï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193439.png" srcset="/img/loading.gif" alt="Faster RCNNå‰å‘ä¼ æ’­ç½‘ç»œ"></p>
<p>è€Œè¿™ä¸ª<code>forward</code>è¿‡ç¨‹ä¸­è¾¹ç•Œæ¡†çš„æ•°é‡å˜åŒ–å¯ä»¥è¡¨ç¤ºä¸ºä¸‹å›¾ï¼š</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193420.png" srcset="/img/loading.gif" alt="è¾¹ç•Œæ¡†æ•°é‡å˜åŒ–"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹é¢„æµ‹å‡½æ•°<code>predict</code>ï¼Œè¿™ä¸ªå‡½æ•°å®ç°äº†å¯¹æµ‹è¯•é›†å›¾ç‰‡çš„é¢„æµ‹ï¼ŒåŒæ ·<code>batch=1</code>ï¼Œå³æ¯æ¬¡è¾“å…¥ä¸€å¼ å›¾ç‰‡ã€‚è¯¦è§£å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> imgs<span class="token punctuation">,</span>sizes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>visualize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># è®¾ç½®ä¸ºevalæ¨¡å¼</span>
        self<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># æ˜¯å¦å¼€å¯å¯è§†åŒ–</span>
        <span class="token keyword">if</span> visualize<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>use_preset<span class="token punctuation">(</span><span class="token string">'visualize'</span><span class="token punctuation">)</span>
            prepared_imgs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            sizes <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> img <span class="token keyword">in</span> imgs<span class="token punctuation">:</span>
                size <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                img <span class="token operator">=</span> preprocess<span class="token punctuation">(</span>at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">)</span>
                prepared_imgs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
                sizes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
             prepared_imgs <span class="token operator">=</span> imgs 
        bboxes <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        labels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        scores <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> img<span class="token punctuation">,</span> size <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>prepared_imgs<span class="token punctuation">,</span> sizes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># å¯¹è¯»å…¥çš„å›¾ç‰‡æ±‚å°ºåº¦scaleï¼Œå› ä¸ºè¾“å…¥çš„å›¾åƒç»é¢„å¤„ç†å°±ä¼šæœ‰ç¼©æ”¾ï¼Œ</span>
            <span class="token comment"># æ‰€ä»¥éœ€è®°å½•ç¼©æ”¾å› å­scaleï¼Œè¿™ä¸ªç¼©æ”¾å› å­åœ¨ProposalCreator</span>
            <span class="token comment"># ç­›é€‰roiæ—¶æœ‰ç”¨åˆ°ï¼Œå³å°†æ‰€æœ‰å€™é€‰æ¡†æŒ‰è¿™ä¸ªç¼©æ”¾å› å­æ˜ å°„å›åŸå›¾ï¼Œ</span>
            <span class="token comment"># è¶…å‡ºåŸå›¾è¾¹æ¡†çš„è¶‹äºå°†è¢«æˆªæ–­ã€‚</span>
            scale <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token comment"># æ‰§è¡Œforward</span>
            roi_cls_loc<span class="token punctuation">,</span> roi_scores<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">(</span>img<span class="token punctuation">,</span> scale<span class="token operator">=</span>scale<span class="token punctuation">)</span>
            <span class="token comment"># We are assuming that batch size is 1.</span>

            roi_score <span class="token operator">=</span> roi_scores<span class="token punctuation">.</span>data
            roi_cls_loc <span class="token operator">=</span> roi_cls_loc<span class="token punctuation">.</span>data
            roi <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>rois<span class="token punctuation">)</span> <span class="token operator">/</span> scale

            <span class="token comment"># Convert predictions to bounding boxes in image coordinates.</span>
            <span class="token comment"># Bounding boxes are scaled to the scale of the input images.</span>
            <span class="token comment"># ä¸ºProposalCreatorå¯¹locåšäº†å½’ä¸€åŒ–ï¼ˆ-mean /stdï¼‰å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œ</span>
            <span class="token comment"># éœ€è¦å†*std+meanï¼Œæ­¤æ—¶çš„ä½ç½®å‚æ•°locä¸ºroi_cls_locã€‚ç„¶åå°†è¿™128</span>
            <span class="token comment"># ä¸ªroiåˆ©ç”¨roi_cls_locè¿›è¡Œå¾®è°ƒï¼Œå¾—åˆ°æ–°çš„cls_bboxã€‚</span>
            mean <span class="token operator">=</span> t<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>loc_normalize_mean<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \
                repeat<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_class<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
            std <span class="token operator">=</span> t<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>loc_normalize_std<span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span> \
                repeat<span class="token punctuation">(</span>self<span class="token punctuation">.</span>n_class<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>

            roi_cls_loc <span class="token operator">=</span> <span class="token punctuation">(</span>roi_cls_loc <span class="token operator">*</span> std <span class="token operator">+</span> mean<span class="token punctuation">)</span>
            roi_cls_loc <span class="token operator">=</span> roi_cls_loc<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
            roi <span class="token operator">=</span> roi<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>enpand_as<span class="token punctuation">(</span>roi_cls_loc<span class="token punctuation">)</span>
            cls_bbox <span class="token operator">=</span> loc2bbox<span class="token punctuation">(</span>at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>roi_cls_loc<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            cls_bbox <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>cls_bbox<span class="token punctuation">)</span>
            cls_bbox <span class="token operator">=</span> cls_bbox<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token comment"># clip bounding box</span>
            cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>cls_bbox<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># å¯¹äºåˆ†ç±»å¾—åˆ†roi_scoresï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ç»è¿‡softmaxåè½¬ä¸ºæ¦‚ç‡probã€‚</span>
            <span class="token comment"># å€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬æ­¤æ—¶å¾—åˆ°çš„æ˜¯å¯¹æ‰€æœ‰è¾“å…¥128ä¸ªroiä»¥åŠä½ç½®å‚æ•°ã€å¾—åˆ†</span>
            <span class="token comment"># çš„é¢„å¤„ç†ï¼Œä¸‹é¢å°†ç­›é€‰å‡ºæœ€åæœ€ç»ˆçš„é¢„æµ‹ç»“æœã€‚</span>
            prob <span class="token operator">=</span> at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>roi_score<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            raw_cls_bbox <span class="token operator">=</span> at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>cls_bbox<span class="token punctuation">)</span>
            raw_prob <span class="token operator">=</span> at<span class="token punctuation">.</span>tonumpy<span class="token punctuation">(</span>prob<span class="token punctuation">)</span>

            bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> score <span class="token operator">=</span> self<span class="token punctuation">.</span>_suppress<span class="token punctuation">(</span>raw_cls_bbox<span class="token punctuation">,</span> raw_prob<span class="token punctuation">)</span>
            bboxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>bbox<span class="token punctuation">)</span>
            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
            scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>use_preset<span class="token punctuation">(</span><span class="token string">'evaluate'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> bboxes<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> scores</code></pre>
<p><strong>ã€Œæ³¨æ„ï¼ã€</strong> è®­ç»ƒå®Œ<code>train_datasets</code>ä¹‹åï¼Œ<code>model</code>è¦æ¥æµ‹è¯•æ ·æœ¬äº†ã€‚åœ¨<code>model(test_datasets)</code>ä¹‹å‰ï¼Œéœ€è¦åŠ ä¸Š<code>model.eval()</code>ã€‚å¦åˆ™çš„è¯ï¼Œæœ‰è¾“å…¥æ•°æ®ï¼Œå³ä½¿ä¸è®­ç»ƒï¼Œå®ƒä¹Ÿä¼šæ”¹å˜æƒå€¼ã€‚è¿™æ˜¯<code>model</code>ä¸­å«æœ‰<code>batch normalization</code>å±‚æ‰€å¸¦æ¥çš„çš„æ€§è´¨ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°åœ¨ç¬¬ä¸€è¡Œä½¿ç”¨äº†<code>self.eval()</code>ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨æœ€åä¸€è¡Œå‡½æ•°è¿”å›<code>bboxes</code>ï¼Œ<code>labels</code>ï¼Œ<code>scores</code>ä¹‹åè¿˜è¦åŠ ä¸€è¡Œ<code>self.train</code>å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºè¿™æ¬¡é¢„æµ‹ä¹‹åä¸‹æ¬¡è¦æ¥ç€è®­ç»ƒï¼Œè®­ç»ƒçš„æ—¶å€™éœ€è¦è®¾ç½®æ¨¡å‹ç±»å‹ä¸º<code>train</code>ã€‚</p>
<p><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20200505193707.png" srcset="/img/loading.gif" alt="model.trainå’Œmodel.evalå—åˆ°ç½‘ç»œé‡Œé¢BNå’ŒDropoutçš„å½±å“"></p>
<p>ä¸Šé¢çš„æ­¥éª¤æ˜¯å¯¹ç½‘ç»œRoIheadç½‘ç»œè¾“å‡ºçš„é¢„å¤„ç†ï¼Œå‡½æ•°<code>_suppress</code>å°†å¾—åˆ°çœŸæ­£çš„é¢„æµ‹ç»“æœã€‚<code>_suppress</code>å‡½æ•°è§£é‡Šå¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># predictå‡½æ•°æ˜¯å¯¹ç½‘ç»œRoIheadç½‘ç»œè¾“å‡ºçš„é¢„å¤„ç†</span>
    <span class="token comment"># å‡½æ•°_suppresså°†å¾—åˆ°çœŸæ­£çš„é¢„æµ‹ç»“æœã€‚</span>
    <span class="token comment"># æ­¤å‡½æ•°æ˜¯ä¸€ä¸ªæŒ‰ç±»åˆ«çš„å¾ªç¯ï¼Œlä»1è‡³20ï¼ˆ0ç±»ä¸ºèƒŒæ™¯ç±»ï¼‰ã€‚</span>
    <span class="token comment"># å³é¢„æµ‹æ€æƒ³æ˜¯æŒ‰20ä¸ªç±»åˆ«é¡ºåºä¾æ¬¡éªŒè¯ï¼Œå¦‚æœæœ‰æ»¡è¶³è¯¥ç±»çš„é¢„æµ‹ç»“æœï¼Œ</span>
    <span class="token comment"># åˆ™è®°å½•ï¼Œå¦åˆ™è½¬å…¥ä¸‹ä¸€ç±»ï¼ˆä¸€å¼ å›¾ä¸­ä¹Ÿå°±å‡ ä¸ªç±»åˆ«è€Œå·²ï¼‰ã€‚ä¾‹å¦‚ç­›é€‰</span>
    <span class="token comment"># é¢„æµ‹å‡ºç¬¬1ç±»çš„ç»“æœï¼Œé¦–å…ˆåœ¨cls_bboxä¸­å°†æ‰€æœ‰128ä¸ªé¢„æµ‹ç¬¬1ç±»çš„</span>
    <span class="token comment"># bboxåæ ‡æ‰¾å‡ºï¼Œç„¶åä»probä¸­æ‰¾å‡º128ä¸ªç¬¬1ç±»çš„æ¦‚ç‡ã€‚å› ä¸ºé˜ˆå€¼ä¸º0.7ï¼Œ</span>
    <span class="token comment"># ä¹Ÿå³æ¦‚ç‡>0.7çš„æ‰€æœ‰è¾¹æ¡†åˆæ­¥è¢«åˆ¤å®šé¢„æµ‹æ­£ç¡®ï¼Œè®°å½•ä¸‹æ¥ã€‚ç„¶è€Œå¯èƒ½æœ‰</span>
    <span class="token comment"># å¤šä¸ªè¾¹æ¡†é¢„æµ‹ç¬¬1ç±»ä¸­åŒä¸€ä¸ªç‰©ä½“ï¼ŒåŒç±»ä¸­ä¸€ä¸ªç‰©ä½“åªéœ€ä¸€ä¸ªè¾¹æ¡†ï¼Œ</span>
    <span class="token comment"># æ‰€ä»¥éœ€å†ç»åŸºäºç±»çš„NMSåä½¿å¾—æ¯ç±»æ¯ä¸ªç‰©ä½“åªæœ‰ä¸€ä¸ªè¾¹æ¡†ï¼Œè‡³æ­¤</span>
    <span class="token comment"># ç¬¬1ç±»é¢„æµ‹å®Œæˆï¼Œè®°å½•ç¬¬1ç±»çš„æ‰€æœ‰è¾¹æ¡†åæ ‡ã€æ ‡ç­¾ã€ç½®ä¿¡åº¦ã€‚</span>
    <span class="token comment"># æ¥ç€ä¸‹ä¸€ç±»...ï¼Œç›´è‡³20ç±»éƒ½è®°å½•ä¸‹æ¥ï¼Œé‚£ä¹ˆä¸€å¼ å›¾ç‰‡ï¼ˆä¹Ÿå³ä¸€ä¸ªbatchï¼‰</span>
    <span class="token comment"># çš„é¢„æµ‹ä¹Ÿå°±ç»“æŸäº†ã€‚</span>
    <span class="token keyword">def</span> <span class="token function">_suppress</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_cls_bbox<span class="token punctuation">,</span> raw_prob<span class="token punctuation">)</span><span class="token punctuation">:</span>
        bbox <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        score <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># skip cls_id = 0 because it is the background class</span>
        <span class="token keyword">for</span> l <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class<span class="token punctuation">)</span><span class="token punctuation">:</span>
            cls_bbox_l <span class="token operator">=</span> raw_cls_bbox<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_class<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
            prob_l <span class="token operator">=</span> raw_prob<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> l<span class="token punctuation">]</span>
            mask <span class="token operator">=</span> prob_l <span class="token operator">></span> self<span class="token punctuation">.</span>score_thresh
            cls_bbox_l <span class="token operator">=</span> cls_bbox_l<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
            prob_l <span class="token operator">=</span> prob_l<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
            keep <span class="token operator">=</span> non_maximum_suppression<span class="token punctuation">(</span>
                cp<span class="token punctuation">.</span>array<span class="token punctuation">(</span>cls_bbox_l<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nms_thresh<span class="token punctuation">,</span> prob_l<span class="token punctuation">)</span>
            keep <span class="token operator">=</span> cp<span class="token punctuation">.</span>asnumpy<span class="token punctuation">(</span>keep<span class="token punctuation">)</span>
            bbox<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cls_bbox_l<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment"># The labels are in [0, self.n_class - 2].</span>
            label<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>keep<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            score<span class="token punctuation">.</span>append<span class="token punctuation">(</span>prob_l<span class="token punctuation">[</span>keep<span class="token punctuation">]</span><span class="token punctuation">)</span>
        bbox <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>bbox<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        label <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>label<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
        score <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>score<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bbox<span class="token punctuation">,</span> label<span class="token punctuation">,</span> score</code></pre>
<p>è¿™é‡Œè¿˜å®šä¹‰äº†ä¼˜åŒ–å™¨optimizerï¼Œå¯¹äºéœ€è¦æ±‚å¯¼çš„å‚æ•° æŒ‰ç…§æ˜¯å¦å«biasèµ‹äºˆä¸åŒçš„å­¦ä¹ ç‡ã€‚é»˜è®¤æ˜¯ä½¿ç”¨SGDï¼Œå¯é€‰Adamï¼Œä¸è¿‡éœ€æ›´å°çš„å­¦ä¹ ç‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># å®šä¹‰äº†ä¼˜åŒ–å™¨optimizerï¼Œå¯¹äºéœ€è¦æ±‚å¯¼çš„å‚æ•° æŒ‰ç…§æ˜¯å¦å«biasèµ‹äºˆä¸åŒçš„å­¦ä¹ ç‡ã€‚</span>
    <span class="token comment"># é»˜è®¤æ˜¯ä½¿ç”¨SGDï¼Œå¯é€‰Adamï¼Œä¸è¿‡éœ€æ›´å°çš„å­¦ä¹ ç‡ã€‚</span>
    <span class="token keyword">def</span> <span class="token function">get_optimizer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        return optimizer, It could be overwriten if you want to specify 
        special optimizer
        """</span>
        lr <span class="token operator">=</span> opt<span class="token punctuation">.</span>lr
        params <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> value<span class="token punctuation">.</span>requires_grad<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token string">'bias'</span> <span class="token keyword">in</span> key<span class="token punctuation">:</span>
                    params <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'params'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'lr'</span><span class="token punctuation">:</span> lr <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    params <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'params'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'lr'</span><span class="token punctuation">:</span> lr<span class="token punctuation">,</span> <span class="token string">'weight_decay'</span><span class="token punctuation">:</span> opt<span class="token punctuation">.</span>weight_decay<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> opt<span class="token punctuation">.</span>use_adam<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> t<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>optimizer <span class="token operator">=</span> t<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>params<span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>optimizer

    <span class="token keyword">def</span> <span class="token function">scale_lr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decay<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> param_group <span class="token keyword">in</span> self<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>param_groups<span class="token punctuation">:</span>
            param_group<span class="token punctuation">[</span><span class="token string">'lr'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> decay
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>optimizer</code></pre>
<p>è§£é‡Šå®Œäº†è¿™ä¸ªåŸºç±»ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä»½ä»£ç é‡Œé¢å®ç°çš„åŸºäºVGG16çš„Faster RCNNçš„è¿™ä¸ªç±»<code>FasterRCNNVGG16</code>ï¼Œå®ƒç»§æ‰¿äº†<strong>ã€ŒFasterRCNNã€</strong>ã€‚</p>
<p>é¦–å…ˆå¼•å…¥VGG16ï¼Œç„¶åæ‹†åˆ†ä¸ºç‰¹å¾æå–ç½‘ç»œå’Œåˆ†ç±»ç½‘ç»œã€‚å†»ç»“åˆ†ç±»ç½‘ç»œçš„å‰å‡ å±‚ï¼Œä¸è¿›è¡Œåå‘ä¼ æ’­ã€‚</p>
<p>ç„¶åå®ç°<strong>ã€ŒVGG16RoIHeadã€</strong>ç½‘ç»œã€‚å®ç°è¾“å…¥ç‰¹å¾å›¾ã€<code>rois</code>ã€<code>roi_indices</code>,è¾“å‡º<code>roi_cls_locs</code>å’Œ<code>roi_scores</code>ã€‚</p>
<p>ç±»<code>FasterRCNNVGG16</code>åˆ†åˆ«å¯¹VGG16çš„ç‰¹å¾æå–éƒ¨åˆ†ã€åˆ†ç±»éƒ¨åˆ†ã€RPNç½‘ç»œã€VGG16RoIHeadç½‘ç»œè¿›è¡Œäº†å®ä¾‹åŒ–ã€‚</p>
<p>æ­¤å¤–åœ¨å¯¹VGG16RoIHeadç½‘ç»œçš„å…¨è¿æ¥å±‚æƒé‡åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼ŒæŒ‰ç…§å›¾åƒæ˜¯å¦ä¸º<code>truncated</code>ï¼ˆæˆªæ–­ï¼‰åˆ†äº†ä¸¤ç§åˆå§‹åŒ–åˆ†æ–¹æ³•ï¼Œè‡³äºè¿™ä¸ªæˆªæ–­å…·ä½“æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Œä¹Ÿä¸æ˜¯å¾ˆæ˜ç™½è¿™é‡Œä¼¼ä¹ä¹Ÿæ²¡ç”¨ã€‚</p>
<p>è¯¦ç»†è§£é‡Šå¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">decom_vgg16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># the 30th layer of features is relu of conv5_3</span>
    <span class="token comment"># æ˜¯å¦ä½¿ç”¨Caffeä¸‹è½½ä¸‹æ¥çš„é¢„è®­ç»ƒæ¨¡å‹</span>
    <span class="token keyword">if</span> opt<span class="token punctuation">.</span>caffe_pretrain<span class="token punctuation">:</span>
        model <span class="token operator">=</span> vgg16<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>load_path<span class="token punctuation">:</span>
            <span class="token comment"># åŠ è½½å‚æ•°ä¿¡æ¯</span>
            model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>t<span class="token punctuation">.</span>load<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>caffe_pretrain_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        model <span class="token operator">=</span> vgg16<span class="token punctuation">(</span><span class="token keyword">not</span> opt<span class="token punctuation">.</span>load_path<span class="token punctuation">)</span>

    <span class="token comment"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹vgg16çš„conv5_3ä¹‹å‰çš„éƒ¨åˆ†</span>
    features <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>features<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">]</span>

    classifier <span class="token operator">=</span> model<span class="token punctuation">.</span>classifier
    <span class="token comment"># åˆ†ç±»éƒ¨åˆ†æ”¾åˆ°ä¸€ä¸ªlisté‡Œé¢</span>
    classifier <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>classifier<span class="token punctuation">)</span>
    <span class="token comment"># åˆ é™¤è¾“å‡ºåˆ†ç±»ç»“æœå±‚</span>
    <span class="token keyword">del</span> classifier<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
    <span class="token comment"># åˆ é™¤ä¸¤ä¸ªdropout</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> opt<span class="token punctuation">.</span>use_drop<span class="token punctuation">:</span>
        <span class="token keyword">del</span> classifier<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
        <span class="token keyword">del</span> classifier<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    classifier <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>classifier<span class="token punctuation">)</span>

    <span class="token comment"># å†»ç»“vgg16å‰2ä¸ªstage,ä¸è¿›è¡Œåå‘ä¼ æ’­</span>
    <span class="token keyword">for</span> layer <span class="token keyword">in</span> features<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> p <span class="token keyword">in</span> layer<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            p<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token comment"># æ‹†åˆ†ä¸ºç‰¹å¾æå–ç½‘ç»œå’Œåˆ†ç±»ç½‘ç»œ</span>
    <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>features<span class="token punctuation">)</span><span class="token punctuation">,</span> classifier


<span class="token comment"># åˆ†åˆ«å¯¹ç‰¹å¾VGG16çš„ç‰¹å¾æå–éƒ¨åˆ†ã€åˆ†ç±»éƒ¨åˆ†ã€RPNç½‘ç»œã€</span>
<span class="token comment"># VGG16RoIHeadç½‘ç»œè¿›è¡Œäº†å®ä¾‹åŒ–</span>
<span class="token keyword">class</span> <span class="token class-name">FasterRCNNVGG16</span><span class="token punctuation">(</span>FasterRCNN<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># vgg16é€šè¿‡5ä¸ªstageä¸‹é‡‡æ ·16å€</span>
    feat_stride <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># downsample 16x for output of conv5 in vgg16</span>
    <span class="token comment"># æ€»ç±»åˆ«æ•°ä¸º20ç±»ï¼Œä¸‰ç§å°ºåº¦ä¸‰ç§æ¯”ä¾‹çš„anchor</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 n_fg_class<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
                 ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 anchor_scales<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token comment"># conv5_3åŠä¹‹å‰çš„éƒ¨åˆ†ï¼Œåˆ†ç±»å™¨</span>
        extractor<span class="token punctuation">,</span> classifier <span class="token operator">=</span> decom_vgg16<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># è¿”å›rpn_locs, rpn_scores, rois, roi_indices, anchor</span>
        rpn <span class="token operator">=</span> RegionProposalNetwork<span class="token punctuation">(</span>
            <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span>
            ratios<span class="token operator">=</span>ratios<span class="token punctuation">,</span>
            anchor_scales<span class="token operator">=</span>anchor_scales<span class="token punctuation">,</span>
            feat_stride<span class="token operator">=</span>self<span class="token punctuation">.</span>feat_stride<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token comment"># ä¸‹é¢è®²</span>
        head <span class="token operator">=</span> VGG16RoIHead<span class="token punctuation">(</span>
            n_class<span class="token operator">=</span>n_fg_class <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
            roi_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>
            spatial_scale<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>feat_stride<span class="token punctuation">)</span><span class="token punctuation">,</span>
            classifier<span class="token operator">=</span>classifier
        <span class="token punctuation">)</span>

        <span class="token builtin">super</span><span class="token punctuation">(</span>FasterRCNNVGG16<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
            extractor<span class="token punctuation">,</span>
            rpn<span class="token punctuation">,</span>
            head<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">VGG16RoIHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n_class<span class="token punctuation">,</span> roi_size<span class="token punctuation">,</span> spatial_scale<span class="token punctuation">,</span>
                 classifier<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># n_class includes the background</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>VGG16RoIHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># vgg16ä¸­çš„æœ€åä¸¤ä¸ªå…¨è¿æ¥å±‚</span>
        self<span class="token punctuation">.</span>classifier <span class="token operator">=</span> classifier 
        self<span class="token punctuation">.</span>cls_loc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> n_class <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">,</span> n_class<span class="token punctuation">)</span>
        <span class="token comment"># å…¨è¿æ¥å±‚æƒé‡åˆå§‹åŒ–</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cls_loc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">)</span>
        normal_init<span class="token punctuation">(</span>self<span class="token punctuation">.</span>score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
        <span class="token comment"># åŠ ä¸ŠèƒŒæ™¯21ç±»</span>
        self<span class="token punctuation">.</span>n_class <span class="token operator">=</span> n_class
        <span class="token comment"># 7x7</span>
        self<span class="token punctuation">.</span>roi_size <span class="token operator">=</span> roi_size
        <span class="token comment"># 1/16</span>
        self<span class="token punctuation">.</span>spatial_scale <span class="token operator">=</span> spatial_scale
        <span class="token comment"># å°†å¤§å°ä¸åŒçš„roiå˜æˆå¤§å°ä¸€è‡´ï¼Œå¾—åˆ°poolingåçš„ç‰¹å¾ï¼Œ</span>
        <span class="token comment"># å¤§å°ä¸º[300, 512, 7, 7]ã€‚åˆ©ç”¨Cupyå®ç°åœ¨çº¿ç¼–è¯‘çš„</span>
        self<span class="token punctuation">.</span>roi <span class="token operator">=</span> RoIPooling2D<span class="token punctuation">(</span>self<span class="token punctuation">.</span>roi_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>roi_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>spatial_scale<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> rois<span class="token punctuation">,</span> roi_indices<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># å‰é¢è§£é‡Šè¿‡è¿™é‡Œçš„roi_indiceså…¶å®æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºbatch_sizeä¸€ç›´ä¸º1</span>
        <span class="token comment"># in case roi_indices is  ndarray</span>
        roi_indices <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>roi_indices<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#ndarray->tensor</span>
        rois <span class="token operator">=</span> at<span class="token punctuation">.</span>totensor<span class="token punctuation">(</span>rois<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        indices_and_rois <span class="token operator">=</span> t<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>roi_indices<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rois<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># NOTE: important: yx->xy</span>
        xy_indices_and_rois <span class="token operator">=</span> indices_and_rois<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment"># æŠŠtensorå˜æˆåœ¨å†…å­˜ä¸­è¿ç»­åˆ†å¸ƒçš„å½¢å¼</span>
        indices_and_rois <span class="token operator">=</span>  xy_indices_and_rois<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># æ¥ä¸‹æ¥åˆ†æroi_module.pyä¸­çš„RoIï¼ˆï¼‰</span>
        pool <span class="token operator">=</span> self<span class="token punctuation">.</span>roi<span class="token punctuation">(</span>x<span class="token punctuation">,</span> indices_and_rois<span class="token punctuation">)</span>
        <span class="token comment"># flatæ“ä½œ</span>
        pool <span class="token operator">=</span> pool<span class="token punctuation">.</span>view<span class="token punctuation">(</span>pool<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># decom_vgg16ï¼ˆï¼‰å¾—åˆ°çš„calssifier,å¾—åˆ°4096</span>
        fc7 <span class="token operator">=</span> self<span class="token punctuation">.</span>classifier<span class="token punctuation">(</span>pool<span class="token punctuation">)</span>
        <span class="token comment"># ï¼ˆ4096->84ï¼‰</span>
        roi_cls_locs <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_loc<span class="token punctuation">(</span>fc7<span class="token punctuation">)</span>
        <span class="token comment"># ï¼ˆ4096->21ï¼‰</span>
        roi_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>score<span class="token punctuation">(</span>fc7<span class="token punctuation">)</span>
        <span class="token keyword">return</span> roi_cls_locs<span class="token punctuation">,</span> roi_scores


<span class="token keyword">def</span> <span class="token function">normal_init</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> mean<span class="token punctuation">,</span> stddev<span class="token punctuation">,</span> truncated<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    weight initalizer: truncated normal and random normal.
    """</span>
    <span class="token comment"># x is a parameter</span>
    <span class="token keyword">if</span> truncated<span class="token punctuation">:</span>
        m<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fmod_<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mul_<span class="token punctuation">(</span>stddev<span class="token punctuation">)</span><span class="token punctuation">.</span>add_<span class="token punctuation">(</span>mean<span class="token punctuation">)</span>  <span class="token comment"># not a perfect approximation</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        m<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>mean<span class="token punctuation">,</span> stddev<span class="token punctuation">)</span>
        m<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/">è®¡ç®—æœºè§†è§‰</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Faster-RCNN/">Faster RCNN</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/5e67f605/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Numpy.prodé—®é¢˜</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/17e7acb0/">
                        <span class="hidden-mobile">frpå†…ç½‘ç©¿é€æ­å»ºæŒ‡å—</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "ViwB1XmjsmmXpFx2gikUmM5V-gzGzoHsz",
          app_key: "7r6Y8CzBkl8MJwPNmCqSdLWW",
          placeholder: "æ¥éƒ½æ¥äº†ï¼Œä¸è¯´ç‚¹ä»€ä¹ˆå—âŠ™(ãƒ»â—‡ãƒ»)ï¼Ÿ",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: false,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-tags-fill"></i>&nbsp;<a href="http://www.beian.miit.gov.cn/" target="_blank">é²ICPå¤‡19062448å·</a>&nbsp&nbsp;| &nbsp&nbsp <i class="iconfont icon-addrcard"></i>&nbsp; 2018~2022<a href="https://www.jngwl.top/" target="_blank"> æ¸…é£ä¸å½’_G</a>&nbsp&nbsp;|&nbsp&nbsp;  <i class="iconfont icon-docker"></i> <a href="https://hexo.io/" target="_blank">&nbsp Hexo</a>&nbsp & &nbsp <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank">Fluid</a><br> ä½ çš„éª„å‚²å¤šåŠæ¥è‡ªäºè‡ªå·±çš„æ— çŸ¥ï¼Œå…±å‹‰ä¹‹

  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud ç»Ÿè®¡PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="leancloud-site-pv"></span>
             æ¬¡
          </span>
      
      
        <!-- LeanCloud ç»Ÿè®¡UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="leancloud-site-uv"></span>
             äºº
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  
    
  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>



  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  

  

  

  

  

  





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>



</body>
</html>
