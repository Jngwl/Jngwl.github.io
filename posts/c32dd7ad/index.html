

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="清风与归_G">
  <meta name="keywords" content="">
  <title>Nginx使用手册 - 清风与归_G</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      
        
          
          
          
        
        <link  rel="stylesheet" href="https://cdn.staticfile.org/prism/1.22.0/themes/prism-tomorrow.min.css" />
      
      
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.jngwl.top","root":"/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"ViwB1XmjsmmXpFx2gikUmM5V-gzGzoHsz","app_key":"7r6Y8CzBkl8MJwPNmCqSdLWW","server_url":"https://viwb1xmj.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>清风与归_G</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20201121211851.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Nginx使用手册">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-06-15 20:13" pubdate>
        2021年6月15日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      34
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Nginx使用手册</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年6月21日 上午
                
              </p>
            
            <div class="markdown-body">
              <h2 id="一、安装Nginx"><a href="#一、安装Nginx" class="headerlink" title="一、安装Nginx"></a>一、安装Nginx</h2><p>Docker安装流程</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">docker pull nginx:1.10

docker run -p <span class="token number">80</span>:80 --name nginx -v /mydata/nginx/html:/usr/share/nginx/html -v /mydata/nginx/logs:/var/log/nginx  -d nginx:1.10

<span class="token comment"># 拷贝出容器中的配置文件</span>
docker container <span class="token function">cp</span> nginx:/etc/nginx /mydata/nginx/

<span class="token builtin class-name">cd</span> /mydata/nginx/
<span class="token function">ls</span>
<span class="token function">mv</span> nginx conf

docker stop nginx
docker <span class="token function">rm</span> nginx

<span class="token comment"># 再次运行容器，并关联配置文件</span>
docker run -p <span class="token number">80</span>:80 --name nginx -v /mydata/nginx/html:/usr/share/nginx/html -v /mydata/nginx/logs:/var/log/nginx  -v /mydata/nginx/conf:/etc/nginx -d nginx:1.10</code></pre>
<h2 id="二、Nginx概述"><a href="#二、Nginx概述" class="headerlink" title="二、Nginx概述"></a>二、Nginx概述</h2><p>Nginx是一个web服务器和反向代理服务器，常用于正向代理、反向代理、负载均衡及动静分离等等。</p>
<ul>
<li>占用内存小，可以实现高并发连接，处理响应快</li>
<li>配置简单，可以比较容易地实现反向代理和负载均衡</li>
<li>动态处理较差</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>作用</th>
<th>示例图</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>正向代理</td>
<td><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20210610204218.png" srcset="/img/loading.gif" alt=""></td>
<td><strong>对客户端进行代理</strong>，比如日常使用的VPN就是正向代理类型。</td>
</tr>
<tr>
<td>反向代理</td>
<td><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20210610204251.png" srcset="/img/loading.gif" alt=""></td>
<td><strong>对服务器进行代理</strong>，客户端将请求发送给反向代理服务器，由反向代理服务器选择目标服务器处理请求。隐藏了真实服务器的IP地址。</td>
</tr>
<tr>
<td>负载均衡</td>
<td><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20210610210040.png" srcset="/img/loading.gif" alt="对IP进行Hash,根据HashCode选择服务器"></td>
<td>将原先集中到单个服务器上的请求，分发到多个服务器上。常见的分发算法有轮询、加权、IPHash等</td>
</tr>
<tr>
<td>动静分离</td>
<td><img src="https://hexo-blog-1254804803.cos.ap-shanghai.myqcloud.com/img/20210610205234.png" srcset="/img/loading.gif" alt="image-20210610205231844"></td>
<td><strong>分离不需要后台处理的静态资源和需要后台服务器处理的动态资源</strong>，以提高资源响应速度。</td>
</tr>
</tbody>
</table>
</div>
<h2 id="三、负载均衡的策略"><a href="#三、负载均衡的策略" class="headerlink" title="三、负载均衡的策略"></a>三、负载均衡的策略</h2><ul>
<li>轮训</li>
<li>加权：权重越来，被访问的概率就越高</li>
<li>IP哈希：对用户的IP地址计算哈希值，根据哈希值分配服务器。使得来自同一个IP地址的访客固定访问同一个后端服务器，以解决session 共享等问题</li>
<li>fair，按后端服务器的响应时间来分配请求，响应时间短的服务器优先被分配请求</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20200711164908575.png" srcset="/img/loading.gif" alt=""></p>
<p><img src="https://img-blog.csdnimg.cn/20200711174757480.png" srcset="/img/loading.gif" alt=""></p>
<p><img src="https://img-blog.csdnimg.cn/20200711174852636.png" srcset="/img/loading.gif" alt=""></p>
<p><img src="https://img-blog.csdnimg.cn/20200711174837677.png" srcset="/img/loading.gif" alt=""></p>
<h2 id="四、配置文件解析"><a href="#四、配置文件解析" class="headerlink" title="四、配置文件解析"></a>四、配置文件解析</h2><p>主要包含全局配置块、events块、http块等。</p>
<p>请求过来时，Nginx先根据listen和server_name匹配server块，再根据location条件匹配具体的location块.</p>
<p>location对用户请求的URL进行匹配，匹配成功后再进行响应的操作</p>
<pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 优先级1，精确匹配。根路径 </span>
location <span class="token operator">=</span>/ <span class="token punctuation">&#123;</span> 
	<span class="token builtin class-name">return</span> <span class="token number">400</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 优先级2，匹配以某个字符串开头。此处匹配以av开头的路径，区分大小写 </span>
location ^~ /av <span class="token punctuation">&#123;</span> 
	root /data/av/<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 优先级3，区分大小写的正则匹配。匹配/media*****路径 </span>
location ~ /media <span class="token punctuation">&#123;</span> 
	<span class="token builtin class-name">alias</span> /data/static/<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">#优先级4 ，不区分大小写的正则匹配。所有的****.jpg|gif|png 都走这里 </span>
location ~* .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>jpg<span class="token operator">|</span>gif<span class="token operator">|</span>png<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span> 
	root /data/av/<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">#优先7，通用匹配 </span>
location / <span class="token punctuation">&#123;</span> 
	<span class="token builtin class-name">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>详细nginx.conf</p>
<pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 定义Nginx运行的用户和用户组</span>
user www www<span class="token punctuation">;</span>

<span class="token comment"># nginx进程数,建议设置为等于CPU总核心数.</span>
worker_processes <span class="token number">8</span><span class="token punctuation">;</span>

<span class="token comment"># 全局错误日志定义类型,[ debug | info | notice | warn | error | crit ]</span>
error_log /var/log/nginx/error.log info<span class="token punctuation">;</span>

<span class="token comment"># 进程文件</span>
pid /var/run/nginx.pid<span class="token punctuation">;</span>

<span class="token comment"># 一个nginx进程打开的最多文件描述符数目,建议与ulimit -n的值保持一致.</span>
worker_rlimit_nofile <span class="token number">65535</span><span class="token punctuation">;</span>

<span class="token comment"># 工作模式与连接数上限</span>
events
<span class="token punctuation">&#123;</span>
    <span class="token comment"># 参考事件模型,use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]</span>
    use epoll<span class="token punctuation">;</span>
    <span class="token comment"># 单个进程最大连接数，默认为512</span>
    worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>

<span class="token comment"># 设定http服务器</span>
http
<span class="token punctuation">&#123;</span>
    include mime.types<span class="token punctuation">;</span> <span class="token comment">#文件扩展名与文件类型映射表</span>
    default_type application/octet-stream<span class="token punctuation">;</span> <span class="token comment">#默认文件类型</span>
    charset utf-8<span class="token punctuation">;</span> <span class="token comment">#默认编码</span>
    server_names_hash_bucket_size <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">#服务器名字的hash表大小</span>
    client_header_buffer_size 32k<span class="token punctuation">;</span> <span class="token comment">#上传文件大小限制</span>
    large_client_header_buffers <span class="token number">4</span> 64k<span class="token punctuation">;</span> <span class="token comment">#设定请求缓</span>
    client_max_body_size 8m<span class="token punctuation">;</span> <span class="token comment">#设定请求缓</span>
    keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span>  <span class="token comment"># 连接超时时间，默认为75s，可以在http，server，location块。</span>
    autoindex on<span class="token punctuation">;</span> <span class="token comment"># 显示目录，默认关闭</span>
    autoindex_exact_size on<span class="token punctuation">;</span> <span class="token comment"># 显示文件确切大小，默认为on,单位是bytes</span>
    autoindex_localtime on<span class="token punctuation">;</span> <span class="token comment"># 显示文件本地时间，默认为off,GMT时间；改为on后,显示的文件时间为文件的服务器时间</span>
    
    sendfile on<span class="token punctuation">;</span> <span class="token comment"># 开启高效文件传输模式,sendfile指令指定nginx是否调用sendfile函数来输出文件,对于普通应用设为 on,如果用来进行下载等应用磁盘IO重负载应用,可设置为off,以平衡磁盘与网络I/O处理速度,降低系统的负载.注意：如果图片显示不正常把这个改成off.</span>
    tcp_nopush on<span class="token punctuation">;</span> <span class="token comment"># 防止网络阻塞</span>
    tcp_nodelay on<span class="token punctuation">;</span> <span class="token comment"># 防止网络阻塞</span>
    
    
    <span class="token comment"># FastCGI相关参数是为了改善网站的性能：减少资源占用,提高访问速度.下面参数看字面意思都能理解.</span>
    fastcgi_connect_timeout <span class="token number">300</span><span class="token punctuation">;</span> <span class="token comment">## 链接</span>
    fastcgi_send_timeout <span class="token number">300</span><span class="token punctuation">;</span>  <span class="token comment">##读取 是指nginx进程向fastcgi进程发送request的整个过程的超时时间</span>
    fastcgi_read_timeout <span class="token number">300</span><span class="token punctuation">;</span>  <span class="token comment">##发请求 是指fastcgi进程向nginx进程发送response的整个过程的超时时间</span>
    fastcgi_buffer_size 64k<span class="token punctuation">;</span>
    fastcgi_buffers <span class="token number">4</span> 64k<span class="token punctuation">;</span>
    fastcgi_busy_buffers_size 128k<span class="token punctuation">;</span>
    fastcgi_temp_file_write_size 128k<span class="token punctuation">;</span>
    
    <span class="token comment"># gzip模块设置</span>
    <span class="token function">gzip</span> on<span class="token punctuation">;</span> <span class="token comment">#开启gzip压缩输出</span>
    gzip_min_length 1k<span class="token punctuation">;</span> <span class="token comment">#允许压缩的页面的最小字节数,页面字节数从header偷得content-length中获取.默认是0,不管页面多大都进行压缩.建议设置成大于1k的字节数,小于1k可能会越压越大</span>
    gzip_buffers <span class="token number">4</span> 16k<span class="token punctuation">;</span> <span class="token comment">#表示申请4个单位为16k的内存作为压缩结果流缓存,默认值是申请与原始数据大小相同的内存空间来存储gzip压缩结果</span>
    gzip_http_version <span class="token number">1.1</span><span class="token punctuation">;</span> <span class="token comment">#压缩版本（默认1.1,目前大部分浏览器已经支持gzip解压.前端如果是squid2.5请使用1.0）</span>
    gzip_comp_level <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">#压缩等级.1压缩比最小,处理速度快.9压缩比最大,比较消耗cpu资源,处理速度最慢,但是因为压缩比最大,所以包最小,传输速度快</span>
    gzip_types text/plain application/x-javascript text/css application/xml<span class="token punctuation">;</span>
    <span class="token comment">#压缩类型,默认就已经包含text/html,所以下面就不用再写了,写上去也不会有问题,但是会有一个warn.</span>
    gzip_vary on<span class="token punctuation">;</span><span class="token comment">#选项可以让前端的缓存服务器缓存经过gzip压缩的页面.例如:用squid缓存经过nginx压缩的数据</span>
    
    <span class="token comment">#开启限制IP连接数的时候需要使用</span>
    <span class="token comment">#limit_zone crawler $binary_remote_addr 10m;</span>
    
    
    <span class="token comment"># 虚拟主机1的配置</span>
    server
    <span class="token punctuation">&#123;</span>
        <span class="token comment"># 监听端口</span>
        listen <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token comment"># 域名可以有多个,用空格隔开</span>
        server_name <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span>
        <span class="token comment"># HTTP 自动跳转 HTTPS</span>
        rewrite ^<span class="token punctuation">(</span>.*<span class="token punctuation">)</span> https://www.baidu.com<span class="token punctuation">;</span>
        deny <span class="token number">127.0</span>.0.1<span class="token punctuation">;</span>  <span class="token comment">#拒绝的ip</span>
        allow <span class="token number">172.18</span>.5.54<span class="token punctuation">;</span> <span class="token comment">#允许的ip </span>
    <span class="token punctuation">&#125;</span>
    upstream myserver <span class="token punctuation">&#123;</span>   
      server <span class="token number">127.0</span>.0.1:8080<span class="token punctuation">;</span>
      server <span class="token number">192.168</span>.24.189:8080 backup<span class="token punctuation">;</span>  <span class="token comment">#热备</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment"># 虚拟主机2的配置</span>
    server
    <span class="token punctuation">&#123;</span>
        <span class="token comment"># 监听端口 HTTPS</span>
        listen <span class="token number">443</span> ssl<span class="token punctuation">;</span>
        server_name https://www.baidu.com<span class="token punctuation">;</span>  <span class="token comment"># 提高服务的域名主机名</span>
        root /data/www/<span class="token punctuation">;</span>   <span class="token comment"># 站点根目录</span>
        <span class="token comment"># 配置域名证书</span>
        ssl_certificate      C:<span class="token punctuation">\</span>WebServer<span class="token punctuation">\</span>Certs<span class="token punctuation">\</span>certificate.crt<span class="token punctuation">;</span>
        ssl_certificate_key  C:<span class="token punctuation">\</span>WebServer<span class="token punctuation">\</span>Certs<span class="token punctuation">\</span>private.key<span class="token punctuation">;</span>
        ssl_session_cache    shared:SSL:1m<span class="token punctuation">;</span>
        ssl_session_timeout  5m<span class="token punctuation">;</span>
        ssl_protocols SSLv2 SSLv3 TLSv1<span class="token punctuation">;</span>
        ssl_ciphers ALL:<span class="token operator">!</span>ADH:<span class="token operator">!</span>EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP<span class="token punctuation">;</span>
        ssl_prefer_server_ciphers  on<span class="token punctuation">;</span>
    
        index index.html index.htm index.php<span class="token punctuation">;</span>  <span class="token comment"># 默认首页文件</span>
        
        location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>php<span class="token operator">|</span>php5<span class="token punctuation">)</span>?$
        <span class="token punctuation">&#123;</span>
            fastcgi_pass <span class="token number">127.0</span>.0.1:9000<span class="token punctuation">;</span>
            fastcgi_index index.php<span class="token punctuation">;</span>
            include fastcgi.conf<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment"># 配置地址拦截转发，解决跨域验证问题</span>
        location /oauth/<span class="token punctuation">&#123;</span>
            proxy_pass https://localhost:13580/oauth/<span class="token punctuation">;</span>
            proxy_set_header HOST <span class="token variable">$host</span><span class="token punctuation">;</span>
            proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
            proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment"># 图片缓存时间设置</span>
        location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>
            expires 10d<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment"># JS和CSS缓存时间设置</span>
        location ~ .*<span class="token punctuation">\</span>.<span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>?$ <span class="token punctuation">&#123;</span>
            expires 1h<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment"># 日志格式设定</span>
        log_format access <span class="token string">'<span class="token variable">$server_name</span> <span class="token variable">$remote_addr</span> -<span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] "<span class="token variable">$request</span>"'</span>
                  <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$uptream_status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>"'</span>
                  <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>" '</span>
                  <span class="token string">'<span class="token variable">$ssl_protocol</span> <span class="token variable">$ssl_cipher</span> <span class="token variable">$upstream_addr</span> <span class="token variable">$request_time</span> <span class="token variable">$upstream_response_time</span>'</span><span class="token punctuation">;</span>
       <span class="token comment"># 定义本虚拟主机的访问日志</span>
        access_log /var/log/nginx/access.log access<span class="token punctuation">;</span>
        
        <span class="token comment"># 设定查看Nginx状态的地址.StubStatus模块能够获取Nginx自上次启动以来的工作状态，此模块非核心模块，需要在Nginx编译安装时手工指定才能使用</span>
        location /NginxStatus <span class="token punctuation">&#123;</span>
            stub_status on<span class="token punctuation">;</span>
            access_log on<span class="token punctuation">;</span>
            auth_basic <span class="token string">"NginxStatus"</span><span class="token punctuation">;</span>
            auth_basic_user_file conf/htpasswd<span class="token punctuation">;</span>
            <span class="token comment">#htpasswd文件的内容可以用apache提供的htpasswd工具来产生.</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h2 id="五、解决前端跨域问题"><a href="#五、解决前端跨域问题" class="headerlink" title="五、解决前端跨域问题"></a>五、解决前端跨域问题</h2><ul>
<li>添加请求头Access-Control-Allow-Origin 、Access-Control-Allow-Methods、Access-Control-Allow-Headers</li>
<li>对那些可能对服务器数据产生副作用的HTTP 请求方法，浏览器必须首先使用 <strong>OPTIONS</strong> 方法发起一个预检请求（preflight request），从而获知服务端是否允许该跨域请求。服务器确认允许之后，才发起实际的 HTTP 请求</li>
</ul>
<pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 跨域请求的接口是: http://www.test.com/exchangeApi/xxxx</span>

server <span class="token punctuation">&#123;</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    server_name test.com www.test.com<span class="token punctuation">;</span>
    root /data/web/homepage<span class="token punctuation">;</span>
    index index.html<span class="token punctuation">;</span>
 
 
    location ~ /exchangeApi/ <span class="token punctuation">&#123;</span>
        add_header Access-Control-Allow-Origin *<span class="token punctuation">;</span>
        add_header Access-Control-Allow-Methods <span class="token string">'GET, POST, OPTIONS'</span><span class="token punctuation">;</span>
        add_header Access-Control-Allow-Headers <span class="token string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization'</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment"># 发送预检请求</span>
            <span class="token builtin class-name">return</span> <span class="token number">204</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
 
        <span class="token punctuation">..</span><span class="token punctuation">..</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h2 id="六、Nginx高可用"><a href="#六、Nginx高可用" class="headerlink" title="六、Nginx高可用"></a>六、Nginx高可用</h2><p><img src="https://img-blog.csdnimg.cn/20200712161046653.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1amluZzEzMTQ=,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" alt=""></p>
<p>通过安装keepalived和部署多台Nginx服务器来避免一台Nginx服务器挂了，整个Nginx服务崩溃。</p>
<pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">[</span>root@192 usr<span class="token punctuation">]</span><span class="token comment"># yum install keepalived -y</span>
<span class="token punctuation">[</span>root@192 usr<span class="token punctuation">]</span><span class="token comment"># rpm -q -a keepalived</span>
keepalived-1.3.5-16.el7.x86_64

<span class="token punctuation">[</span>root@192 keepalived<span class="token punctuation">]</span><span class="token comment"># cd /etc/keepalived</span>
<span class="token punctuation">[</span>root@192 keepalived<span class="token punctuation">]</span><span class="token comment"># vi keepalived.conf </span>

global_defs <span class="token punctuation">&#123;</span>
   notification_email <span class="token punctuation">&#123;</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   <span class="token punctuation">&#125;</span>
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server <span class="token number">192.168</span>.25.147
   smtp_connect_timeout <span class="token number">30</span>
   router_id LVS_DEVEL <span class="token comment"># 访问的主机地址</span>
<span class="token punctuation">&#125;</span>

vrrp_script chk_nginx <span class="token punctuation">&#123;</span>
  script <span class="token string">"/usr/local/src/nginx_check.sh"</span>  <span class="token comment"># 检测文件的地址</span>
  interval <span class="token number">2</span>   <span class="token comment"># 检测脚本执行的间隔</span>
  weight <span class="token number">2</span>   <span class="token comment"># 权重</span>
<span class="token punctuation">&#125;</span>

vrrp_instance VI_1 <span class="token punctuation">&#123;</span>
    state BACKUP    <span class="token comment"># 主机MASTER、备机BACKUP    </span>
    interface ens33   <span class="token comment"># 网卡</span>
    virtual_router_id <span class="token number">51</span> <span class="token comment"># 同一组需一致</span>
    priority <span class="token number">90</span>  <span class="token comment"># 访问优先级，主机值较大，备机较小</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">&#123;</span>
        auth_type PASS
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">&#125;</span>
    virtual_ipaddress <span class="token punctuation">&#123;</span>
        <span class="token number">192.168</span>.25.50  <span class="token comment"># 虚拟ip</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token punctuation">[</span>root@192 sbin<span class="token punctuation">]</span><span class="token comment"># systemctl start keepalived.service</span></code></pre>
<p>一个Master进程管理者多个work进程，</p>
<p><img src="https://img-blog.csdnimg.cn/20200718093615760.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1amluZzEzMTQ=,size_16,color_FFFFFF,t_70" srcset="/img/loading.gif" alt=""></p>
<h2 id="为什么单线程的Nginx性能这么高？"><a href="#为什么单线程的Nginx性能这么高？" class="headerlink" title="为什么单线程的Nginx性能这么高？"></a>为什么单线程的Nginx性能这么高？</h2><ul>
<li>主要是由于它采用<strong>AIO机制</strong>来响应请求</li>
<li>Nginx有一个master进程及多个work进程：master进程进行收集、分发请求，每次一个请求过来，master就会拉起一个worker进程负责处理这个请求；但是worker进程并不是一直在处理，当处理到可能发生阻塞的地方，比如向上游（后端）服务器转发请求并等待返回，它就去处理别的事情了，等后台服务器返回响应，这个worker收到通知再回来继续做剩下的事情。相当于充分利用了等待时间</li>
<li>基于AIO机制处理请求，不会为每个请求分配CPU和内存资源，同时也节省了线程上下文切换的时间</li>
</ul>
<h2 id="Nginx优化"><a href="#Nginx优化" class="headerlink" title="Nginx优化"></a>Nginx优化</h2><p>（1）调整worker_processes，尽量和CPU数量一致</p>
<p>（2）最大化worker_connections，即1024</p>
<p>（3）启用GZIP，压缩文件大小，提高响应速度</p>
<p>（4）为静态资源开启缓存</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">location ~* .<span class="token punctuation">(</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token operator">|</span>ico<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>
	expires 365d<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>（5）调整Timeout，避免频繁开启和关闭连接</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>【1】<a target="_blank" rel="noopener" href="http://www.macrozheng.com/#/reference/nginx">Nginx的这些妙用，你肯定有不知道的！ - Document (macrozheng.com)</a></p>
<p>【2】<a target="_blank" rel="noopener" href="https://blog.csdn.net/yujing1314/article/details/107000737">搞懂Nginx一篇文章就够了_阿杰-CSDN博客</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Nginx/">Nginx</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/129747bb/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MySQL进阶</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/e22d24c8/">
                        <span class="hidden-mobile">RabbitMQ使用手册</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "ViwB1XmjsmmXpFx2gikUmM5V-gzGzoHsz",
          app_key: "7r6Y8CzBkl8MJwPNmCqSdLWW",
          placeholder: "来都来了，不说点什么吗⊙(・◇・)？",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: false,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-tags-fill"></i>&nbsp;<a href="http://www.beian.miit.gov.cn/" target="_blank">鲁ICP备19062448号</a>&nbsp&nbsp;| &nbsp&nbsp <i class="iconfont icon-addrcard"></i>&nbsp; 2018~2022<a href="https://www.jngwl.top/" target="_blank"> 清风与归_G</a>&nbsp&nbsp;|&nbsp&nbsp;  <i class="iconfont icon-docker"></i> <a href="https://hexo.io/" target="_blank">&nbsp Hexo</a>&nbsp & &nbsp <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank">Fluid</a><br> 你的骄傲多半来自于自己的无知，共勉之

  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  
    
  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>



  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
